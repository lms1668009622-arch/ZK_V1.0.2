<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>| 战场情报快判AI系统 </title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .map-container { flex: 1; position: relative; }
        
        /* Map Picker Overlay (Deprecated / Removed Logic, kept for ref if needed but overlay is gone) */
        /* .map-marker and .map-range-circle styles are now used by Leaflet DivIcons */
        .map-marker {
            position: relative; /* Changed from absolute for Leaflet context */
            width: 20px;
            height: 20px;
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
            /* transform: translate(-50%, -50%); Handled by Leaflet iconAnchor */
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            pointer-events: none;
        }

        .map-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        /* Deprecated styles handled by Leaflet L.circle now */
        /* .map-range-circle { ... } */

        @keyframes pulseRange {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        .leaflet-tooltip.nfz-tooltip {
            background: rgba(15, 23, 42, 0.96);
            color: #e2e8f0;
            border: 1px solid #334155;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.45);
            padding: 8px 10px;
        }

        /* Layout Containers */
        .monitor-overlay-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            /* display: flex; */
            /* flex-direction: column; */
            /* gap: 16px; */
            /* align-items: flex-start; */
            z-index: 3200; /* Ensure overlay is above intel popup and detail */
            pointer-events: none; /* Let clicks pass through container area */
        }

        /* Re-enable pointer events for interactive children */
        .monitor-card, .detail-panel, .uav-card, .uav-detail-modal, .plan-detail-modal, #shipDetailModal, #overlay-ship, #shipDetailPage {
            pointer-events: auto;
        }

        .monitor-top-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-start;
            position: relative;
        }

        /* Monitor Card Styles (Existing Updated) */
        .monitor-card {
            width: 341px;
            height: 360px;
            background: rgba(21, 44, 81, 0.79);
            border-radius: 4px;
            border: 1px solid var(--LineLine-color-border-2, #E2E8F0);
            color: white;
            overflow: hidden;
            font-family: "Microsoft YaHei", sans-serif;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        /* ... (Keep existing monitor header/body styles) ... */

        /* Detail Panel Styles (New) */
        .detail-panel {
            width: 300px;
            height: 400px;
            background: rgba(21, 44, 81, 0.95);
            border-radius: 4px;
            border: 1px solid #E2E8F0;
            color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
            flex-direction: column;
            overflow: hidden;
            animation: slideInLeft 0.3s ease-out;
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .panel-header {
            padding: 10px 16px;
            background: #4a5b73;
            border-bottom: 1px solid #5c6f8a;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-close {
            cursor: pointer;
            color: #aebfd4;
        }
        .panel-close:hover { color: white; }

        .panel-body {
            padding: 16px;
            font-size: 13px;
            overflow-y: auto;
        }

        .detail-item {
            margin-bottom: 12px;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
            padding-bottom: 8px;
        }
        .detail-item:last-child { border: none; }

        .d-label { color: #aebfd4; margin-bottom: 4px; display: block; }
        .d-value { color: white; line-height: 1.4; }

        /* UAV Dispatch Card Styles (New) */
        .uav-card {
            width: 341px;
            background: rgba(21, 44, 81, 0.79);
            border-radius: 4px;
            border: 1px solid #E2E8F0;
            color: white;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        .uav-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            font-weight: bold;
            font-size: 14px;
            color: #ffffff;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }

        .uav-form-group {
            margin-bottom: 12px;
        }

        .uav-label {
            font-size: 12px;
            color: #aebfd4;
            margin-bottom: 6px;
            display: block;
        }

        .uav-select {
            width: 100%;
            background: rgba(0,0,0,0.2);
            border: 1px solid #5c6f8a;
            color: white;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            outline: none;
        }

        .uav-btn {
            width: 100%;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .recommend-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: bold;
            display: inline-block;
        }
        .rec-safety { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.4); }
        .rec-cost { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.4); }
        .rec-time { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.4); }

        /* UAV List Styles */
        .uav-list-container {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #5c6f8a;
            border-radius: 4px;
            background: rgba(0,0,0,0.2);
        }

        .uav-list-container::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .uav-list-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }
        .uav-list-container::-webkit-scrollbar-thumb {
            background: #5c6f8a;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .uav-list-container { scrollbar-color: #5c6f8a transparent; scrollbar-width: thin; }

        .uav-group-title {
            padding: 4px 8px;
            font-size: 11px;
            background: #4a5b73;
            color: #cbd5e1;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .uav-option {
            padding: 8px;
            font-size: 12px;
            color: white;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .uav-option-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .uav-icon {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aebfd4;
            transition: all 0.2s;
        }

        .uav-option:hover .uav-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* UAV Detail Modal */
        .uav-detail-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            z-index: 2000;
            display: none;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .plan-detail-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 640px;
            max-height: 80vh;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            z-index: 3100;
            display: none;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }
        #shipDetailModal { z-index: 9999; }
        #overlay-ship { z-index: 9998; }
        .plan-detail-header {
            padding: 12px 16px;
            background: #334155;
            border-bottom: 1px solid #475569;
            font-weight: bold;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .plan-detail-body {
            padding: 16px;
            font-size: 13px;
            color: #e2e8f0;
            overflow: visible;
        }
        .gantt-container {
            margin-top: 8px;
            border: 1px solid #475569;
            border-radius: 4px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
        }
        .gantt-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }
        .gantt-label {
            color: #94a3b8;
            font-size: 12px;
        }
        .gantt-bar {
            height: 16px;
            border-radius: 4px;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }
        .gantt-bar.orange { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .gantt-bar.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .gantt-legend {
            display: flex;
            gap: 10px;
            font-size: 11px;
            color: #94a3b8;
            margin-top: 6px;
        }
        .intent-list { display: flex; flex-direction: column; gap: 6px; margin-top: 6px; }
        .intent-item { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); border: 1px solid #475569; border-radius: 6px; padding: 6px 8px; }
        .intent-left { display: flex; align-items: center; gap: 8px; color: #cbd5e1; font-size: 12px; }
        .intent-badge { font-size: 12px; font-weight: bold; padding: 2px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); }
        .intent-badge.green { background: rgba(16,185,129,0.2); color: #10b981; border-color: rgba(16,185,129,0.4); }
        .intent-badge.yellow { background: rgba(245,158,11,0.2); color: #f59e0b; border-color: rgba(245,158,11,0.4); }
        .intent-badge.slate { background: rgba(148,163,184,0.2); color: #94a3b8; border-color: rgba(148,163,184,0.4); }
        .intent-progress { height: 6px; background: rgba(255,255,255,0.08); border: 1px solid #475569; border-radius: 4px; overflow: hidden; }
        .intent-progress-fill { height: 100%; }
        .intent-progress-fill.fill-70 { width: 70%; background: linear-gradient(90deg, #10b981, #34d399); }
        .intent-progress-fill.fill-60 { width: 60%; background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .intent-progress-fill.fill-50 { width: 50%; background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .gantt-steps { display: flex; gap: 2px; height: 16px; }
        .gantt-step { height: 16px; border-radius: 4px; }
        .gantt-step.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .gantt-step.orange { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .gantt-step.blue { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .sim-track { position: relative; height: 12px; background: rgba(255,255,255,0.08); border: 1px solid #475569; border-radius: 6px; display: flex; overflow: hidden; }
        .sim-segment { height: 100%; }
        .sim-segment.green { background: linear-gradient(90deg, #10b981, #34d399); }
        .sim-segment.orange { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .sim-segment.blue { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .sim-segment.active { filter: brightness(1.25); }
        .sim-dot { position: absolute; top: -4px; width: 8px; height: 8px; background: #ffffff; border-radius: 50%; box-shadow: 0 0 8px rgba(255,255,255,0.9); animation-name: simMove; animation-timing-function: linear; animation-fill-mode: forwards; }
        @keyframes simMove { from { left: 0%; } to { left: 100%; } }
        .gantt-axis { position: relative; height: 20px; margin-bottom: 8px; }
        .gantt-axis-tick { position: absolute; top: 0; transform: translateX(-50%); font-size: 10px; color: #94a3b8; border-left: 1px dashed #475569; height: 100%; padding-left: 2px; }
        .gantt-stage-wrap { position: relative; height: 16px; background: rgba(255,255,255,0.06); border: 1px solid #475569; border-radius: 4px; }
        .gantt-stage-bar { position: absolute; height: 100%; background: rgba(59,130,246,0.25); border: 1px solid #3b82f6; border-radius: 4px; display: flex; gap: 2px; padding: 0 2px; box-sizing: border-box; }
        .sim-map-wrap { position: relative; height: 220px; border: 1px solid #475569; border-radius: 6px; overflow: hidden; }
        .sim-map-wrap iframe { width: 100%; height: 100%; border: 0; }
        .sim-route-dot { position: absolute; top: 50%; width: 10px; height: 10px; background: #10b981; border-radius: 50%; box-shadow: 0 0 8px rgba(16,185,129,0.9); transform: translateY(-50%); left: 10%; animation-timing-function: linear; animation-fill-mode: forwards; }
        .sim-label { position: absolute; top: calc(50% + 10px); transform: translateX(-50%); font-size: 10px; color: #cbd5e1; background: rgba(0,0,0,0.4); padding: 2px 4px; border-radius: 3px; }
        @keyframes routeMove { from { left: 10%; } to { left: 80%; } }

        .uav-detail-header {
            padding: 12px 16px;
            background: #334155;
            border-bottom: 1px solid #475569;
            font-weight: bold;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .uav-detail-body {
            padding: 16px;
            color: #cbd5e1;
            font-size: 13px;
        }

        .uav-spec-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            border-bottom: 1px dashed #475569;
            padding-bottom: 4px;
        }
        .uav-spec-row:last-child { border-bottom: none; }
        
        .uav-spec-label { color: #94a3b8; }
        .uav-spec-val { color: white; font-weight: bold; }

        .overlay-backdrop {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }

        .uav-option.selected {
            background: rgba(59, 130, 246, 0.3);
            border-left: 3px solid #3b82f6;
        }

        .uav-option.in-mission {
            background: rgba(245, 158, 11, 0.18);
            border-left: 3px solid #f59e0b;
        }

        .uav-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(0,0,0,0.1);
        }

        /* Custom Scrollbar for UAV List */
        .uav-list-container::-webkit-scrollbar {
            width: 4px;
        }
        .uav-list-container::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
        }
        .uav-list-container::-webkit-scrollbar-thumb {
            background: #5c6f8a;
            border-radius: 2px;
        }

        .monitor-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #4a5b73; /* Lighter header */
            border-bottom: 1px solid #5c6f8a;
            flex-shrink: 0;
            height: 40px;
        }

        .monitor-header .icon-circle {
            width: 24px;
            height: 24px;
            background: #7c92ac;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            border: 1px solid #aebfd4;
        }
        
        .monitor-header .icon-circle i {
            font-size: 12px !important;
        }

        .monitor-header span {
            font-size: 14px;
            letter-spacing: 1px;
            font-weight: bold;
        }

        .ship-detail-page {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 760px;
            max-width: 90vw;
            height: 80vh;
            max-height: 90vh;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            z-index: 10000;
            display: none;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }
        .ship-detail-header {
            padding: 12px 16px;
            background: #334155;
            border-bottom: 1px solid #475569;
            font-weight: bold;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ship-detail-body {
            padding: 16px;
            font-size: 13px;
            color: #e2e8f0;
            overflow-y: auto;
        }

        .monitor-body {
            padding: 8px;
            background: transparent;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 3px;
            overflow: hidden;
        }

        .info-box {
            border: 1px solid #aebfd4;
            border-radius: 4px;
            padding: 8px;
            position: relative;
            background: transparent;
            flex-shrink: 0;
        }

        .detail-link {
            position: absolute;
            top: 8px;
            right: 8px;
            color: #3b82f6;
            text-decoration: none;
            font-size: 12px;
        }

        .info-row {
            margin-bottom: 4px;
            display: flex;
            font-size: 12px;
            align-items: center;
            line-height: 1.3;
        }

        .info-row:last-child {
            margin-bottom: 0;
        }

        .info-label {
            color: #aebfd4;
            width: 65px;
            flex-shrink: 0;
        }

        .info-value {
            color: #ffffff;
            white-space: normal;
            word-break: break-word;
        }

        .badge-green {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 2px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            white-space: nowrap;
            width: fit-content;
        }

        .feed-container {
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #5c6f8a;
            flex: 1;
            width: 100%;
            min-height: 220px;
        }

        .feed-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .instruction-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(16,185,129,0.15);
            border: 1px solid rgba(16,185,129,0.4);
            border-radius: 4px;
            padding: 6px 8px;
            color: #e2e8f0;
            font-size: 12px;
        }
        .instruction-item .title { color: #34d399; font-weight: bold; }
        .instruction-item .meta { color: #94a3b8; font-size: 11px; }

        /* Intel Popup Toast */
        .intel-popup {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(-50px);
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #3b82f6;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .intel-popup.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .popup-icon-box {
            width: 36px;
            height: 36px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3b82f6;
            flex-shrink: 0;
        }

        .popup-content h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
            color: #ffffff;
        }
        
        .popup-content p {
            margin: 0;
            font-size: 12px;
            color: #cbd5e1;
        }

        .popup-close {
            color: #64748b;
            cursor: pointer;
            padding: 4px;
        }
        .popup-close:hover { color: white; }
       
        .slide-in-right {
            animation: slideInRight 0.5s ease-out forwards;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-container { width: 1140px; max-width: 95vw; max-height: 70vh; background: #1e293b; border: 1px solid #475569; border-radius: 8px; color: #e2e8f0; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .modal-header { padding: 12px 16px; border-bottom: 1px solid #475569; }
        .modal-header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .modal-title { display: flex; align-items: center; gap: 8px; font-weight: bold; color: #ffffff; }
        .modal-close { background: transparent; border: none; color: #94a3b8; font-size: 20px; cursor: pointer; }
        .modal-close:hover { color: #fff; }
        .modal-tabs { display: flex; gap: 10px; }
        .tab-item { padding: 6px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; color: #cbd5e1; border: 1px solid transparent; }
        .tab-item.active { background: rgba(59,130,246,0.15); border-color: #3b82f6; color: #fff; }
        .modal-body { padding: 16px; display: block; overflow-y: auto; }
        .detail-section { background: rgba(255,255,255,0.05); border: 1px solid #475569; border-radius: 6px; padding: 12px; }
        .tab-content { display: none; }
        .tab-content.active { display: grid; grid-template-columns: minmax(420px, 500px) 1.6fr; gap: 14px; }
        .tab-content .info-row { display: grid; grid-template-columns: 100px 1fr; gap: 6px; align-items: start; margin-bottom: 8px; }
        .info-label { color: #94a3b8; font-size: 12px; }
        .info-value { color: #e2e8f0; font-size: 12px; }
        .badge-orange { background: rgba(245,158,11,0.2); color: #f59e0b; border: 1px solid rgba(245,158,11,0.4); padding: 2px 6px; border-radius: 4px; }
        .badge-red { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.4); padding: 2px 6px; border-radius: 4px; }
        .highlight { color: #3b82f6; font-weight: bold; }
        .tag-list { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge-new-text { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.4); border-radius: 4px; padding: 2px 6px; font-size: 12px; }
        .tag-cat { padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .green-tag { background: rgba(16,185,129,0.2); color: #10b981; border: 1px solid rgba(16,185,129,0.4); }
        .purple-tag { background: rgba(167,139,250,0.2); color: #a78bfa; border: 1px solid rgba(167,139,250,0.4); }
        .media-gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .media-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #475569; }
        .map-placeholder { position: relative; height: 460px; border-radius: 6px; overflow: hidden; }
        .map-controls-group { position: absolute; top: 10px; left: 10px; display: flex; gap: 8px; z-index: 10; }
        .map-btn-toggle { background: rgba(0,0,0,0.4); color: #fff; border: 1px solid #475569; border-radius: 4px; font-size: 12px; padding: 4px 8px; cursor: pointer; }
        .map-btn-toggle.active { background: rgba(59,130,246,0.7); border-color: #3b82f6; }
        #modal-info-summary { white-space: normal; word-break: break-word; }
        #intelGallery { -ms-overflow-style: none; scrollbar-width: none; }
        #intelGallery::-webkit-scrollbar { display: none; }
        .trace-network { position: relative; display: grid; grid-template-columns: minmax(320px, 380px) 1fr minmax(320px, 380px); gap: 12px; min-height: 420px; }
        .connector-svg { position: absolute; inset: 0; pointer-events: none; }
        .path-line { stroke: rgba(148,163,184,0.4); stroke-width: 2; fill: none; }
        .trace-col { background: rgba(255,255,255,0.05); border: 1px solid #475569; border-radius: 6px; padding: 12px; }
        .col-header-trace { font-weight: bold; color: #3b82f6; margin-bottom: 8px; }
        .trace-raw-list { display: flex; flex-direction: column; gap: 8px; }
        .trace-raw-item { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: #e2e8f0; background: rgba(0,0,0,0.2); border: 1px solid #475569; border-radius: 4px; padding: 6px 8px; }
        .raw-tag { font-size: 11px; color: #94a3b8; background: rgba(148,163,184,0.15); border: 1px solid rgba(148,163,184,0.3); border-radius: 4px; padding: 2px 6px; }
        .blue-icon { color: #60a5fa; }
        .green-icon { color: #10b981; }
        .orange-icon { color: #f59e0b; }
        .purple-icon { color: #a78bfa; }
        .trace-panel { display: flex; flex-direction: column; gap: 12px; }
        .evidence-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .trace-card { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); border: 1px solid #475569; border-radius: 6px; padding: 10px; }
        .trace-card.small-card { padding: 8px; }
        .t-icon { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(148,163,184,0.15); color: #e2e8f0; flex-shrink: 0; }
        .icon-sat { color: #60a5fa; background: rgba(59,130,246,0.2); }
        .icon-sig { color: #10b981; background: rgba(16,185,129,0.2); }
        .icon-web { color: #f59e0b; background: rgba(245,158,11,0.2); }
        .icon-hum { color: #a78bfa; background: rgba(167,139,250,0.2); }
        .icon-fusion { color: #3b82f6; background: rgba(59,130,246,0.25); }
        .t-content .t-title { font-weight: bold; color: #e2e8f0; font-size: 13px; }
        .t-content .t-desc { color: #94a3b8; font-size: 12px; }
        .fusion-card { position: relative; display: flex; flex-direction: column; gap: 10px; align-items: flex-start; background: rgba(30,41,59,0.8); border: 1px solid #3b82f6; padding: 14px; border-radius: 8px; }
        .fusion-dot-right { position: absolute; right: -6px; top: 50%; width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; transform: translateY(-50%); box-shadow: 0 0 10px rgba(59,130,246,0.6); }
        .fusion-stats { display: flex; gap: 12px; color: #cbd5e1; font-size: 12px; }
        .stat-item .stat-val { color: #3b82f6; font-weight: bold; margin-right: 4px; }
        .result-card-full { display: flex; flex-direction: column; gap: 10px; background: rgba(255,255,255,0.05); border: 1px solid #475569; border-radius: 8px; padding: 12px; }
        .result-header { display: flex; justify-content: space-between; align-items: center; }
        .result-tag { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid rgba(239,68,68,0.4); padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .result-body { display: flex; flex-direction: column; gap: 8px; color: #e2e8f0; }
        .result-title { margin: 0; font-size: 16px; color: #ffffff; }
        .result-meta { display: flex; gap: 12px; font-size: 12px; color: #94a3b8; }
        .result-desc { font-size: 12px; color: #cbd5e1; line-height: 1.6; }
        .result-actions { display: flex; justify-content: flex-start; }
        .btn-report { background: #3b82f6; color: white; border: 1px solid #60a5fa; border-radius: 4px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
        .btn-report:hover { background: #2563eb; }
        .reasoning-layout { display: grid; grid-template-columns: 360px 1fr 360px; gap: 16px; min-height: 420px; }
        .reason-step { background: rgba(255,255,255,0.05); border: 1px solid #475569; border-radius: 6px; padding: 12px; }
        .step-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .step-badge { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.4); padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .step-badge-sm { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.4); padding: 1px 6px; border-radius: 4px; font-size: 11px; margin-right: 6px; }
        .step-card { display: flex; gap: 10px; align-items: center; background: rgba(0,0,0,0.2); border: 1px solid #475569; border-radius: 6px; padding: 10px; margin-bottom: 8px; }
        .ai-card { background: rgba(59,130,246,0.15); border-color: #3b82f6; }
        .card-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(59,130,246,0.2); color: #60a5fa; }
        .card-content h4 { margin: 0; font-size: 14px; color: #e2e8f0; }
        .card-content p { margin: 0; font-size: 12px; color: #94a3b8; }
        .card-content .sub-text { margin-top: 6px; font-size: 12px; color: #60a5fa; }
        .progress-bar { display: none; }
        .progress-bar .fill { display: none; }
        .step-details-inline { display: flex; flex-direction: column; gap: 8px; }
        .detail-item { display: flex; gap: 8px; align-items: flex-start; }
        .d-dot { width: 8px; height: 8px; border-radius: 50%; background: #3b82f6; margin-top: 6px; }
        .d-content strong { color: #e2e8f0; font-size: 12px; }
        .d-content p { color: #94a3b8; font-size: 12px; margin: 2px 0 0; }
        .step-connector { display: none; }
        .result-card { background: rgba(239,68,68,0.12); border-color: #ef4444; }
        .prediction-list { list-style: none; padding: 0; margin: 6px 0 0; display: flex; flex-direction: column; gap: 6px; color: #e2e8f0; font-size: 12px; }
        .text-red { color: #ef4444; }
        .text-orange { color: #f59e0b; }
        .text-blue { color: #3b82f6; }
        .sub-header { position: relative; display: flex; align-items: center; padding: 6px 12px; }
        .page-title { position: absolute; left: 50%; transform: translateX(-50%); font-weight: bold; color: #ffffff; }
        @media (max-width: 1200px) {
            .modal-container { width: 90vw; }
            .tab-content.active { grid-template-columns: minmax(300px, 380px) 1fr; }
            .map-placeholder { height: 360px; }
            .trace-network { grid-template-columns: 1fr; }
        }
        @media (max-width: 860px) {
            .modal-body { padding: 12px; display: block; }
            .tab-content.active { display: block; }
            .media-gallery { grid-template-columns: 1fr; }
            .map-placeholder { height: 280px; }
            .trace-network { grid-template-columns: 1fr; min-height: 420px; }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <header class="main-header">
        <div class="brand">
            <div class="logo-icon"><img src="images/logo.png" alt="Logo" style="height: 20px;"></div> 
            <span class="brand-text"> | 战场情报快判AI系统</span>
        </div>
        <div class="user-profile">
            <div class="avatar">Z</div>
        </div>
    </header>

    <div class="sub-header">
        <div class="system-icons">

            <a href="javascript:void(0)" onclick="toggleIntelPush()" style="color: inherit; text-decoration: none; cursor: pointer;">
            <svg t="1768383451211" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8798" width="22" height="22" style="vertical-align: middle; fill: white;"><path d="M825.6 820.48a520.96 520.96 0 0 0-85.333333-54.186667 730.88 730.88 0 0 0 42.666666-232.106666h170.666667a438.186667 438.186667 0 0 1-128 286.293333z m-196.266667 115.626667a349.44 349.44 0 0 0 80.64-104.106667 444.586667 444.586667 0 0 1 59.306667 35.84 438.613333 438.613333 0 0 1-139.52 68.266667zM554.666667 902.4v-115.626667a441.173333 441.173333 0 0 1 93.013333 18.773334A206.933333 206.933333 0 0 1 554.666667 902.4z m0-368.213333h156.586666a696.746667 696.746667 0 0 1-34.986666 205.226666 512 512 0 0 0-121.6-24.746666z m0-224.426667a506.026667 506.026667 0 0 0 121.6-24.746667 674.986667 674.986667 0 0 1 33.706666 177.493334H554.666667z m0-187.733333a206.933333 206.933333 0 0 1 93.013333 96.426666 439.893333 439.893333 0 0 1-93.013333 18.773334z m217.6 34.56a438.186667 438.186667 0 0 1-59.306667 35.84 350.72 350.72 0 0 0-80.64-104.106667 436.48 436.48 0 0 1 138.24 67.84z m178.773333 305.92h-170.666667a721.066667 721.066667 0 0 0-42.666666-203.946667 512 512 0 0 0 85.333333-54.186667 438.186667 438.186667 0 0 1 126.293333 257.706667z m-469.333333-224a437.76 437.76 0 0 1-102.826667-19.626667 194.986667 194.986667 0 0 1 102.826667-100.266667z m0 224h-166.4a682.666667 682.666667 0 0 1 33.706666-177.493334 512 512 0 0 0 131.84 25.6v151.893334z m0 251.733333a508.16 508.16 0 0 0-131.84 25.6 696.746667 696.746667 0 0 1-34.986667-205.226667h166.826667z m0 192a195.84 195.84 0 0 1-102.826667-100.266667 437.76 437.76 0 0 1 102.826667-19.626666z m-227.413334-37.973333H256a438.186667 438.186667 0 0 1 59.306667-35.84 350.72 350.72 0 0 0 80.64 104.106666 436.48 436.48 0 0 1-142.506667-68.693333zM72.533333 534.186667h170.666667a733.44 733.44 0 0 0 42.666667 232.106666 512 512 0 0 0-85.333334 54.186667 438.186667 438.186667 0 0 1-128-286.293333z m125.866667-330.666667A520.96 520.96 0 0 0 284.586667 256a721.066667 721.066667 0 0 0-42.666667 203.946667h-170.666667a438.186667 438.186667 0 0 1 127.146667-256.426667z m196.266667-115.626667A349.44 349.44 0 0 0 314.026667 192 444.586667 444.586667 0 0 1 256 156.16a438.613333 438.613333 0 0 1 138.24-68.266667zM512 0a512 512 0 1 0 512 512A512 512 0 0 0 512 0z" fill="white" p-id="8799"></path></svg>
            </a>
            <a href="javascript:void(0)" onclick="toggleUavDispatch()" style="display:none;">
            <svg t="1768383611280" class="icon" viewBox="0 0 2048 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11272" width="35" height="25" style="vertical-align: middle; fill: white;"><path d="M1463.217231 276.637538c-4.883692 4.844308-12.209231 4.844308-17.132308 4.844308-9.806769 0-17.132308-4.844308-24.457846-12.130461l-36.706462-48.521847c-9.806769-12.130462-7.325538-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.629538 7.286153l36.706462 48.561231c9.728 14.572308 7.325538 31.507692-7.364923 41.235692z m-97.870769 0c-4.883692 4.844308-12.209231 4.844308-17.132308 4.844308-9.806769 0-17.132308-4.844308-24.457846-12.130461l-36.706462-48.521847c-9.846154-12.130462-7.325538-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.590154 7.286153l36.706461 48.561231c9.767385 14.572308 7.325538 31.507692-7.364923 41.235692z m-105.235693 0c-4.883692 4.844308-12.209231 4.844308-17.092923 4.844308-9.806769 0-17.132308-4.844308-24.497231-12.130461l-36.667077-48.521847c-9.806769-12.130462-7.364923-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.590154 7.286153l36.706461 48.561231c9.767385 14.572308 7.325538 31.507692-7.364923 41.235692z m-237.331692 524.169847a54.075077 54.075077 0 0 1-53.838769-53.405539c0-29.144615 24.497231-53.366154 53.838769-53.366154s53.799385 24.260923 53.799385 53.366154c2.481231 29.144615-21.976615 53.405538-53.799385 53.405539zM805.021538 281.481846c-4.883692 0-12.209231-2.402462-17.132307-4.844308-12.209231-9.688615-14.651077-26.702769-7.286154-41.235692l36.706461-48.561231c9.767385-12.130462 26.899692-14.572308 41.590154-7.286153 12.209231 9.728 14.651077 26.702769 7.325539 41.275076l-36.706462 48.521847a29.932308 29.932308 0 0 1-24.457846 12.130461z m-46.473846-60.652308l-36.667077 48.521847c-4.923077 7.286154-14.690462 12.130462-24.49723 12.130461a45.686154 45.686154 0 0 1-17.132308-4.844308c-12.209231-9.688615-14.690462-26.702769-7.325539-41.235692l36.706462-48.561231c9.767385-12.130462 26.899692-14.572308 41.550769-7.286153 14.729846 9.728 17.171692 29.144615 7.364923 41.275076z m308.342154 303.340308h17.092923v101.888h-122.328615V524.209231h105.235692zM660.637538 220.829538l-36.706461 48.521847c-4.883692 7.286154-14.651077 12.130462-24.418462 12.130461a45.686154 45.686154 0 0 1-17.171692-4.844308c-12.209231-9.688615-14.690462-26.702769-7.325538-41.235692l36.706461-48.561231c9.767385-12.130462 26.899692-14.572308 41.550769-7.286153 14.729846 9.728 17.171692 29.144615 7.364923 41.275076zM2006.409846 7.286154h-225.083077c-22.055385 0-41.590154 19.416615-41.590154 41.235692 0 21.858462 19.574154 41.275077 41.590154 41.275077h83.140923v80.068923h-141.863384L1235.652923 9.688615C1218.520615 4.844308 1198.946462 0 1179.332923 0h-308.263385c-19.574154 0-39.148308 2.441846-56.280615 9.688615L327.876923 169.865846H183.532308V89.796923h83.180307c22.016 0 41.590154-19.416615 41.590154-41.275077 0-21.819077-19.574154-41.235692-41.590154-41.235692H41.590154C19.574154 7.286154 0 26.702769 0 48.521846 0 70.380308 19.574154 89.796923 41.590154 89.796923h83.180308v80.068923h-22.055385c-31.744 0-58.683077 26.702769-58.683077 58.249846V271.753846c0 38.833231 31.822769 70.380308 70.931692 70.380308h342.567385V948.775385c0 21.858462 17.171692 38.833231 39.187692 38.83323h24.457846c7.364923 0 12.209231-4.844308 12.209231-12.130461L575.015385 342.173538h48.915692c26.939077 0 51.396923 16.935385 61.203692 41.235693 9.767385 24.260923 34.264615 41.235692 61.164308 41.235692h80.738461v38.833231c0 31.547077 26.899692 58.249846 58.683077 58.249846h17.171693v101.927385h-24.457846a27.057231 27.057231 0 0 0-26.939077 26.702769v177.112615c0 14.572308 12.248615 26.702769 26.939077 26.702769l291.170461 21.858462c14.690462 0 24.457846-17.014154 24.457846-31.547077v-191.724308c0-14.572308-12.209231-26.702769-26.939077-26.702769h-24.457846V524.209231H1174.449231c2.481231 0 2.481231 0 4.923077-2.441846 2.481231 0 4.923077 0 7.325538-2.441847 2.481231 0 2.481231-2.402462 4.883692-2.402461 2.481231 0 2.481231-2.441846 4.923077-2.441846 2.441846-2.402462 4.923077-2.402462 4.923077-4.844308l2.402462-2.441846c2.481231-2.402462 2.481231-4.844308 4.923077-4.844308l2.402461-2.441846c2.481231-2.402462 2.481231-4.844308 4.923077-7.246769 0 0 0-2.441846 2.441846-2.441846 0-2.441846 2.481231-4.844308 2.481231-7.286154v-50.963692h80.738462c26.899692 0 51.357538-16.974769 61.124923-41.235693 9.846154-24.260923 34.264615-41.275077 61.203692-41.275077H1472.984615l39.187693 633.383385c0 7.246769 7.325538 12.130462 12.20923 12.130461h24.497231a38.518154 38.518154 0 0 0 39.148308-38.83323V349.420308h342.528c39.148308 0 70.971077-31.507692 70.971077-70.340923v-43.716923c0-12.130462-2.481231-21.819077-9.767385-31.507693-7.364923-9.728-14.690462-17.014154-24.497231-21.858461-7.325538-2.441846-14.651077-4.844308-22.055384-4.844308h-21.976616V97.083077h83.180308c22.055385 0 41.590154-19.416615 41.590154-41.275077 0-29.144615-19.534769-48.521846-41.590154-48.521846z" fill="#C2C1C1" p-id="11273"></path></svg>
            </a>
            <svg t="1768576382981" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2718" width="22" height="22" style="vertical-align: middle; fill: white;"><path d="M145.172671 855.192646h775.95031v45.253168h-775.95031v-45.253168z m521.540372-140.192596h254.409938v45.253167h-254.409938v-45.253167z m-44.521739-166.702112h298.931677v45.253168h-298.931677v-45.253168z m67.119702-166.702112h235.329193v45.253168h-235.329193v-45.246808z" p-id="2719"></path><path d="M795.927851 133.495255c-15.321839 28.557516-34.663354 62.864696-49.698981 84.158807a331.814161 331.814161 0 0 1-27.1201 37.544547l-59.91354 71.93441a577.307031 577.307031 0 0 0-61.567205 89.832149l-13.102112 23.520198a219.275925 219.275925 0 0 1-36.749515 48.770386l17.045465 187.15667c0.795031 8.70082 8.058435 14.170634 15.60805 14.170634a15.264596 15.264596 0 0 0 10.939627-4.60482c5.89595-5.89595 11.575652-10.570733 16.89918-13.954385 1.081242-0.648745 2.658584-1.004919 4.528497-1.004919 7.632298 0 19.494161 5.679702 14.386882 18.482882-3.377292 5.323528-8.052075 11.00323-13.954385 16.90554l-109.256348 109.116422-21.942857-20.49908a30.866286 30.866286 0 0 0 0-43.593143l-109.905093-109.835131a14.501366 14.501366 0 0 0-10.214559-4.242285 14.374161 14.374161 0 0 0-10.214559 4.242285l-25.530037 25.536398a58.005466 58.005466 0 0 0-16.835578 45.386733l-12.873143 69.409391a51.740621 51.740621 0 0 1-15.035627 40.641988l-0.426137 0.432497a52.650137 52.650137 0 0 1-37.264695 15.461764l-34.80964-32.437268a15.36636 15.36636 0 0 1 0-21.796571 15.36636 15.36636 0 0 1 0-21.790211l31.502311-31.508671a2.06072 2.06072 0 0 0-0.356174-3.161043 1.653665 1.653665 0 0 0-1.01128-0.292572 2.213366 2.213366 0 0 0-0.934956 0.216249l-0.50246 0.216248c-8.268323 3.816149-16.473043 7.842186-24.385193 12.230758a35.172174 35.172174 0 0 1-41.856795-6.118559c-10.863304-11.00323-12.80318-27.762484-5.825987-41.138087 4.026037-7.842186 8.122037-15.60805 11.7919-23.596522l0.572423-1.221168a2.003478 2.003478 0 0 0-0.426137-2.874832 2.175205 2.175205 0 0 0-2.734907 0.286211l-31.292422 31.356025a15.37272 15.37272 0 0 1-21.790211 0 15.37272 15.37272 0 0 1-10.863305 4.534857 15.131031 15.131031 0 0 1-10.856944-4.528497l-32.51359-34.669714c0-13.954385 5.533416-27.336348 15.391802-37.188373a53.349764 53.349764 0 0 1 37.760795-15.608049c1.367453 0 2.734907 0.069963 4.10236 0.139925 1.367453 0.146286 2.734907 0.146286 4.10236 0.146286 21.790211 0 37.970683-13.30564 60.42236-13.30564 1.361093 0 2.728547 0.069963 4.165963 0.146286 1.513739 0.139925 2.951155 0.139925 4.458534 0.139925 15.251876 0 29.924969-5.825988 40.788273-16.689292l25.822609-25.822608a14.456845 14.456845 0 0 0 0-20.499081L154.395031 423.656149a30.592795 30.592795 0 0 0-21.796571-8.993391 30.891727 30.891727 0 0 0-21.796572 8.993391l-21.217789-21.942857 109.186385-109.186385c5.902311-5.89595 11.51205-10.570733 16.905541-13.954385 2.226087-0.858634 4.242286-1.29113 6.042236-1.291131 11.51205 0 14.959304 15.538087 12.154435 20.21287-3.377292 5.323528-8.052075 11.00323-13.954385 16.89918l-0.069963 0.076323c-9.349565 9.349565-3.523578 25.313789 9.565813 26.541317l187.086709 17.261714 0.069962-0.069963a217.425093 217.425093 0 0 1 48.554137-36.61595l24.022658-13.375602a583.304745 583.304745 0 0 0 88.979876-60.994783l72.646758-60.492323a334.638112 334.638112 0 0 1 37.328298-26.973814c21.147826-15.175553 55.385043-34.523429 83.942559-49.92159 2.798509-1.507379 5.679702-2.162484 8.414609-2.162484 12.30072-0.139925 22.152745 13.312 15.461764 25.828969z" p-id="2720"></path></svg>
            
            <svg t="1769083336290" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4640" width="22" height="22" style="vertical-align: middle; fill: white;"><path d="M564.965517 853.843862V783.448276H0v70.680276C0 918.137379 51.725241 971.034483 115.74069 971.034483h506.164965c-4.855172-4.413793-9.533793-8.28469-13.956414-12.716138A147.279448 147.279448 0 0 1 564.965517 853.843862z m0 0M400.017655 427.085241l81.981793 56.28469 82.301793-56.28469c22.510345-15.353379 40.388414-49.999448 40.388414-77.241379V233.533793l-122.482758-60.577103L359.724138 233.37931v116.464552c0 27.233103 17.776552 61.888 40.293517 77.241379z m18.456276-109.929931a15.443862 15.443862 0 0 1 21.846069 0.110345l24.620138 24.862897 59.257379-59.248552a15.446069 15.446069 0 0 1 21.854897 0.008828 15.45269 15.45269 0 0 1-0.008828 21.852689l-70.232276 70.267586a15.52331 15.52331 0 0 1-10.924138 4.577104h-0.033103a15.417379 15.417379 0 0 1-10.939586-4.638897l-35.553104-35.912827a15.492414 15.492414 0 0 1 0.112552-21.879173z m0 0M942.113103 52.965517h-0.492137C896.231724 52.965517 858.482759 90.888828 858.482759 136.302345V278.068966h165.517241V136.026483C1024.207448 90.526897 987.61269 53.40469 942.113103 52.965517z m0 0" p-id="4641"></path><path d="M237.172966 52.965517C194.248828 52.965517 159.315862 87.430621 159.315862 129.705931L154.758621 752.551724H580.413793a16.086069 16.086069 0 0 1 15.448276 16.172138v85.12c-0.154483 64.353103 51.725241 116.724966 116.069517 117.190621h0.388414c64.110345-0.463448 115.707586-52.811034 115.266207-116.92138V136.326621C827.586207 103.856552 842.198069 75.034483 864.154483 52.965517zM328.827586 223.741793a15.015724 15.015724 0 0 1 8.165517-13.870345l138.343725-67.992276a15.192276 15.192276 0 0 1 13.484138 0l138.593103 68.182069A15.028966 15.028966 0 0 1 635.586207 223.931586v125.912276c0 37.473103-22.870069 81.655172-53.843862 102.768552l-90.758621 62.234483a15.26069 15.26069 0 0 1-8.646621 2.688 15.04 15.04 0 0 1-8.604689-2.690207l-91.025655-62.234483C351.750621 431.492414 328.827586 387.310345 328.827586 349.846069zM701.793103 681.931034H278.068966c-8.534069 0-15.448276-6.914207-15.448276-15.448275s6.914207-15.448276 15.448276-15.448276h423.724137c8.534069 0 15.448276 6.914207 15.448276 15.448276s-6.914207 15.448276-15.448276 15.448275z m0-81.655172H278.068966c-8.534069 0-15.448276-6.914207-15.448276-15.448276s6.914207-15.448276 15.448276-15.448276h423.724137c8.534069 0 15.448276 6.914207 15.448276 15.448276s-6.914207 15.448276-15.448276 15.448276z m0 0" p-id="4642"></path></svg>
        </div>
        <div class="page-title">指控席</div>
    </div>

    <div class="map-container">
        <!-- Leaflet Map Container -->
            <div id="map" style="width: 100%; height: 100%; background: #0f172a; z-index: 1;"></div>
            <div id="bottom-nav" style="position:absolute; left:0; right:0; bottom:0; height:46px; z-index:1002; display:flex; align-items:center; justify-content:space-between; padding:0 16px; background: rgba(15,23,42,0.95); border-top: 1px solid #475569;">
                <div id="map-style-controls" style="display:flex; gap:6px;">
                    <button id="btn-style-road" onclick="setMapStyle('road')" style="background:#334155; color:white; border:1px solid #475569; border-radius:4px; padding:6px 10px; font-size:12px; cursor:pointer;">道路</button>
                    <button id="btn-style-sat" onclick="setMapStyle('sat')" style="background:#334155; color:white; border:1px solid #475569; border-radius:4px; padding:6px 10px; font-size:12px; cursor:pointer;">卫星</button>
                </div>
                <div style="display:flex; align-items:center; gap:10px; color:#cbd5e1; font-size:12px;"><span id="map-status"></span></div>
            </div>
        
        <!-- Overlay Monitoring Panel -->
        <div class="monitor-overlay-panel">
            <!-- Top Row: Monitor + Details -->
            <div class="monitor-top-row">
                <!-- Intel Push Card (Hidden by default) -->


            <script>
                const intelData = [
                    {
                        title: "台湾西部彰化县进入警备状态",
                        time: "2分钟前",
                        threat: "高等威胁",
                        image: "images/6.png",
                        desc: "台湾东部战区开展跨昼夜联合演训，结合 IGSO卫星拍摄影像，无侦-7 无人机拍摄视频影像及雷达探测信号，台湾西部彰化县进入警备状态。"
                    },
                    {
                        title: "日本西南岛屿军事演练，介入台海威胁加剧",
                        time: "10分钟前",
                        threat: "中等威胁",
                        image: "images/1.png",
                        desc: "日本首相高市早苗近期发表的涉台言论，日本政府在台海问题上频频发声，试图与自身安全挂钩。日本海上自卫队还与美军频繁开展联合军演，军事力量不容忽视。"
                    }
                ];
                let currentIntelIndex = 0;

                function updateIntelDisplay() {
                    const data = intelData[currentIntelIndex];
                    document.getElementById('intelTitle').textContent = data.title;
                    document.getElementById('intelTime').textContent = data.time;
                    const imgEl = document.getElementById('intelImage');
                    const solBtn = document.getElementById('showSolutionBtn');
                    const instrList = document.getElementById('superiorInstructionList');
                    const gallery = document.getElementById('intelGallery');
                    const prevBtn = document.getElementById('galleryPrevBtn');
                    const nextBtn = document.getElementById('galleryNextBtn');
                    window._galleryIndex = 0;
                    if (Array.isArray(data.images) && data.images.length > 0 && gallery) {
                        gallery.style.display = 'flex';
                        imgEl.style.display = 'none';
                        gallery.innerHTML = data.images.map(src => '<div style="min-width:100%; height:100%; scroll-snap-align:start;"><img src="images/'+src+'" style="width:100%; height:100%; object-fit:cover;"/></div>').join('');
                        if (prevBtn) prevBtn.style.display = data.images.length > 1 ? 'inline-block' : 'none';
                        if (nextBtn) nextBtn.style.display = data.images.length > 1 ? 'inline-block' : 'none';
                        if (gallery) gallery.scrollTo({ left: 0, behavior: 'auto' });
                    } else {
                        if (imgEl) {
                            imgEl.src = data.image;
                            imgEl.style.display = 'block';
                            imgEl.style.width = '100%';
                            imgEl.style.height = '100%';
                            imgEl.style.objectFit = 'cover';
                        }
                        if (gallery) { gallery.style.display = 'none'; gallery.innerHTML = ''; }
                        if (prevBtn) prevBtn.style.display = 'none';
                        if (nextBtn) nextBtn.style.display = 'none';
                    }
                    document.getElementById('intelDesc').textContent = data.desc;
                    const badge = document.getElementById('intelThreatBadge');
                    if (badge) {
                        badge.textContent = data.threat || '';
                        let bg = '#f59e0b';
                        if ((data.threat || '').includes('高')) bg = '#ef4444';
                        if ((data.threat || '').includes('低')) bg = '#10b981';
                        badge.style.backgroundColor = bg;
                    }
                    if (solBtn) {
                        const allowed = '东部战区美国两艘舰艇过航台湾海峡';
                        const enabled = data.title === allowed;
                        solBtn.style.opacity = enabled ? '1' : '0.6';
                        solBtn.style.cursor = enabled ? 'pointer' : 'not-allowed';
                        if (instrList) {
                            instrList.innerHTML = '<div style="color:#94a3b8; font-size:12px;">无上级指令</div>';
                            if (window._instructionTimer) { clearTimeout(window._instructionTimer); window._instructionTimer = null; }
                            if (enabled) {
                                window._instructionTimer = setTimeout(() => {
                                    const item = document.createElement('div');
                                    item.style.display = 'flex';
                                    item.style.alignItems = 'center';
                                    item.style.justifyContent = 'space-between';
                                    item.style.background = 'rgba(16,185,129,0.15)';
                                    item.style.border = '1px solid rgba(16,185,129,0.4)';
                                    item.style.borderRadius = '4px';
                                    item.style.padding = '6px 8px';
                                    item.style.color = '#e2e8f0';
                                    item.style.fontSize = '12px';
                                    const title = document.createElement('span');
                                    title.textContent = '《情况报告-初步决心》';
                                    title.style.color = '#34d399';
                                    title.style.fontWeight = 'bold';
                                    const meta = document.createElement('span');
                                    meta.textContent = '来自：上级指挥';
                                    meta.style.color = '#94a3b8';
                                    meta.style.fontSize = '11px';
                                    item.appendChild(title);
                                    item.appendChild(meta);
                                    item.style.cursor = 'pointer';
                                    item.onclick = () => {
                                        const file = {
                                            title: '《情况报告-初步决心》',
                                            docTitle: '情况报告',
                                            center: '作战指挥中心',
                                            date: new Date().toLocaleString('zh-CN'),
                                            headline: '东部战区美国两艘舰艇过航台海情况通报',
                                            paragraph: '根据东部战区侦察与多源融合结果，判定美方两艘舰艇过航台湾海峡，当前态势总体可控。我方保持常态化警戒与伴随监视，建议以“稳控局势、精准预警、适度施压”为基本原则，执行阶段性处置与舆情引导方案。',
                                            image1: 'images/船.png',
                                            image2: 'images/船2.png',
                                            caption: '图：前线情报回传影像',
                                            extraFooterLeft: '主办：指挥席',
                                            extraFooterRight: '抄送：情报席、指控席、态势席',
                                            extraTitle: '指挥员决心（引用《东部战区美国两艘舰艇过航台海情况通报》）：',
                                            extraList: [
                                                '指控席按照情况等级，调用处置预案，拟制专项方案；',
                                                '情报席、态势席跟踪情况进展，实时更新态势图；',
                                                '通知值班部队做好出动应对准备。'
                                            ]
                                        };
                                        openInstructionFileModal(file);
                                    };
                                    instrList.innerHTML = '';
                                    instrList.appendChild(item);
                                }, 3000);
                            }
                        }
                    }
                    const detailLink = document.getElementById('intelDetailLink');
                    if (detailLink) detailLink.style.display = 'inline';
                }

                function galleryPrev() {
                    const gallery = document.getElementById('intelGallery');
                    const data = intelData[currentIntelIndex];
                    if (!gallery || !Array.isArray(data.images)) return;
                    window._galleryIndex = Math.max(0, (window._galleryIndex || 0) - 1);
                    const w = gallery.clientWidth;
                    gallery.scrollTo({ left: w * window._galleryIndex, behavior: 'smooth' });
                }

                function galleryNext() {
                    const gallery = document.getElementById('intelGallery');
                    const data = intelData[currentIntelIndex];
                    if (!gallery || !Array.isArray(data.images)) return;
                    window._galleryIndex = Math.min(data.images.length - 1, (window._galleryIndex || 0) + 1);
                    const w = gallery.clientWidth;
                    gallery.scrollTo({ left: w * window._galleryIndex, behavior: 'smooth' });
                }

                function nextIntel() {
                    currentIntelIndex = (currentIntelIndex + 1) % intelData.length;
                    updateIntelDisplay();
                }

                function prevIntel() {
                    currentIntelIndex = (currentIntelIndex - 1 + intelData.length) % intelData.length;
                    updateIntelDisplay();
                }
            </script>
            <div class="monitor-card" id="intelCard" style="background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); width: 400px; height: 580px;">
                <div class="monitor-header">
                    <div class="icon-circle">
                         <svg t="1768383451211" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8798" width="12" height="12" style="vertical-align: middle; fill: white;"><path d="M825.6 820.48a520.96 520.96 0 0 0-85.333333-54.186667 730.88 730.88 0 0 0 42.666666-232.106666h170.666667a438.186667 438.186667 0 0 1-128 286.293333z m-196.266667 115.626667a349.44 349.44 0 0 0 80.64-104.106667 444.586667 444.586667 0 0 1 59.306667 35.84 438.613333 438.613333 0 0 1-139.52 68.266667zM554.666667 902.4v-115.626667a441.173333 441.173333 0 0 1 93.013333 18.773334A206.933333 206.933333 0 0 1 554.666667 902.4z m0-368.213333h156.586666a696.746667 696.746667 0 0 1-34.986666 205.226666 512 512 0 0 0-121.6-24.746666z m0-224.426667a506.026667 506.026667 0 0 0 121.6-24.746667 674.986667 674.986667 0 0 1 33.706666 177.493334H554.666667z m0-187.733333a206.933333 206.933333 0 0 1 93.013333 96.426666 439.893333 439.893333 0 0 1-93.013333 18.773334z m217.6 34.56a438.186667 438.186667 0 0 1-59.306667 35.84 350.72 350.72 0 0 0-80.64-104.106667 436.48 436.48 0 0 1 138.24 67.84z m178.773333 305.92h-170.666667a721.066667 721.066667 0 0 0-42.666666-203.946667 512 512 0 0 0 85.333333-54.186667 438.186667 438.186667 0 0 1 126.293333 257.706667z m-469.333333-224a437.76 437.76 0 0 1-102.826667-19.626667 194.986667 194.986667 0 0 1 102.826667-100.266667z m0 224h-166.4a682.666667 682.666667 0 0 1 33.706666-177.493334 512 512 0 0 0 131.84 25.6v151.893334z m0 251.733333a508.16 508.16 0 0 0-131.84 25.6 696.746667 696.746667 0 0 1-34.986667-205.226667h166.826667z m0 192a195.84 195.84 0 0 1-102.826667-100.266667 437.76 437.76 0 0 1 102.826667-19.626666z m-227.413334-37.973333H256a438.186667 438.186667 0 0 1 59.306667-35.84 350.72 350.72 0 0 0 80.64 104.106666 436.48 436.48 0 0 1-142.506667-68.693333zM72.533333 534.186667h170.666667a733.44 733.44 0 0 0 42.666667 232.106666 512 512 0 0 0-85.333334 54.186667 438.186667 438.186667 0 0 1-128-286.293333z m125.866667-330.6666"></path></svg>
                    </div>
                    <span style="font-weight: bold; margin-right: 8px;">情报推送</span>
                    <span style="background-color: #dbeafe; color: #3b82f6; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold;">2条</span>
                </div>
                <div class="monitor-body" style="padding: 15px; color: white; position: relative; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
                        <h3 id="intelTitle" style="margin: 0; font-size: 18px; font-weight: 500;">台湾西部彰化县进入警备状态</h3>
                    </div>
                    <div style="margin-bottom: 5px; font-size: 13px; color: #94a3b8;">
                        来源： <span style="color: #e2e8f0;">情报中心推送</span>
                        <span id="intelTime" style="color: #94a3b8; font-size: 12px; margin-left: 10px;">2分钟前</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-size: 13px; color: #94a3b8; display: flex; align-items: center;">
                            威胁程度： 
                            <span id="intelThreatBadge" style="background-color: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px;">高等威胁</span>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="prevIntel()" style="background: #3b82f6; border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-chevron-left"></i></button>
                            <button onclick="nextIntel()" style="background: #3b82f6; border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div style="width: 100%; height: 200px; background-color: #334155; margin-bottom: 12px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;">
                         <img id="intelImage" src="images/6.png" alt="CCTV" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                         <div id="intelGallery" style="display:none; width:100%; height:100%; overflow-x:auto; overflow-y:hidden; display:flex; gap:0; scroll-snap-type:x mandatory;"></div>
                         <button id="galleryPrevBtn" onclick="galleryPrev()" style="display:none; position:absolute; left:8px; top:50%; transform:translateY(-50%); width:24px; height:24px; border:none; border-radius:4px; background:rgba(0,0,0,0.5); color:white; cursor:pointer;"><i class="fa-solid fa-chevron-left" style="font-size:12px;"></i></button>
                         <button id="galleryNextBtn" onclick="galleryNext()" style="display:none; position:absolute; right:8px; top:50%; transform:translateY(-50%); width:24px; height:24px; border:none; border-radius:4px; background:rgba(0,0,0,0.5); color:white; cursor:pointer;"><i class="fa-solid fa-chevron-right" style="font-size:12px;"></i></button>
                         <div style="display: none; color: #94a3b8; font-size: 12px; text-align: center;">
                            <i class="fa-solid fa-video-slash" style="font-size: 24px; margin-bottom: 5px;"></i><br>影像加载失败
                         </div>
                        
                    </div>
                    <div style="border: 1px solid #475569; padding: 10px; border-radius: 4px; background: rgba(15, 23, 42, 0.6); position: relative; min-height: 60px; margin-bottom: 5px;">
                        <p id="intelDesc" style="margin: 0; font-size: 13px; line-height: 1.6; color: #e2e8f0; text-align: justify; margin-bottom: 6px;">
                            台湾东部战区开展跨昼夜联合演训，结合 IGSO卫星拍摄影像，无侦-7 无人机拍摄视频影像及雷达探测信号，台湾西部彰化县进入警备状态。
                        </p>
                        <a id="intelDetailLink" href="javascript:void(0)" onclick="openModal()" style="position: absolute; bottom: 10px; right: 10px; color: #3b82f6; text-decoration: none; font-size: 13px;">&gt;详情</a>
                    </div>
                    <div style="font-size: 14px; font-weight: bold; color: #e2e8f0; margin: 0 0 4px;">上级指示</div>
                    <div id="superiorInstructionBlock" style="border: 1px solid #475569; padding: 12px; border-radius: 4px; background: rgba(15, 23, 42, 0.6); position: relative; min-height: 46px; margin-bottom: 2px;">
                        <div id="superiorInstructionList" style="display:flex; flex-direction: column; gap:6px;">
                            <div style="color:#94a3b8; font-size:12px;">无上级指令</div>
                        </div>
                    </div>
                    <div class="intel-actions" style="display:flex; justify-content:flex-end; align-items:center; margin-top: 4px;">
                        <button id="showSolutionBtn" onclick="showSolutionCard()" style="background: #3b82f6; border: none; color: white; border-radius: 4px; padding: 8px 10px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                            <i class="fa-solid fa-clipboard-check" style="font-size: 12px;"></i> 方案推荐
                        </button>
                    </div>
                </div>
            </div>


                <div id="shipDetailPage" class="ship-detail-page">
                    <div class="ship-detail-header">
                        <span id="ship-page-title">舰艇详情</span>
                        <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closeShipPage()"></i>
                    </div>
                    <div class="ship-detail-body" id="ship-page-body"></div>
                </div>
            </div>

            <!-- Bottom Row: UAV Dispatch -->
            
            <!-- Bottom Row: UAV Dispatch -->
            <div class="uav-card" id="uavCard" style="position: absolute; top: 5px; left: 0; display: none;">
                <div class="uav-header">
                    <svg t="1768383611280" class="icon" viewBox="0 0 2048 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11272" width="28" height="20" style="vertical-align: middle; fill: white; margin-right: 5px;"><path d="M1463.217231 276.637538c-4.883692 4.844308-12.209231 4.844308-17.132308 4.844308-9.806769 0-17.132308-4.844308-24.457846-12.130461l-36.706462-48.521847c-9.806769-12.130462-7.325538-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.629538 7.286153l36.706462 48.561231c9.728 14.572308 7.325538 31.507692-7.364923 41.235692z m-97.870769 0c-4.883692 4.844308-12.209231 4.844308-17.132308 4.844308-9.806769 0-17.132308-4.844308-24.457846-12.130461l-36.706462-48.521847c-9.846154-12.130462-7.325538-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.590154 7.286153l36.706461 48.561231c9.767385 14.572308 7.325538 31.507692-7.364923 41.235692z m-105.235693 0c-4.883692 4.844308-12.209231 4.844308-17.092923 4.844308-9.806769 0-17.132308-4.844308-24.497231-12.130461l-36.667077-48.521847c-9.806769-12.130462-7.364923-31.547077 7.325539-41.275076a28.987077 28.987077 0 0 1 41.590154 7.286153l36.706461 48.561231c9.767385 14.572308 7.325538 31.507692-7.364923 41.235692z m-237.331692 524.169847a54.075077 54.075077 0 0 1-53.838769-53.405539c0-29.144615 24.497231-53.366154 53.838769-53.366154s53.799385 24.260923 53.799385 53.366154c2.481231 29.144615-21.976615 53.405538-53.799385 53.405539zM805.021538 281.481846c-4.883692 0-12.209231-2.402462-17.132307-4.844308-12.209231-9.688615-14.651077-26.702769-7.286154-41.235692l36.706461-48.561231c9.767385-12.130462 26.899692-14.572308 41.590154-7.286153 12.209231 9.728 14.651077 26.702769 7.325539 41.275076l-36.706462 48.521847a29.932308 29.932308 0 0 1-24.457846 12.130461z m-46.473846-60.652308l-36.667077 48.521847c-4.923077 7.286154-14.690462 12.130462-24.49723 12.130461a45.686154 45.686154 0 0 1-17.132308-4.844308c-12.209231-9.688615-14.690462-26.702769-7.325539-41.235692l36.706462-48.561231c9.767385-12.130462 26.899692-14.572308 41.550769-7.286153 14.729846 9.728 17.171692 29.144615 7.364923 41.275076z m308.342154 303.340308h17.092923v101.888h-122.328615V524.209231h105.235692zM660.637538 220.829538l-36.706461 48.521847c-4.883692 7.286154-14.651077 12.130462-24.418462 12.130461a45.686154 45.686154 0 0 1-17.171692-4.844308c-12.209231-9.688615-14.690462-26.702769-7.325538-41.235692l36.706461-48.561231c9.767385-12.130462 26.899692-14.572308 41.550769-7.286153 14.729846 9.728 17.171692 29.144615 7.364923 41.275076zM2006.409846 7.286154h-225.083077c-22.055385 0-41.590154 19.416615-41.590154 41.235692 0 21.858462 19.574154 41.275077 41.590154 41.275077h83.140923v80.068923h-141.863384L1235.652923 9.688615C1218.520615 4.844308 1198.946462 0 1179.332923 0h-308.263385c-19.574154 0-39.148308 2.441846-56.280615 9.688615L327.876923 169.865846H183.532308V89.796923h83.180307c22.016 0 41.590154-19.416615 41.590154-41.275077 0-21.819077-19.574154-41.235692-41.590154-41.235692H41.590154C19.574154 7.286154 0 26.702769 0 48.521846 0 70.380308 19.574154 89.796923 41.590154 89.796923h83.180308v80.068923h-22.055385c-31.744 0-58.683077 26.702769-58.683077 58.249846V271.753846c0 38.833231 31.822769 70.380308 70.931692 70.380308h342.567385V948.775385c0 21.858462 17.171692 38.833231 39.187692 38.83323h24.457846c7.364923 0 12.209231-4.844308 12.209231-12.130461L575.015385 342.173538h48.915692c26.939077 0 51.396923 16.935385 61.203692 41.235693 9.767385 24.260923 34.264615 41.235692 61.164308 41.235692h80.738461v38.833231c0 31.547077 26.899692 58.249846 58.683077 58.249846h17.171693v101.927385h-24.457846a27.057231 27.057231 0 0 0-26.939077 26.702769v177.112615c0 14.572308 12.248615 26.702769 26.939077 26.702769l291.170461 21.858462c14.690462 0 24.457846-17.014154 24.457846-31.547077v-191.724308c0-14.572308-12.209231-26.702769-26.939077-26.702769h-24.457846V524.209231H1174.449231c2.481231 0 2.481231 0 4.923077-2.441846 2.481231 0 4.923077 0 7.325538-2.441847 2.481231 0 2.481231-2.402462 4.883692-2.402461 2.481231 0 2.481231-2.441846 4.923077-2.441846 2.441846-2.402462 4.923077-2.402462 4.923077-4.844308l2.402462-2.441846c2.481231-2.402462 2.481231-4.844308 4.923077-4.844308l2.402461-2.441846c2.481231-2.402462 2.481231-4.844308 4.923077-7.246769 0 0 0-2.441846 2.441846-2.441846 0-2.441846 2.481231-4.844308 2.481231-7.286154v-50.963692h80.738462c26.899692 0 51.357538-16.974769 61.124923-41.235693 9.846154-24.260923 34.264615-41.275077 61.203692-41.275077H1472.984615l39.187693 633.383385c0 7.246769 7.325538 12.130462 12.20923 12.130461h24.497231a38.518154 38.518154 0 0 0 39.148308-38.83323V349.420308h342.528c39.148308 0 70.971077-31.507692 70.971077-70.340923v-43.716923c0-12.130462-2.481231-21.819077-9.767385-31.507693-7.364923-9.728-14.690462-17.014154-24.497231-21.858461-7.325538-2.441846-14.651077-4.844308-22.055384-4.844308h-21.976616V97.083077h83.180308c22.055385 0 41.590154-19.416615 41.590154-41.275077 0-29.144615-19.534769-48.521846-41.590154-48.521846z" fill="white" p-id="11273"></path></svg>
                    无人机侦察派遣
                </div>
                <div class="uav-form-group">
                    <span class="uav-label">目标坐标</span>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="target-coords" value="24°03'32.0&quot;N, 120°26'00.0&quot;E" 
                               style="flex: 1; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; font-size: 12px; border: 1px solid #5c6f8a; color: white; outline: none;">
                        <button onclick="enableMapPicking()" style="background: #475569; border: 1px solid #5c6f8a; color: white; border-radius: 4px; padding: 0 8px; cursor: pointer;">
                            <i class="fa-solid fa-location-crosshairs"></i>
                        </button>
                        <button id="edit-path-btn" onclick="toggleFlightPathEditing()" style="background: #475569; border: 1px solid #5c6f8a; color: white; border-radius: 4px; padding: 0 8px; cursor: pointer;">添加编辑点</button>
                    </div>
                </div>
                <div class="uav-form-group">
                    <span class="uav-label">选择执行单元 (附近可用: 3)</span>
                    <div class="uav-list-container" id="uav-list">
                        <div class="uav-group-title">🟢 可调派 (Available)</div>
                        <div class="uav-option" onclick="selectUav(this, 'uav-01')" id="opt-uav-01">
                            <div class="uav-icon" onclick="event.stopPropagation(); window.open('https://mdp.mydemo.top/', '_blank')">
                                <i class="fa-solid fa-plane-up"></i>
                            </div>
                            <div class="uav-option-content">
                                <div>
                                    <span>CH-4 彩虹 (ID: 701)</span>
                                    <div class="recommend-badge rec-time" id="badge-uav-01">时间最优</div>
                                </div>
                                <span style="color: #10b981;" id="dist-uav-01">15km</span>
                            </div>
                        </div>
                        <div class="uav-option" onclick="selectUav(this, 'uav-02')" id="opt-uav-02">
                            <div class="uav-icon" onclick="showUavDetails(event, 'WL-2 翼龙', '中空长航时侦察打击一体无人机', '4000km', '20h', '480kg')">
                                <i class="fa-solid fa-jet-fighter-up"></i>
                            </div>
                            <div class="uav-option-content">
                                <div>
                                    <span>WL-2 翼龙 (ID: 702)</span>
                                    <div class="recommend-badge rec-safety" id="badge-uav-02">安全性最优</div>
                                </div>
                                <span style="color: #10b981;" id="dist-uav-02">28km</span>
                            </div>
                        </div>
                        <div class="uav-option" onclick="selectUav(this, 'uav-03')" id="opt-uav-03">
                            <div class="uav-icon" onclick="showUavDetails(event, 'BZK-005', '高空远程侦察无人机', '2400km', '40h', '150kg')">
                                <svg t="1768370965738" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7726" width="16" height="16" style="fill: currentColor;"><path d="M 970.466 321.996 l -81.1846 0.378171 l -77.5539 60.6725 s -196.433 -0.9681 -305.46 -0.446233 l 122.427 -231.786 h -68.8798 l -190.099 226.455 c -49.2448 0.1437 -55.3335 -44.2829 -138.145 -44.2829 c -173.822 0 -231.461 175.387 -74.3855 175.387 h 211.815 l 251.97 325.853 h 108.556 l -205.186 -325.853 l 250.066 -0.355478 c 29.0582 0 54.1607 -9.52978 71.4438 -26.8422 l 124.606 -159.178 Z" p-id="7727"></path></svg>
                            </div>
                            <div class="uav-option-content">
                                <div>
                                    <span>BZK-005 (ID: 705)</span>
                                    <div class="recommend-badge rec-cost" id="badge-uav-03">效费比最优</div>
                                </div>
                                <span style="color: #10b981;" id="dist-uav-03">42km</span>
                            </div>
                        </div>

                        <div class="uav-group-title">🟡 执行任务中 (On Mission)</div>
                        <div class="uav-option disabled">
                            <div class="uav-icon"><i class="fa-solid fa-plane-circle-exclamation"></i></div>
                            <div class="uav-option-content">
                                <span>TB-001 双尾蝎 (ID: 801)</span>
                                <span>任务 A-12</span>
                            </div>
                        </div>
                        <div class="uav-option disabled">
                            <div class="uav-icon"><i class="fa-solid fa-plane-circle-exclamation"></i></div>
                            <div class="uav-option-content">
                                <span>CH-5 彩虹 (ID: 803)</span>
                                <span>任务 B-09</span>
                            </div>
                        </div>

                        <div class="uav-group-title">🔴 不可用/维护 (Unavailable)</div>
                        <div class="uav-option disabled">
                            <div class="uav-icon"><i class="fa-solid fa-plane-slash"></i></div>
                            <div class="uav-option-content">
                                <span>WZ-7 翔龙 (ID: 901)</span>
                                <span>返航补给</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="selected-uav-id">
                </div>
                <div class="uav-form-group">
                    <span class="uav-label">任务类型</span>
                    <select class="uav-select">
                        <option>高空持续监视</option>
                        <option>低空抵近侦察</option>
                        <option>目标激光照射</option>
                    </select>
                </div>
                <div class="uav-form-group" style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <span class="uav-label">无人机起飞坐标</span>
                        <span id="uav-start-coords" style="display:block; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; font-size: 12px; border: 1px solid #5c6f8a; color: white; min-height: 30px;"></span>
                    </div>
                    <div style="flex: 1;">
                        <span class="uav-label">无人机返航坐标</span>
                        <span id="uav-return-coords" style="display:block; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; font-size: 12px; border: 1px solid #5c6f8a; color: white; min-height: 30px;"></span>
                    </div>
                </div>
                <button class="uav-btn" onclick="dispatchUav()">
                    <i class="fa-solid fa-crosshairs"></i> 立即派遣
                </button>
            </div>
        </div>

        <!-- Intel Push Card -->
        <div class="monitor-card" id="intelCardDeprecated" style="display: none; background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); width: 400px; height: 480px; position: absolute; right: 20px; top: 10px; z-index: 1001;">
            <!-- Header -->
            <div class="monitor-header">
                <div class="icon-circle">
                     <svg t="1768383451211" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8798" width="12" height="12" style="vertical-align: middle; fill: white;"><path d="M825.6 820.48a520.96 520.96 0 0 0-85.333333-54.186667 730.88 730.88 0 0 0 42.666666-232.106666h170.666667a438.186667 438.186667 0 0 1-128 286.293333z m-196.266667 115.626667a349.44 349.44 0 0 0 80.64-104.106667 444.586667 444.586667 0 0 1 59.306667 35.84 438.613333 438.613333 0 0 1-139.52 68.266667zM554.666667 902.4v-115.626667a441.173333 441.173333 0 0 1 93.013333 18.773334A206.933333 206.933333 0 0 1 554.666667 902.4z m0-368.213333h156.586666a696.746667 696.746667 0 0 1-34.986666 205.226666 512 512 0 0 0-121.6-24.746666z m0-224.426667a506.026667 506.026667 0 0 0 121.6-24.746667 674.986667 674.986667 0 0 1 33.706666 177.493334H554.666667z m0-187.733333a206.933333 206.933333 0 0 1 93.013333 96.426666 439.893333 439.893333 0 0 1-93.013333 18.773334z m217.6 34.56a438.186667 438.186667 0 0 1-59.306667 35.84 350.72 350.72 0 0 0-80.64-104.106667 436.48 436.48 0 0 1 138.24 67.84z m178.773333 305.92h-170.666667a721.066667 721.066667 0 0 0-42.666666-203.946667 512 512 0 0 0 85.333333-54.186667 438.186667 438.186667 0 0 1 126.293333 257.706667z m-469.333333-224a437.76 437.76 0 0 1-102.826667-19.626667 194.986667 194.986667 0 0 1 102.826667-100.266667z m0 224h-166.4a682.666667 682.666667 0 0 1 33.706666-177.493334 512 512 0 0 0 131.84 25.6v151.893334z m0 251.733333a508.16 508.16 0 0 0-131.84 25.6 696.746667 696.746667 0 0 1-34.986667-205.226667h166.826667z m0 192a195.84 195.84 0 0 1-102.826667-100.266667 437.76 437.76 0 0 1 102.826667-19.626666z m-227.413334-37.973333H256a438.186667 438.186667 0 0 1 59.306667-35.84 350.72 350.72 0 0 0 80.64 104.106666 436.48 436.48 0 0 1-142.506667-68.693333zM72.533333 534.186667h170.666667a733.44 733.44 0 0 0 42.666667 232.106666 512 512 0 0 0-85.333334 54.186667 438.186667 438.186667 0 0 1-128-286.293333z m125.866667-330.666667A520.96 520.96 0 0 0 284.586667 256a721.066667 721.066667 0 0 0-42.666667 203.946667h-170.666667a438.186667 438.186667 0 0 1 127.146667-256.426667z m196.266667-115.626667A349.44 349.44 0 0 0 314.026667 192 444.586667 444.586667 0 0 1 256 156.16a438.613333 438.613333 0 0 1 138.24-68.266667zM512 0a512 512 0 1 0 512 512A512 512 0 0 0 512 0z" fill="white" p-id="8799"></path></svg>
                </div>
                <span style="font-weight: bold; margin-right: 8px;">情报推送</span>
                <span style="background-color: #dbeafe; color: #3b82f6; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold;">2条</span>
            </div>

            <!-- Content Body -->
            <div class="monitor-body" style="padding: 15px; color: white; position: relative;">
                <!-- Title & Time -->
                <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
                    <h3 id="intelTitleDeprecated" style="margin: 0; font-size: 18px; font-weight: 500;">台湾西部彰化县进入警备状态</h3>
                </div>

                <!-- Info Row -->
                <div style="margin-bottom: 5px; font-size: 13px; color: #94a3b8;">
                    来源： <span style="color: #e2e8f0;">情报中心推送</span>
                    <span id="intelTimeDeprecated" style="color: #94a3b8; font-size: 12px; margin-left: 10px;">2分钟前</span>
                </div>

                <!-- Threat Level & Navigation -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="font-size: 13px; color: #94a3b8; display: flex; align-items: center;">
                        威胁程度： 
                        <span id="intelThreatBadgeDeprecated" style="background-color: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-left: 5px;">高等威胁</span>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        <button onclick="prevIntel()" style="background: #3b82f6; border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-chevron-left"></i></button>
                        <button onclick="nextIntel()" style="background: #3b82f6; border: none; color: white; width: 24px; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>

                <!-- Image/Gallery Placeholder -->
                <div style="width: 100%; height: 180px; background-color: #334155; margin-bottom: 6px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;">
                     <img id="intelImageDeprecated" src="images/6.png" alt="CCTV" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                     <div id="intelGalleryDeprecated" style="display:none; width:100%; height:100%; overflow-x:auto; overflow-y:hidden; display:flex; gap:0; scroll-snap-type:x mandatory;">
                     </div>
                     <button id="galleryPrevBtnDeprecated" onclick="galleryPrev()" style="display:none; position:absolute; left:8px; top:50%; transform:translateY(-50%); width:24px; height:24px; border:none; border-radius:4px; background:rgba(0,0,0,0.5); color:white; cursor:pointer;"><i class="fa-solid fa-chevron-left" style="font-size:12px;"></i></button>
                     <button id="galleryNextBtnDeprecated" onclick="galleryNext()" style="display:none; position:absolute; right:8px; top:50%; transform:translateY(-50%); width:24px; height:24px; border:none; border-radius:4px; background:rgba(0,0,0,0.5); color:white; cursor:pointer;"><i class="fa-solid fa-chevron-right" style="font-size:12px;"></i></button>
                     <div style="display: none; color: #94a3b8; font-size: 12px; text-align: center;">
                        <i class="fa-solid fa-video-slash" style="font-size: 24px; margin-bottom: 5px;"></i><br>
                        影像加载失败
                     </div>
                     <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); color: white; padding: 2px 5px; font-size: 10px; border-radius: 2px;">
                         <span style="border: 1px solid white; padding: 0 2px; margin-right: 2px; font-size: 8px;">CCTV</span> 13
                     </div>

                     </div>
                </div>

                <!-- Description Box -->
                <div style="border: 1px solid #475569; padding: 10px; border-radius: 4px; background: rgba(15, 23, 42, 0.6); position: relative; min-height: 60px; margin-bottom: 10px;">
                    <p id="intelDescDeprecated" style="margin: 0; font-size: 13px; line-height: 1.6; color: #e2e8f0; text-align: justify; margin-bottom: 6px;">
                        台湾东部战区开展跨昼夜联合演训，结合 IGSO卫星拍摄影像，无侦-7 无人机拍摄视频影像及雷达探测信号，台湾西部彰化县进入警备状态。
                    </p>
                    <a id="intelDetailLinkDeprecated" href="javascript:void(0)" onclick="openModal()" style="position: absolute; bottom: 2px; right: 10px; color: #3b82f6; text-decoration: none; font-size: 13px;">&gt;详情</a>
                </div>
                <button id="showSolutionBtnDeprecated" onclick="showSolutionCard()" style="position: absolute; right: 15px; bottom: 18px; background: #3b82f6; border: none; color: white; border-radius: 4px; padding: 8px 10px; font-size: 12px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="fa-solid fa-clipboard-check" style="font-size: 12px;"></i> 方案推荐
                </button>
            </div>
        </div>

        <!-- Solution Recommendation Card -->
        <div class="monitor-card" id="solutionCard" style="display: none; background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); width: 400px; height: auto; position: absolute; right: 20px; top: 10px; z-index: 1001;">
            <div class="monitor-header">
                <div class="icon-circle">
                     <i class="fa-solid fa-clipboard-check" style="color: white; font-size: 12px;"></i>
                </div>
                <span style="font-weight: bold; margin-right: 8px;">方案推荐</span>
                <button id="solution-fullscreen-btn" onclick="toggleSolutionFullscreen()" title="全屏" style="margin-left:auto; background: rgba(0,0,0,0.3); border: 1px solid #5c6f8a; color: #e2e8f0; border-radius: 4px; padding: 4px 6px; font-size: 12px; cursor: pointer; display:inline-flex; align-items:center; gap:6px;">
                    <i class="fa-solid fa-expand"></i>
                </button>
            </div>
            <div class="monitor-body" style="padding: 15px; color: white;">
                <div style="margin-bottom: 12px;">
                </div>
                <div>
                    <h4 style="margin: 0 0 6px 0; color: #10b981; font-size: 14px; border-left: 3px solid #10b981; padding-left: 8px;">处置预案</h4>
                    <div class="uav-list-container" style="max-height: none; overflow: visible; display: grid; grid-template-columns: 1fr; gap: 8px;">
                        <div class="uav-group-title" onclick="togglePlanSection('overview')" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                            <span>1. 预案库匹配</span><span id="arrow-overview" style="color:#cbd5e1;">▼</span>
                        </div>
                        <div id="plan-section-overview" style="border: 1px solid #475569; border-radius: 4px; padding: 10px; background: rgba(255,255,255,0.05); display:block;">
                            <div id="plan-overview" style="font-size: 13px; color: #cbd5e1; line-height: 1.6;">符合 <span id="plan-article-23-link" onclick="openPlanArticle23()" style="color:#60a5fa; text-decoration:underline; cursor:pointer;">案例库第二十三</span> 条</div>
                        </div>
                        <div class="uav-group-title" onclick="togglePlanSection('rules')" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                            <span>2. 作战规则匹配</span><span id="arrow-rules" style="color:#cbd5e1;">▼</span>
                        </div>
                        <div id="plan-section-rules" style="border: 1px solid #475569; border-radius: 4px; padding: 10px; background: rgba(255,255,255,0.05); display:block;">
                            <div style="font-size: 13px; color: #cbd5e1; line-height: 1.6;">
                                <div style="margin-bottom:4px;">条令1：外军军舰距我领海100-300千米</div>
                                <div>条令2：.外军军舰进入台湾岛100-500千米</div>
                            </div>
                        </div>
                        <div class="uav-group-title" onclick="togglePlanSection('case')" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                            <span>3. 战例库匹配</span><span id="arrow-case" style="color:#cbd5e1;">▼</span>
                        </div>
                        <div id="plan-section-case" style="display:block;">
                            <div id="case-list" style="display: grid; grid-template-columns: 1fr; gap: 6px;">
                                <div style="font-size: 12px; color: #94a3b8;">系统正在匹配历史战例...</div>
                            </div>
                        </div>
                        <div class="uav-group-title" onclick="togglePlanSection('recommend')" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                            <span>4. 推荐方案</span><span id="arrow-recommend" style="color:#cbd5e1;">▼</span>
                        </div>
                        <div id="plan-section-recommend" style="display:block; border: 1px solid #475569; border-radius: 6px; padding: 10px; background: rgba(255,255,255,0.06); box-shadow: 0 2px 8px rgba(0,0,0,0.25);">
                            <div style="display:flex; justify-content:flex-end; margin-bottom:8px;">
                                <button id="fishbone-detail-btn" onclick="openFishboneModal()" style="background:#3b82f6; color:white; border:none; padding:6px 10px; border-radius:4px; font-size:12px; cursor:pointer;">
                                    <i class="fa-solid fa-diagram-project"></i> 详情
                                </button>
                                <button id="recommend-edit-btn" onclick="enableRecommendEdit()" style="background:#475569; color:white; border:1px solid #5c6f8a; padding:6px 10px; border-radius:4px; font-size:12px; cursor:pointer; margin-left:6px;">
                                    <i class="fa-solid fa-pen"></i> 编辑
                                </button>
                            </div>
                            <div style="overflow-x:auto;">
                                <table style="width:100%; border-collapse:collapse; font-size:12px; color:#ffffff; border-top:1px solid rgba(148,163,184,0.4); border-bottom:1px solid rgba(148,163,184,0.4);">
                                    <thead>
                                        <tr style="background:rgba(15,23,42,0.8);">
                                            <th style="text-align:left; padding:8px 10px; font-weight:600; color:#ffffff; border-bottom:1px solid rgba(148,163,184,0.7);">时间</th>
                                            <th style="text-align:left; padding:8px 10px; font-weight:600; color:#ffffff; border-bottom:1px solid rgba(148,163,184,0.7);">指控席</th>
                                            <th style="text-align:left; padding:8px 10px; font-weight:600; color:#ffffff; border-bottom:1px solid rgba(148,163,184,0.7);">情报席</th>
                                            <th style="text-align:left; padding:8px 10px; font-weight:600; color:#ffffff; border-bottom:1px solid rgba(148,163,184,0.7);">战区火力席</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="background:rgba(15,23,42,0.6);">
                                            <td style="padding:8px 10px; border-bottom:1px solid rgba(148,163,184,0.4); white-space:nowrap;">T+0h</td>
                                            <td style="padding:8px 10px; border-bottom:1px solid rgba(148,163,184,0.4);">签发处置任务，形成机要传真</td>
                                            <td style="padding:8px 10px; border-bottom:1px solid rgba(148,163,184,0.4);">态势席实时更新态势图，研判态势反馈续报</td>
                                            <td style="padding:8px 10px; border-bottom:1px solid rgba(148,163,184,0.4);">出动2架CH-4彩虹无人机跟踪侦察</td>
                                        </tr>
                                        <tr style="background:rgba(15,23,42,0.4);">
                                            <td style="padding:8px 10px; border-bottom:1px solid rgba(148,163,184,0.4); white-space:nowrap;">T+2h</td>
                                            <td style="padding:8px 10px; border-bottom:1px solid rgba(148,163,184,0.4);">下达外逼驱离命令</td>
                                            <td style="padding:8px 10px; border-bottom:1px solid rgba(148,163,184,0.4);">跟踪态势与风险评估</td>
                                            <td style="padding:8px 10px; border-bottom:1px solid rgba(148,163,184,0.4);">CH-4彩虹无人机低空跟踪侦察</td>
                                        </tr>
                                        <tr style="background:rgba(15,23,42,0.6);">
                                            <td style="padding:8px 10px; white-space:nowrap;">T+6h</td>
                                            <td style="padding:8px 10px;">续报处置进展与调整建议</td>
                                            <td style="padding:8px 10px;">汇总形成综合情况报告</td>
                                            <td style="padding:8px 10px;">闭环复盘与归档</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="recommend-edit-controls" style="display:none; margin-top:8px; gap:8px; justify-content:flex-end;">
                                <button onclick="addRecommendRow()" style="background:#475569; color:white; border:1px solid #5c6f8a; padding:6px 10px; border-radius:4px; font-size:12px; cursor:pointer;">
                                    <i class="fa-solid fa-plus"></i> 新增一行
                                </button>
                                <button onclick="saveRecommendEdit()" style="background:#10b981; color:white; border:none; padding:6px 10px; border-radius:4px; font-size:12px; cursor:pointer;">
                                    <i class="fa-solid fa-check"></i> 保存
                                </button>
                                <button onclick="cancelRecommendEdit()" style="background:#ef4444; color:white; border:none; padding:6px 10px; border-radius:4px; font-size:12px; cursor:pointer;">
                                    <i class="fa-solid fa-xmark"></i> 取消
                                </button>
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:flex-end; margin-top:8px;">
                        <button id="inline-confirm-outside" onclick="confirmPlan()" style="background:#10b981; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer;">
                            <i class="fa-solid fa-check"></i> 确认方案
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div id="planArticleModal23" class="plan-detail-modal" style="display:none; width: 720px; max-width: 95vw;">
        <div class="plan-detail-header">
            <span>预案库第二十三条</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closePlanArticle23()"></i>
        </div>
        <div class="plan-detail-body" style="max-height: 60vh; overflow-y: auto;">
            <div style="margin-bottom: 10px; font-size: 13px; color:#cbd5e1; line-height:1.7;">
                接收到情报席汇总情报与态势席更新战场态势，符合本级处置：
            </div>
            <div class="result-body" style="gap:10px;">
                <div style="border:1px solid #475569; border-radius:6px; padding:10px; background: rgba(255,255,255,0.05);">
                    <div style="color:#e2e8f0; font-weight:bold; margin-bottom:6px;">1. 指挥员加入初步决心</div>
                    <div style="color:#94a3b8; font-size:12px;">文书生成《初步决心》</div>
                </div>
                <div style="border:1px solid #475569; border-radius:6px; padding:10px; background: rgba(255,255,255,0.05);">
                    <div style="color:#e2e8f0; font-weight:bold; margin-bottom:6px;">2. 指挥员将情况转至指控席进行侦察、火力调控</div>
                    <div style="color:#94a3b8; font-size:12px;">指控席形成处置建议上报指挥员批准，文书生成《专项方案》《预案》</div>
                </div>
                <div style="border:1px solid #475569; border-radius:6px; padding:10px; background: rgba(255,255,255,0.05);">
                    <div style="color:#e2e8f0; font-weight:bold; margin-bottom:6px;">3. 指挥员批准后，指控席进行侦察、火力调控</div>
                    <div style="color:#94a3b8; font-size:12px;">文书生成续报《情况报告》《对下命令》</div>
                </div>
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px; border-top: 1px solid #475569;">
            <button style="background:#10b981; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="closePlanArticle23()">
                <i class="fa-solid fa-check"></i> 关闭
            </button>
        </div>
    </div>
    
    <div id="overlay-backdrop" class="overlay-backdrop" onclick="closeUavDetails()"></div>

    <div id="uav-detail-modal" class="uav-detail-modal">
        <div class="uav-detail-header">
            <span id="uav-detail-title">UAV Model</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closeUavDetails()"></i>
        </div>
        
        <div id="overlay-ship" class="overlay-backdrop" onclick="closeShipDetails()" style="display:none;"></div>
        <div id="shipDetailModal" class="uav-detail-modal" style="display:none;">
            <div class="uav-detail-header">
                <span id="ship-detail-title">舰艇详情</span>
                <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closeShipDetails()"></i>
            </div>
            <div class="uav-detail-body">
                <div class="uav-spec-row">
                    <span class="uav-spec-label">名称</span>
                    <span class="uav-spec-val" id="ship-detail-name">—</span>
                </div>
                <div class="uav-spec-row">
                    <span class="uav-spec-label">指挥官</span>
                    <span class="uav-spec-val" id="ship-detail-commander">—</span>
                </div>
                <div class="uav-spec-row">
                    <span class="uav-spec-label">类型/级别</span>
                    <span class="uav-spec-val" id="ship-detail-type">—</span>
                </div>
                <div class="uav-spec-row">
                    <span class="uav-spec-label">满载排水量</span>
                    <span class="uav-spec-val" id="ship-detail-displ">—</span>
                </div>
                <div class="uav-spec-row">
                    <span class="uav-spec-label">尺寸</span>
                    <span class="uav-spec-val" id="ship-detail-dim">—</span>
                </div>
                <div class="uav-spec-row">
                    <span class="uav-spec-label">最高航速</span>
                    <span class="uav-spec-val" id="ship-detail-speed">—</span>
                </div>
                <div class="uav-spec-row">
                    <span class="uav-spec-label">主要装备/传感器</span>
                    <span class="uav-spec-val" id="ship-detail-equip">—</span>
                </div>
                <div id="ship-detail-photo-wrap" style="margin-top: 12px;">
                    <img id="ship-detail-photo" src="" alt="舰艇照片" style="max-width:100%; border:1px solid #475569; border-radius:6px; display:none;" onerror="this.style.display='none'">
                </div>
                <div id="ship-detail-extra" style="margin-top: 12px; font-size: 12px; color: #cbd5e1; line-height: 1.6; max-height: 40vh; overflow-y: auto;"></div>
            </div>
        </div>
        <div class="uav-detail-body">
            <div class="uav-spec-row">
                <span class="uav-spec-label">类型</span>
                <span class="uav-spec-val" id="uav-detail-type">Type</span>
            </div>
            <div class="uav-spec-row">
                <span class="uav-spec-label">最大航程</span>
                <span class="uav-spec-val" id="uav-detail-range">0km</span>
            </div>
            <div class="uav-spec-row">
                <span class="uav-spec-label">续航时间</span>
                <span class="uav-spec-val" id="uav-detail-endurance">0h</span>
            </div>
            <div class="uav-spec-row">
                <span class="uav-spec-label">任务载荷</span>
                <span class="uav-spec-val" id="uav-detail-payload">0kg</span>
            </div>
            <div style="margin-top: 15px; font-size: 12px; color: #94a3b8; line-height: 1.4;">
                <i class="fa-solid fa-triangle-exclamation" style="color: #f59e0b; margin-right: 4px;"></i>
                该型号配备高清光电吊舱与合成孔径雷达，适合全天候侦察任务。
            </div>
        </div>
    </div>
    
    <div id="intentWorkflowModal" class="plan-detail-modal" style="display:none; width: 900px; max-width: 95vw; max-height: 85vh;">
        <div class="plan-detail-header">
            <span id="intent-workflow-title">意图分析 · —</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closeIntentWorkflow()"></i>
        </div>
        <div class="plan-detail-body" style="max-height: 70vh; overflow-y: auto;">
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #e2e8f0; margin-bottom: 6px;">Agent工作流</div>
                <div id="intent-workflow-agent" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;"></div>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #e2e8f0; margin-bottom: 6px;">历史战例匹配</div>
                <div id="intent-workflow-cases" style="display:grid; grid-template-columns: 1fr; gap:6px;"></div>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #e2e8f0; margin-bottom: 6px;">编队匹配</div>
                <div id="intent-workflow-formation" style="display:grid; grid-template-columns: 1fr; gap:6px;"></div>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #e2e8f0; margin-bottom: 6px;">中美作战条令匹配</div>
                <div id="intent-workflow-doctrine" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;"></div>
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px; border-top: 1px solid #475569;">
            <button style="background:#475569; color:white; border:1px solid #5c6f8a; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="closeIntentWorkflow()">
                <i class="fa-solid fa-times"></i> 关闭
            </button>
        </div>
    </div>
    <div id="fishboneModal" class="plan-detail-modal" style="display:none; width: 1000px; max-width: 95vw; max-height: 85vh;">
        <div class="plan-detail-header">
            <span>推荐方案 · 甘特图</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closeFishboneModal()"></i>
        </div>
        <div class="plan-detail-body" style="max-height: 75vh; overflow: hidden; display:flex; flex-direction:column;">
            <div id="fishbone-modal-container" style="position: relative; flex:1; min-height: 0; border: 1px solid #475569; border-radius: 6px; background: rgba(15,23,42,0.95); padding: 12px; overflow:auto;"></div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px; border-top: 1px solid #475569;">
            <button style="background:#10b981; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="closeFishboneModal()">
                <i class="fa-solid fa-check"></i> 关闭
            </button>
        </div>
    </div>

    <div id="planDetailModal" class="plan-detail-modal">
        <div class="plan-detail-header">
            <span id="plan-detail-title">方案详情</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closePlanDetail()"></i>
        </div>
        <div class="plan-detail-body">
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #3b82f6; margin-bottom: 4px;">任务执行方式</div>
                <div id="plan-detail-desc" style="font-size: 13px; line-height: 1.6;">—</div>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #10b981; margin-bottom: 4px;">甘特图</div>
                <div class="gantt-container" id="ganttContainer"></div>
            </div>
            <div>
                <div style="font-weight: bold; color: #f59e0b; margin-bottom: 4px;">方案推演</div>
                <div id="plan-simulation" style="font-size: 13px; line-height: 1.6;">—</div>
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px; border-top: 1px solid #475569;">
            <button id="plan-edit-btn" style="background:#475569; color:white; border:1px solid #5c6f8a; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer; display:none;" onclick="openPlanManualEdit()">
                <i class="fa-solid fa-pen-to-square"></i> 手动修改
            </button>
            <button id="plan-confirm-btn" style="background:#10b981; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer; display:none;" onclick="confirmPlan()">
                <i class="fa-solid fa-check"></i> 确认方案
            </button>
        </div>
    </div>

    <div id="reportModal" class="plan-detail-modal" style="display:none;">
        <div class="plan-detail-header">
            <span>预案报告</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closeReportModal()"></i>
        </div>
        <div class="plan-detail-body">
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #3b82f6; margin-bottom: 4px;">报告标题</div>
                <input id="report-title" type="text" style="width:100%; background: rgba(0,0,0,0.2); color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;">
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #10b981; margin-bottom: 4px;">摘要</div>
                <textarea id="report-summary" style="width:100%; height:80px; background: rgba(0,0,0,0.2); color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;"></textarea>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #f59e0b; margin-bottom: 4px;">行动步骤</div>
                <textarea id="report-actions" style="width:100%; height:100px; background: rgba(0,0,0,0.2); color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;"></textarea>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #94a3b8; margin-bottom: 4px;">资源与协同</div>
                <textarea id="report-resources" style="width:100%; height:80px; background: rgba(0,0,0,0.2); color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;"></textarea>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #cbd5e1; margin-bottom: 4px;">时间安排</div>
                <textarea id="report-timeline" style="width:100%; height:60px; background: rgba(0,0,0,0.2); color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;"></textarea>
            </div>
            <div>
                <div style="font-weight: bold; color: #e2e8f0; margin-bottom: 4px;">备注</div>
                <textarea id="report-remarks" style="width:100%; height:60px; background: rgba(0,0,0,0.2); color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;"></textarea>
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px; border-top: 1px solid #475569;">
            <button style="background:#475569; color:white; border:1px solid #5c6f8a; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="saveReportChanges()">
                <i class="fa-solid fa-floppy-disk"></i> 保存修改
            </button>
            <button style="background:#10b981; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="closeReportModal()">
                <i class="fa-solid fa-check"></i> 关闭
            </button>
        </div>
    </div>

    <div id="intelSendModal" class="plan-detail-modal" style="display:none; width: 680px; max-width: 95vw;">
        <div class="plan-detail-header">
            <span>情报发送</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closeIntelSendModal()"></i>
        </div>
        <div class="plan-detail-body" style="max-height: 60vh; overflow-y: auto;">
            <div style="display:grid; grid-template-columns: 1fr; gap:8px; margin-bottom:12px;">
                <div>
                    <div style="font-weight:bold; color:#94a3b8; margin-bottom:4px;">发件人</div>
                    <input id="brief-from" type="text" placeholder="例：情报中心" style="width:100%; background: rgba(0,0,0,0.2); color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;">
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:12px;">
                <div>
                    <div style="font-weight:bold; color:#e2e8f0; margin-bottom:4px;">收件人</div>
                    <input id="brief-to" type="text" placeholder="人名-职级-席位，多个用逗号分隔" oninput="renderTags('brief-to','brief-to-tags')" style="width:100%; background: rgba(0,0,0,0.2); color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;">
                    <div id="brief-to-tags" style="margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;"></div>
                </div>
                <div>
                    <div style="font-weight:bold; color:#94a3b8; margin-bottom:4px;">抄送</div>
                    <input id="brief-cc" type="text" placeholder="人名-职级-席位，多个用逗号分隔" oninput="renderTags('brief-cc','brief-cc-tags')" style="width:100%; background: rgba(0,0,0,0.2); color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;">
                    <div id="brief-cc-tags" style="margin-top:6px; display:flex; flex-wrap:wrap; gap:6px;"></div>
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr; gap:8px; margin-bottom:12px;">
                <div>
                    <div style="font-weight:bold; color:#e2e8f0; margin-bottom:4px;">主题</div>
                    <input id="brief-subject" type="text" placeholder="情报整编：态势简报" style="width:100%; background: rgba(0,0,0,0.2); color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;">
                </div>
            </div>
            <div style="display:flex; gap:8px; margin-bottom:8px; align-items:center;">
                <button style="background:#475569; color:white; border:1px solid #5c6f8a; padding:6px 8px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="formatDoc('bold')">加粗</button>
                <button style="background:#475569; color:white; border:1px solid #5c6f8a; padding:6px 8px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="formatDoc('underline')">下划线</button>
                <button style="background:#475569; color:white; border:1px solid #5c6f8a; padding:6px 8px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="formatDoc('justifyCenter')">居中</button>
                <select id="font-size-select" style="background:#0f172a; color:#e2e8f0; border:1px solid #475569; border-radius:4px; padding:6px 8px; font-size:12px;">
                    <option value="12">12px</option>
                    <option value="14" selected>14px</option>
                    <option value="16">16px</option>
                    <option value="18">18px</option>
                    <option value="20">20px</option>
                </select>
                <button style="background:#475569; color:white; border:1px solid #5c6f8a; padding:6px 8px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="applyFontSize()">应用字号</button>
            </div>
            <div id="doc-editor" contenteditable="true" style="background:#ffffff; border:1px solid #475569; border-radius:6px; padding:16px;">
                <div id="doc-title" style="font-size:36px; color:#22c55e; text-align:center; letter-spacing:6px; margin-bottom:12px;">机要传真</div>
                <div style="display:flex; justify-content:space-between; align-items:center; color:#16a34a; font-size:13px; border-bottom:2px solid #22c55e; padding:8px 0; margin-bottom:14px;">
                    <span id="doc-center" style="font-weight:600;">情报席</span>
                    <span id="doc-number" style="font-weight:600;">（2026）XX号</span>
                    <span id="doc-date" style="font-weight:600;">—</span>
                </div>
                <div id="doc-headline" style="font-size:20px; font-weight:bold; color:#1e293b; text-align:center; margin:16px 0;">—</div>
                <div id="doc-paragraph" style="font-size:14px; line-height:1.9; color:#0f172a; text-indent:2em; margin-bottom:12px;">—</div>
                <div id="doc-list" style="font-size:14px; line-height:1.9; color:#0f172a; margin:12px 0;">
                    <!-- 动态填充 一、二、三、四 ... -->
                </div>
                <div style="border-top:2px solid #22c55e; margin:16px 0;"></div>
                <div style="display:flex; justify-content:space-between; color:#0f172a; font-size:13px;">
                    <span id="doc-footer-left">主办：XXX席</span>
                    <span id="doc-footer-right">发送：XXX</span>
                </div>
                <div style="display:none; grid-template-columns: 1fr 1fr; gap:8px; margin:8px 0;">
                    <img id="doc-image-1" src="" alt="配图1" style="width:100%; border:1px solid #475569; border-radius:6px;">
                    <img id="doc-image-2" src="" alt="配图2" style="width:100%; border:1px solid #475569; border-radius:6px;">
                </div>
                <div id="doc-caption" style="display:none; font-size:12px; color:#64748b; text-align:center;">—</div>
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px; border-top: 1px solid #475569;">
            <button style="background:#475569; color:white; border:1px solid #5c6f8a; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="closeIntelSendModal()">
                <i class="fa-solid fa-times"></i> 关闭
            </button>
            <button style="background:#10b981; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="sendIntelBrief()">
                <i class="fa-solid fa-paper-plane"></i> 发送
            </button>
        </div>
    </div>
    <div id="instructionFileModal" class="plan-detail-modal" style="display:none; width: 720px; max-width: 95vw;">
        <div class="plan-detail-header">
            <span id="instruction-file-title">上级指示文件</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closeInstructionFileModal()"></i>
        </div>
        <div class="plan-detail-body" style="max-height: 70vh; overflow-y: auto;">
            <div id="instruction-doc" style="background:#ffffff; border:1px solid #475569; border-radius:6px; padding:16px;">
                <div id="instr-doc-title" style="font-size:28px; color:#ef4444; text-align:center; letter-spacing:4px; margin-bottom:8px;">—</div>
                <div style="display:flex; justify-content:space-between; color:#64748b; font-size:12px; border-top:1px solid #475569; border-bottom:1px solid #475569; padding:6px 0; margin-bottom:12px;">
                    <span id="instr-doc-center">—</span>
                    <span id="instr-doc-date">—</span>
                </div>
                <div id="instr-doc-headline" style="font-size:18px; font-weight:bold; color:#1e293b; text-align:center; margin:12px 0;">—</div>
                <div id="instr-doc-paragraph" style="font-size:13px; line-height:1.8; color:#334155; text-indent:2em; margin-bottom:12px; background:#ffffff;">—</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin:8px 0;">
                    <img id="instr-doc-image-1" src="" alt="配图1" style="width:100%; border:1px solid #475569; border-radius:6px; display:none;">
                    <img id="instr-doc-image-2" src="" alt="配图2" style="width:100%; border:1px solid #475569; border-radius:6px; display:none;">
                </div>
                <div id="instr-doc-caption" style="font-size:12px; color:#64748b; text-align:center;">—</div>
                <div style="display:flex; justify-content:space-between; font-size:13px; color:#0f172a; margin-top:12px;">
                    <span id="instr-extra-footer-left">主办：XXX席</span>
                    <span id="instr-extra-footer-right">抄送：XXXX</span>
                </div>
                <div id="instr-extra-title" style="font-weight:bold; font-size:16px; color:#0f172a; margin:12px 0;">—</div>
                <ol id="instr-extra-list" style="font-size:14px; line-height:1.9; color:#0f172a; margin:8px 0 0 24px;"></ol>
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px; border-top: 1px solid #475569;">
            <button style="background:#475569; color:white; border:1px solid #5c6f8a; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="closeInstructionFileModal()">
                <i class="fa-solid fa-times"></i> 关闭
            </button>
        </div>
    </div>
    <div id="caseDetailModal" class="plan-detail-modal" style="display:none; width: 1000px; max-width: 95vw;">
        <div class="plan-detail-header">
            <span id="case-detail-title">战例详情</span>
            <i class="fa-solid fa-times" style="cursor:pointer;" onclick="closeCaseDetail()"></i>
        </div>
        <div class="plan-detail-body">
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #3b82f6; margin-bottom: 4px;">事件信息</div>
                <div id="case-detail-meta" style="font-size: 13px; line-height: 1.6; color:#cbd5e1;">—</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:12px; color:#cbd5e1; margin-top:6px;">
                    <div>事件ID：<span id="case-detail-id">—</span></div>
                    <div>事件类别：<span id="case-detail-category">—</span></div>
                    <div>时间：<span id="case-detail-time">—</span></div>
                    <div style="grid-column: 1 / -1;">结构化信息：<span id="case-detail-struct">—</span></div>
                    <div style="grid-column: 1 / -1;">威胁程度：<span id="case-detail-threat">—</span></div>
                </div>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="font-weight: bold; color: #10b981; margin-bottom: 4px;">经过与处置</div>
                <div id="case-detail-desc" style="font-size: 13px; line-height: 1.6; color:#cbd5e1;">—</div>
            </div>
            <div style="margin-bottom: 12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <div style="display:flex; gap:6px;">
                        <button id="case-stats-btn-year" style="background:#475569; color:white; border:1px solid #5c6f8a; padding:4px 8px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="setCaseStatsMode('year')">按年</button>
                        <button id="case-stats-btn-month" style="background:#475569; color:white; border:1px solid #5c6f8a; padding:4px 8px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="setCaseStatsMode('month')">按月</button>
                        <button id="case-stats-btn-region" style="background:#475569; color:white; border:1px solid #5c6f8a; padding:4px 8px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="setCaseStatsMode('region')">按区域</button>
                    </div>
                </div>
                <div id="case-stats-chart" style="border:1px solid #475569; border-radius:6px; padding:8px; background: rgba(255,255,255,0.05); height:260px; overflow:hidden;"></div>
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:8px; padding: 12px 16px; border-top: 1px solid #475569;">
            <button style="background:#10b981; color:white; border:none; padding:8px 12px; border-radius:4px; font-size:12px; cursor:pointer;" onclick="closeCaseDetail()">
                <i class="fa-solid fa-check"></i> 关闭
            </button>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-header-top">
                    <div class="modal-title">
                        <span class="tag-cat green-tag" id="modal-title-tag">军事行动</span>
                        <span id="modal-title-text">台湾西部彰化县进入警备状态</span>
                    </div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-tabs">
                    <div class="tab-item active" id="tab-btn-details" onclick="switchTab('details')">关联分析</div>
                    <div class="tab-item" id="tab-btn-source" onclick="switchTab('source')">信息溯源</div>
                    <div class="tab-item" id="tab-btn-reasoning" onclick="switchTab('reasoning')">正向推理</div>
                </div>
            </div>
            <div class="modal-body">
                <div id="tab-details" class="tab-content active">
                    <div class="detail-section">
                        <div class="info-row">
                            <div class="info-label">时间范围</div>
                            <div class="info-value" id="modal-info-time">2025-11-23 06:23:38 ~ 2025-11-24 22:52:38</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">威胁等级</div>
                            <div class="info-value" id="modal-info-level"><span class="badge-orange">中等威胁</span></div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">数据统计</div>
                            <div class="info-value" id="modal-info-stats">数据总量 <span class="highlight">5612</span> 条 | 媒体总量 <span class="highlight">62</span> 个</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">情报摘要</div>
                            <div class="info-value" id="modal-info-summary">据多源情报综合分析，台湾西部彰化县地区出现异常军事调动，进入二级战备状态。监测到大量军用车辆集结，无线电通信频率激增。初步研判为针对近期海上演习的防御性部署，但不排除升级可能。建议加强该区域的持续监控，重点关注沿海雷达站及防空导弹阵地的动态。</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">关联标签</div>
                            <div class="info-value">
                                <div class="tag-list" id="modal-info-tags">
                                    <span class="badge-new-text">军事调动</span>
                                    <span class="badge-new-text">战备升级</span>
                                    <span class="badge-new-text">彰化县</span>
                                </div>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">多媒体资料</div>
                            <div class="info-value">
                                <div class="media-gallery" id="modal-media-gallery">
                                    <div class="media-item"><img src="images/6.png" alt="现场图1"></div>
                                    <div class="media-item"><img src="images/2.png" alt="现场图2"></div>
                                    <div class="media-item"><img src="images/3.png" alt="现场图3"></div>
                                    <div class="media-item"><img src="images/4.png" alt="现场图4"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="detail-section">
                        <div class="map-placeholder">
                            <iframe id="map-frame" src="https://maps.google.com/maps?hl=zh-CN&q=24.051,120.542&t=h&z=12&ie=UTF8&iwloc=&output=embed" width="100%" height="100%" style="border:0; position: absolute; top: 0; left: 0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                            <div class="map-controls-group">
                                <button class="map-btn-toggle active" id="btn-sat" onclick="toggleLayer('sat')"><i class="fa-solid fa-satellite"></i> 卫星影像</button>
                                <button class="map-btn-toggle" id="btn-road" onclick="toggleLayer('road')"><i class="fa-solid fa-road"></i> 道路网</button>
                            </div>
                            <div id="map-info-overlay" style="position: absolute; bottom: 20px; left: 20px; background: white; color: #1e293b; padding: 10px; border-radius: 8px; font-size: 12px; opacity: 0.9; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10;">
                                <strong>目标坐标:</strong> E 120.542, N 24.051<br>
                                <strong>覆盖范围:</strong> 50km²<br>
                                <strong>更新时间:</strong> 2025-11-23 06:30
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-source" class="tab-content">
                    <div class="trace-network" style="grid-column: 1 / -1;">

                        <div class="trace-col col-left">
                            <div class="col-header-trace"><span class="step-badge-sm">步骤一</span><i class="fa-solid fa-satellite-dish"></i> 实时情报收集</div>
                            <div class="trace-raw-list" id="trace-raw-list">
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-satellite blue-icon"></i> 卫星影像_20251123_001</span>
                                    <span class="raw-tag">影像</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-satellite blue-icon"></i> 卫星影像_20251123_002</span>
                                    <span class="raw-tag">影像</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-wifi green-icon"></i> 信号截获_A12_0625</span>
                                    <span class="raw-tag">信号</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-wifi green-icon"></i> 信号截获_B03_0628</span>
                                    <span class="raw-tag">信号</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-brands fa-twitter orange-icon"></i> 推特舆情_#彰化_01</span>
                                    <span class="raw-tag">开源</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-brands fa-facebook orange-icon"></i> 脸书讨论_现场_03</span>
                                    <span class="raw-tag">开源</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-user-secret purple-icon"></i> 人工报告_007_A1</span>
                                    <span class="raw-tag">人工</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-newspaper orange-icon"></i> 地方新闻_快讯_01</span>
                                    <span class="raw-tag">开源</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-walkie-talkie green-icon"></i> 通话记录_加密_09</span>
                                    <span class="raw-tag">信号</span>
                                </div>
                                <div class="trace-raw-item">
                                    <span><i class="fa-solid fa-satellite blue-icon"></i> 055型驱逐舰雷达影像_005</span>
                                    <span class="raw-tag">影像</span>
                                </div>
                            </div>
                        </div>
                        <div class="trace-col col-middle">
                            <div class="col-header-trace"><span class="step-badge-sm">步骤二</span><i class="fa-solid fa-microchip"></i> 融合分析处理</div>
                            <div class="trace-panel">
                                <div class="evidence-grid" id="trace-evidence-grid">
                                    <div class="trace-card small-card">
                                        <div class="t-icon icon-sat"><i class="fa-solid fa-satellite"></i></div>
                                        <div class="t-content">
                                            <div class="t-title">高分卫星 GF-7</div>
                                            <div class="t-desc">捕获彰化县沿海区域高分辨率光学影像</div>
                                        </div>
                                    </div>
                                    <div class="trace-card small-card">
                                        <div class="t-icon icon-sig"><i class="fa-solid fa-wifi"></i></div>
                                        <div class="t-content">
                                            <div class="t-title">信号监测站 A12</div>
                                            <div class="t-desc">截获加密无线电通信信号 (12.5GHz)</div>
                                        </div>
                                    </div>
                                    <div class="trace-card small-card">
                                        <div class="t-icon icon-web"><i class="fa-brands fa-twitter"></i></div>
                                        <div class="t-content">
                                            <div class="t-title">开源网络爬虫</div>
                                            <div class="t-desc">社交媒体"军车"相关讨论激增</div>
                                        </div>
                                    </div>
                                    <div class="trace-card small-card">
                                        <div class="t-icon icon-hum"><i class="fa-solid fa-user-secret"></i></div>
                                        <div class="t-content">
                                            <div class="t-title">人工情报员 007</div>
                                            <div class="t-desc">目击报告：基地警戒级别提升</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: center; margin-bottom: 10px;">
                                    <button style="background: #475569; border: 1px solid #5c6f8a; color: white; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer;">查看工作流</button>
                                </div>
                                <div id="trace-fusion-card" style="display:none;"></div>
                            </div>
                        </div>
                        <div class="trace-col col-right">
                            <div class="col-header-trace"><span class="step-badge-sm">步骤三</span><i class="fa-solid fa-file-signature"></i> 研判结论</div>
                            <div class="trace-panel">
                                <div class="result-card-full" style="border: none; box-shadow: none;" id="trace-result-card">
                                    <div class="result-header">
                                        <span class="result-tag">二级战备</span>
                                        <span style="font-size: 12px; color: #991b1b;"><i class="fa-solid fa-triangle-exclamation"></i> 高威胁</span>
                                    </div>
                                    <div class="result-body">
                                        <h4 class="result-title">台湾西部彰化县军事异常调动事件</h4>
                                        <div class="result-meta">
                                            <span><i class="fa-regular fa-clock"></i> 2025-11-23</span>
                                            <span><i class="fa-solid fa-location-dot"></i> 彰化县</span>
                                        </div>
                                        <div class="result-desc">
                                            基于卫星影像、信号截获及人工情报的综合研判，确认该区域正在进行非例行性大规模军事集结。建议立即启动针对性持续监控，并同步通报战区指挥部。
                                        </div>
                                        <div class="result-actions">
                                            <button class="btn-report">
                                                <i class="fa-solid fa-file-pdf"></i> 生成研判报告
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="tab-reasoning" class="tab-content">
                    <div class="reasoning-layout" style="grid-column: 1 / -1;">
                        <div class="reason-step">
                            <div class="step-header">
                                <span class="step-badge">阶段一</span>
                                <h3 style="margin:0; font-size: 16px; color: #ffffff;">当前态势</h3>
                            </div>
                            <div class="step-card" id="reasoning-step1-card">
                                <div class="card-icon"><i class="fa-solid fa-map-location-dot"></i></div>
                                <div class="card-content">
                                    <h4>彰化县军事异常调动</h4>
                                    <p>已确认大规模车辆集结与信号激增。</p>
                                </div>
                            </div>
                            <div class="step-details-inline" id="reasoning-step1-details">
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>数据接入</strong>
                                        <p>接收到来自 GF-7 卫星的高分辨率影像数据 (2025-11-23 06:23:38)</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>目标识别</strong>
                                        <p>AI 视觉模型识别出地面大量军用车辆集结，数量 > 50 辆</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>多源验证</strong>
                                        <p>关联 A12 信号监测站截获的加密无线电通信激增，确认目标活跃度</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>初步定性</strong>
                                        <p>根据时空吻合度，判定为非例行性军事集结事件</p>
                                    </div>
                                </div>
                            </div>
                            <div class="step-connector"><i class="fa-solid fa-arrow-right"></i></div>
                        </div>
                        <div class="reason-step">
                            <div class="step-header">
                                <span class="step-badge">阶段二</span>
                                <h3 style="margin:0; font-size: 16px; color: #ffffff;">意图分析</h3>
                            </div>
                            <div id="reasoning-step2-intents" style="margin-top:8px;">
                                <p style="margin: 0 0 6px 0; font-size: 13px; color: #cbd5e1; line-height: 1.5; text-align: justify;">
                                    东部战区美国两艘舰艇过航台湾海峡，综合轨迹与任务载荷分析，可能意图如下：
                                </p>
                                <div class="intent-list">
                                    <div class="intent-item" style="cursor:pointer;" onclick="openIntentWorkflow(this)">
                                        <div class="intent-left"><i class="fa-solid fa-magnifying-glass"></i><span>意图1：进行情报侦察</span></div>
                                        <div class="intent-badge green">概率 70%</div>
                                    </div>
                                    <div class="intent-progress"><div class="intent-progress-fill fill-70"></div></div>
                                    <div class="intent-item" style="cursor:pointer;" onclick="openIntentWorkflow(this)">
                                        <div class="intent-left"><i class="fa-solid fa-cloud-sun"></i><span>意图2：收集水文气象数据，为后续军事行动做准备</span></div>
                                        <div class="intent-badge yellow">概率 60%</div>
                                    </div>
                                    <div class="intent-progress"><div class="intent-progress-fill fill-60"></div></div>
                                    <div class="intent-item" style="cursor:pointer;" onclick="openIntentWorkflow(this)">
                                        <div class="intent-left"><i class="fa-solid fa-bullhorn"></i><span>意图3：展示存在，进行威慑</span></div>
                                        <div class="intent-badge slate">概率 50%</div>
                                    </div>
                                    <div class="intent-progress"><div class="intent-progress-fill fill-50"></div></div>
                                </div>
                            </div>
                            <div class="step-connector"><i class="fa-solid fa-arrow-right"></i></div>
                        </div>
                        <div class="reason-step">
                            <div class="step-header">
                                <span class="step-badge">阶段三</span>
                                <h3 style="margin:0; font-size: 16px; color: #ffffff;">事态预测</h3>
                            </div>
                            <div class="step-card result-card" id="reasoning-step3-card">
                                <div class="card-icon"><i class="fa-solid fa-crosshairs"></i></div>
                                <div class="card-content">
                                    <h4>未来 24 小时预测</h4>
                                    <ul class="prediction-list">
                                        <li><i class="fa-solid fa-circle-exclamation text-red"></i> 80% 概率：展开实弹射击演练</li>
                                        <li><i class="fa-solid fa-triangle-exclamation text-orange"></i> 15% 概率：提升至一级战备</li>
                                        <li><i class="fa-solid fa-info-circle text-blue"></i> 5% 概率：解除警报恢复常态</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="step-details-inline" id="reasoning-step3-details">
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>条令分析</strong>
                                        <p>依据敌方战术条令：集结后通常在 12-24 小时内展开实弹射击</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>环境因子</strong>
                                        <p>气象数据分析：未来 24 小时天气晴朗，适合海空联合行动</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>政治背景</strong>
                                        <p>结合近期外交紧张局势，提升威慑行动的可能性权重</p>
                                    </div>
                                </div>
                                <div class="detail-item">
                                    <div class="d-dot"></div>
                                    <div class="d-content">
                                        <strong>概率输出</strong>
                                        <p>推算出 80% 概率进行实弹演练，15% 概率升级为一级战备</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Intel Notification Popup -->
    <div id="intelPopup" class="intel-popup" onclick="focusOnShipIntel()" style="cursor: pointer;">
        <div class="popup-icon-box">
            <i class="fa-solid fa-bell"></i>
        </div>
        <div class="popup-content">
            <h4>情报推送提醒</h4>
            <p>系统收到 1 条新的高优先级情报，请注意查看。</p>
        </div>
        <i class="fa-solid fa-times popup-close" onclick="event.stopPropagation(); closeIntelPopup()"></i>
    </div>

    <script>
        // Global variables to store ship location for focus
        let shipFocusLat = 0;
        let shipFocusLng = 0;

        function focusOnShipIntel() {
            if (shipFocusLat !== 0 && shipFocusLng !== 0) {
                map.flyTo([shipFocusLat, shipFocusLng], 9, {
                    animate: true,
                    duration: 2
                });
                closeIntelPopup();
            }
        }

        function showTaskDetails(planId) {
            const modal = document.getElementById('planDetailModal');
            const titleEl = document.getElementById('plan-detail-title');
            const descEl = document.getElementById('plan-detail-desc');
            const simEl = document.getElementById('plan-simulation');
            const gantt = document.getElementById('ganttContainer');

            window._currentPlanId = planId;
            let plan;
            if (planId === 'plan-a') {
                plan = {
                    title: 'CH-4 彩虹无人机 · 全维域监视',
                    desc: '从最近基地起飞，巡航至目标海域上空，使用光电/红外吊舱与SAR雷达进行联合作业，按照“侦察→识别→跟踪→复核”链路闭环执行，实时回传态势数据。',
                    simulation: '预估侦察覆盖半径 50km，数据回传延迟 < 2s；若目标转向加速，改为轨迹预测并压缩航线维持持续监控。',
                    timelineStages: [
                        { label: '准备与起飞', steps: [
                            { label: '准备', hours: 0.6, color: 'green' },
                            { label: '起飞', hours: 0.4, color: 'blue' }
                        ]},
                        { label: '航渡至目标', steps: [
                            { label: '爬升', hours: 0.5, color: 'blue' },
                            { label: '巡航', hours: 1.0, color: 'blue' },
                            { label: '降至作业高度', hours: 0.5, color: 'blue' }
                        ]},
                        { label: '监视执行', steps: [
                            { label: '侦察', hours: 1.5, color: 'orange' },
                            { label: '识别', hours: 1.5, color: 'orange' },
                            { label: '跟踪', hours: 2.0, color: 'orange' },
                            { label: '复核', hours: 1.0, color: 'orange' }
                        ]},
                        { label: '返航与复盘', steps: [
                            { label: '返航', hours: 0.6, color: 'green' },
                            { label: '复盘', hours: 0.4, color: 'green' }
                        ]}
                    ]
                };
                const confirmBtn = document.getElementById('plan-confirm-btn');
                if (confirmBtn) confirmBtn.style.display = 'inline-block';
                const editBtn = document.getElementById('plan-edit-btn');
                if (editBtn) editBtn.style.display = 'inline-block';
                const uavCard = document.getElementById('uavCard');
                if (uavCard) uavCard.style.display = 'none';
            } else if (planId === 'plan-b') {
                plan = {
                    title: '052D 驱逐舰 · 警告驱离',
                    desc: '就近驱逐舰编队出动，保持安全距离伴航，使用舰载雷达与声呐进行目标识别与跟踪，适时通过甚高频无线电发出警告并实施战术压制。',
                    simulation: '预估抵达时间 24h；若对方拒不改向，实施编队变位与声呐干扰，配合空中监视实现立体压制。',
                    timelineStages: [
                        { label: '战备与起航', steps: [
                            { label: '战备', hours: 2, color: 'green' },
                            { label: '起航', hours: 2, color: 'blue' }
                        ]},
                        { label: '航渡与会合', steps: [
                            { label: '航渡', hours: 8, color: 'blue' },
                            { label: '会合', hours: 4, color: 'blue' }
                        ]},
                        { label: '伴航与警告', steps: [
                            { label: '伴航', hours: 4, color: 'orange' },
                            { label: '警告', hours: 2, color: 'orange' }
                        ]},
                        { label: '返航与评估', steps: [
                            { label: '返航', hours: 1, color: 'green' },
                            { label: '评估', hours: 1, color: 'green' }
                        ]}
                    ]
                };
                const confirmBtn = document.getElementById('plan-confirm-btn');
                if (confirmBtn) confirmBtn.style.display = 'none';
                const editBtn = document.getElementById('plan-edit-btn');
                if (editBtn) editBtn.style.display = 'none';
            } else if (planId === 'plan-c') {
                plan = {
                    title: '继续观察 · 卫星监测强化',
                    desc: '通过加强IGSO与SAR卫星排班，提升区域覆盖与成像频率，定期回传监测结果并进行图像解译与目标复核。',
                    simulation: '建议维持目标区域的24h覆盖，间隔2h成像，若发现异常航迹或姿态变化，切换到高频监视模式。',
                    timelineStages: [
                        { label: '卫星排班', steps: [
                            { label: '排班配置', hours: 1, color: 'blue' },
                            { label: '覆盖评估', hours: 1, color: 'blue' }
                        ]},
                        { label: '监测执行', steps: [
                            { label: '成像', hours: 3, color: 'orange' },
                            { label: '解译', hours: 2, color: 'orange' }
                        ]},
                        { label: '复核与报告', steps: [
                            { label: '复核', hours: 1, color: 'green' },
                            { label: '报告', hours: 1, color: 'green' }
                        ]}
                    ]
                };
                const confirmBtn = document.getElementById('plan-confirm-btn');
                if (confirmBtn) confirmBtn.style.display = 'none';
                const editBtn = document.getElementById('plan-edit-btn');
                if (editBtn) editBtn.style.display = 'none';
            }

            const solutionCard = document.getElementById('solutionCard');
            if (solutionCard) solutionCard.style.display = 'none';
            const uavCardHide = document.getElementById('uavCard');
            if (uavCardHide) uavCardHide.style.display = 'none';

            window._currentPlanObj = plan;
            window._planEls = { titleEl, descEl, simEl, gantt };

            titleEl.textContent = plan.title;
            descEl.textContent = plan.desc;
            gantt.innerHTML = '';
            const stages = plan.timelineStages || [];
            let cursor = 0;
            const stagesAbs = stages.map(stage => {
                const steps = stage.steps.map(st => {
                    const s = cursor;
                    const e = cursor + st.hours;
                    cursor = e;
                    return { label: st.label, start: s, end: e, color: st.color || 'blue' };
                });
                return { label: stage.label, start: steps[0].start, end: steps[steps.length - 1].end, steps };
            });
            const totalH = cursor;
            const axis = document.createElement('div');
            axis.className = 'gantt-axis';
            const tickStep = totalH <= 8 ? 1 : (totalH <= 16 ? 2 : 4);
            const base = new Date();
            for (let h = 0; h <= totalH; h += tickStep) {
                const tick = document.createElement('div');
                tick.className = 'gantt-axis-tick';
                tick.style.left = Math.round((h / totalH) * 100) + '%';
                const t = new Date(base.getTime() + h * 3600 * 1000);
                const hh = String(t.getHours()).padStart(2, '0');
                const mm = String(t.getMinutes()).padStart(2, '0');
                tick.textContent = hh + ':' + mm;
                axis.appendChild(tick);
            }
            gantt.appendChild(axis);
            stagesAbs.forEach(stage => {
                const row = document.createElement('div');
                row.className = 'gantt-row';
                const label = document.createElement('div');
                label.className = 'gantt-label';
                label.textContent = stage.label;
                const wrap = document.createElement('div');
                wrap.className = 'gantt-stage-wrap';
                const bar = document.createElement('div');
                bar.className = 'gantt-stage-bar';
                bar.style.left = Math.round((stage.start / totalH) * 100) + '%';
                bar.style.width = Math.round(((stage.end - stage.start) / totalH) * 100) + '%';
                const stageTotal = stage.end - stage.start;
                wrap.appendChild(bar);
                row.appendChild(label);
                row.appendChild(wrap);
                gantt.appendChild(row);
            });

            if (simEl._timer) { clearTimeout(simEl._timer); simEl._timer = null; }
            simEl.innerHTML = '';
            const simDesc = document.createElement('div');
            simDesc.textContent = plan.simulation;
            simDesc.style.marginBottom = '8px';
            simDesc.style.color = '#cbd5e1';
            simDesc.style.fontSize = '12px';
            const mapWrap = document.createElement('div');
            mapWrap.className = 'sim-map-wrap';
            let simStart = { lat: 24.25, lng: 118.10 };
            let simTarget = { lat: 25.260555, lng: 125.003055 };
            const iframe = document.createElement('iframe');
            iframe.src = 'https://www.google.com/maps?hl=zh-CN&q=' + simTarget.lat + ',' + simTarget.lng + '&z=6&output=embed';
            mapWrap.appendChild(iframe);
            const dot = document.createElement('div');
            dot.className = 'sim-route-dot';
            dot.style.animationDuration = totalH + 's';
            dot.style.animationName = 'routeMove';
            mapWrap.appendChild(dot);
            const startLab = document.createElement('div');
            startLab.className = 'sim-label';
            startLab.style.left = '10%';
            startLab.textContent = '起飞点 (CH-4)';
            mapWrap.appendChild(startLab);
            const targetLab = document.createElement('div');
            targetLab.className = 'sim-label';
            targetLab.style.left = '80%';
            targetLab.textContent = '目标点 (25°15\'38"N, 125°00\'11"E)';
            mapWrap.appendChild(targetLab);
            const status = document.createElement('div');
            status.style.marginTop = '8px';
            status.style.fontSize = '12px';
            status.style.color = '#94a3b8';
            simEl.appendChild(simDesc);
            simEl.appendChild(mapWrap);
            simEl.appendChild(status);
            const flat = stagesAbs.flatMap(st => st.steps.map(s => ({ label: s.label, hours: (s.end - s.start) })));
            function advance(i) {
                status.textContent = '当前阶段：' + flat[i].label;
                if (i + 1 < flat.length) {
                    simEl._timer = setTimeout(() => advance(i + 1), flat[i].hours * 1000);
                }
            }
            if (flat.length > 0) advance(0);

            modal.style.display = 'flex';
        }

        function closePlanDetail() {
            document.getElementById('planDetailModal').style.display = 'none';
        }

        function openReportModal() {
            const data = intelData[currentIntelIndex] || {};
            const modal = document.getElementById('reportModal');
            const t = document.getElementById('report-title');
            const s = document.getElementById('report-summary');
            const a = document.getElementById('report-actions');
            const r = document.getElementById('report-resources');
            const tl = document.getElementById('report-timeline');
            const rm = document.getElementById('report-remarks');
            const title = (data.title || '预案报告') + ' · 草稿';
            const summary = '根据当前情报生成的预案报告草稿，可在下方进行修改与完善。';
            const actions = ['准备与起飞','航渡至目标','监视执行','返航与复盘'].map((x,i)=> (i+1)+'. '+x).join('\n');
            const resources = '空中监视资源、海面力量、卫星排班与通信保障。';
            const timeline = '预计执行时长 8-24 小时，按阶段推进。';
            const remarks = '本报告为系统自动生成草稿，需值班员审核。';
            window._reportObj = { title, summary, actions, resources, timeline, remarks };
            if (t) t.value = title;
            if (s) s.value = summary;
            if (a) a.value = actions;
            if (r) r.value = resources;
            if (tl) tl.value = timeline;
            if (rm) rm.value = remarks;
            modal.style.display = 'flex';
        }

        function saveReportChanges() {
            const t = document.getElementById('report-title');
            const s = document.getElementById('report-summary');
            const a = document.getElementById('report-actions');
            const r = document.getElementById('report-resources');
            const tl = document.getElementById('report-timeline');
            const rm = document.getElementById('report-remarks');
            window._reportObj = {
                title: t ? t.value : '',
                summary: s ? s.value : '',
                actions: a ? a.value : '',
                resources: r ? r.value : '',
                timeline: tl ? tl.value : '',
                remarks: rm ? rm.value : ''
            };
        }

        function closeReportModal() {
            const modal = document.getElementById('reportModal');
            if (modal) modal.style.display = 'none';
        }

        function populateIntelSendFields() {
            const toEl = document.getElementById('brief-to');
            const ccEl = document.getElementById('brief-cc');
            const subjectEl = document.getElementById('brief-subject');
            const docCenterEl = document.getElementById('doc-center');
            const docNumberEl = document.getElementById('doc-number');
            const docDateEl = document.getElementById('doc-date');
            const docHeadlineEl = document.getElementById('doc-headline');
            const docParagraphEl = document.getElementById('doc-paragraph');
            const docListEl = document.getElementById('doc-list');
            const docImageEl1 = document.getElementById('doc-image-1');
            const docImageEl2 = document.getElementById('doc-image-2');
            const docCaptionEl = document.getElementById('doc-caption');
            const docFooterLeft = document.getElementById('doc-footer-left');
            const docFooterRight = document.getElementById('doc-footer-right');
            const data = (typeof intelData !== 'undefined' && intelData[currentIntelIndex]) ? intelData[currentIntelIndex] : {};
            const now = new Date();
            const y = now.getFullYear();
            const m = now.getMonth() + 1;
            const d = now.getDate();
            if (toEl) toEl.value = '指挥中心-主任-指挥席, 东部战区-海军部队-火力席';
            if (ccEl) ccEl.value = '情报中心-分析员-情报席, 态势席-值班军官-态势席, 国防动员分中心';
            if (subjectEl) subjectEl.value = '机要传真：' + (data.title || '处置方案');
            if (docCenterEl) docCenterEl.textContent = '指控席';
            if (docNumberEl) docNumberEl.textContent = `（${y}）XX号`;
            if (docDateEl) docDateEl.textContent = `${y}年${m}月${d}日`;
            if (docHeadlineEl) docHeadlineEl.textContent = '处置美军“鲍迪奇”号、“约翰逊”号舰船进入台湾海峡北区域方案';
            if (docParagraphEl) {
                docParagraphEl.textContent = '东部海军部队：现发现美军“鲍迪奇”号、“约翰逊”号舰船位于东经 125°01\'35"，北纬 24°49\'27"，正向东南方向航行，航速 12 节。研判其将采取 无人机低空持续侦察行动，对我存在突袭威胁。处置应对如下：';
            }
            if (docListEl) {
                const items = [
                    '一、由东部战区海军部队出动CH-4彩虹型无人机 2 架，经台湾海峡自西北至东南路线进行跟踪侦察，持续研判动向。',
                    '二、国防动员分中心做好舆情处置与信息发布准备。',
                    '三、后续根据态势变化及时调整方案并续报。'
                ];
                docListEl.innerHTML = items.map(t => '<div>'+t+'</div>').join('');
            }
            if (docFooterLeft) docFooterLeft.textContent = '主办：指控席';
            if (docFooterRight) docFooterRight.textContent = '发送：指挥席、东部战区海军部队、国防动员分中心';
            if (docImageEl1) { docImageEl1.src = ''; }
            if (docImageEl2) { docImageEl2.src = ''; }
            if (docCaptionEl) docCaptionEl.textContent = '';
            renderTags('brief-to','brief-to-tags');
            renderTags('brief-cc','brief-cc-tags');
        }
        function openIntelSendModal() {
            const modal = document.getElementById('intelSendModal');
            populateIntelSendFields();
            if (modal) modal.style.display = 'flex';
        }
        function openInstructionFileModal(file) {
            const modal = document.getElementById('instructionFileModal');
            const t = document.getElementById('instruction-file-title');
            if (t) t.textContent = file && file.title ? file.title : '上级指示文件';
            const dt = v => (v == null || v === '') ? '—' : v;
            const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = dt(v); };
            setText('instr-doc-title', file && file.docTitle);
            setText('instr-doc-center', file && file.center);
            setText('instr-doc-date', file && file.date);
            setText('instr-doc-headline', file && file.headline);
            const para = document.getElementById('instr-doc-paragraph');
            if (para) para.textContent = dt(file && file.paragraph);
            const img1 = document.getElementById('instr-doc-image-1');
            const img2 = document.getElementById('instr-doc-image-2');
            if (img1) {
                if (file && file.image1) { img1.src = file.image1; img1.style.display = 'block'; } else { img1.src = ''; img1.style.display = 'none'; }
            }
            if (img2) {
                if (file && file.image2) { img2.src = file.image2; img2.style.display = 'block'; } else { img2.src = ''; img2.style.display = 'none'; }
            }
            setText('instr-doc-caption', file && file.caption);
            setText('instr-extra-footer-left', file && file.extraFooterLeft);
            setText('instr-extra-footer-right', file && file.extraFooterRight);
            setText('instr-extra-title', file && file.extraTitle);
            const extraList = document.getElementById('instr-extra-list');
            if (extraList) {
                const arr = (file && Array.isArray(file.extraList)) ? file.extraList : [];
                extraList.innerHTML = arr.map(x => '<li>'+x+'</li>').join('');
            }
            if (modal) modal.style.display = 'flex';
        }
        function closeInstructionFileModal() {
            const modal = document.getElementById('instructionFileModal');
            if (modal) modal.style.display = 'none';
        }
        function closeIntelSendModal() {
            const modal = document.getElementById('intelSendModal');
            if (modal) modal.style.display = 'none';
        }
        function openIntelSendInline() {
            const card = document.getElementById('solutionCard');
            if (!card || card.getAttribute('data-fullscreen') !== 'true') { openIntelSendModal(); return; }
            const right = document.getElementById('solution-right-col');
            if (!right) { openIntelSendModal(); return; }
            let inline = document.getElementById('intel-send-inline');
            if (!inline) {
                inline = document.createElement('div');
                inline.id = 'intel-send-inline';
                inline.style.border = '1px solid #475569';
                inline.style.borderRadius = '6px';
                inline.style.background = 'rgba(255,255,255,0.05)';
                inline.style.padding = '8px';
                inline.style.marginTop = '8px';
                right.prepend(inline);
            }
            const modal = document.getElementById('intelSendModal');
            if (!modal) return;
            populateIntelSendFields();
            const header = modal.querySelector('.plan-detail-header');
            const body = modal.querySelector('.plan-detail-body');
            const footer = modal.lastElementChild;
            // Build a header clone to keep consistent visual
            let inlineHeader = document.getElementById('intel-send-inline-header');
            if (!inlineHeader) {
                inlineHeader = document.createElement('div');
                inlineHeader.id = 'intel-send-inline-header';
                inlineHeader.className = 'plan-detail-header';
                const title = document.createElement('span');
                title.textContent = '情报发送';
                const close = document.createElement('i');
                close.className = 'fa-solid fa-times';
                close.style.cursor = 'pointer';
                close.onclick = closeIntelSendInline;
                inlineHeader.appendChild(title);
                inlineHeader.appendChild(close);
                inline.appendChild(inlineHeader);
            }
            if (header) header.style.display = 'none';
            if (body) { body.style.maxHeight = '60vh'; body.style.overflowY = 'auto'; inline.appendChild(body); }
            if (footer) inline.appendChild(footer);
        }
        function closeIntelSendInline() {
            const inline = document.getElementById('intel-send-inline');
            const modal = document.getElementById('intelSendModal');
            if (!inline || !modal) return;
            const header = modal.querySelector('.plan-detail-header');
            const body = inline.querySelector('.plan-detail-body');
            const footer = inline.lastElementChild;
            if (header) header.style.display = '';
            if (body) modal.appendChild(body);
            if (footer && footer !== body) modal.appendChild(footer);
            inline.remove();
        }
        function formatDoc(cmd) {
            const editor = document.getElementById('doc-editor');
            if (!editor) return;
            editor.focus();
            document.execCommand(cmd, false, null);
        }
        function renderTags(inputId, containerId) {
            const input = document.getElementById(inputId);
            const wrap = document.getElementById(containerId);
            if (!input || !wrap) return;
            const raw = input.value || '';
            const parts = raw.split(/,|、/).map(s => s.trim()).filter(Boolean);
            wrap.innerHTML = parts.map(p => (
                '<span style="display:inline-block; padding:4px 8px; border-radius:999px; background: rgba(148,163,184,0.18); color:#e2e8f0; border:1px solid rgba(148,163,184,0.35); font-size:12px;">' + p + '</span>'
            )).join('');
        }
        function applyFontSize() {
            const sel = document.getElementById('font-size-select');
            const editor = document.getElementById('doc-editor');
            if (!sel || !editor) return;
            const px = sel.value;
            const selObj = window.getSelection();
            if (selObj && selObj.rangeCount > 0) {
                const range = selObj.getRangeAt(0);
                let node = range.startContainer.nodeType === 1 ? range.startContainer : range.startContainer.parentElement;
                if (node && editor.contains(node)) {
                    node.style.fontSize = px + 'px';
                    return;
                }
            }
            editor.style.fontSize = px + 'px';
        }
        function sendIntelBrief() {
            const modal = document.getElementById('intelSendModal');
            if (modal) modal.style.display = 'none';
            const inline = document.getElementById('intel-send-inline');
            if (inline) closeIntelSendInline();
            const popup = document.getElementById('intelPopup');
            const content = popup ? popup.querySelector('.popup-content') : null;
            if (content) { content.innerHTML = '<h4>发送成功</h4><p>已发送至收件人与抄送列表</p>'; }
            if (popup) { popup.classList.add('show'); setTimeout(() => { closeIntelPopup(); }, 3000); }
            const targetInput = document.getElementById('target-coords');
            if (typeof currentTargetLat === 'undefined' || typeof currentTargetLng === 'undefined') {
                let lat, lng;
                if (typeof shipFocusLat !== 'undefined' && typeof shipFocusLng !== 'undefined') {
                    lat = shipFocusLat; lng = shipFocusLng;
                    if (window._shipVectorDeg) {
                        const dxDeg = window._shipVectorDeg.dx;
                        const dyDeg = window._shipVectorDeg.dy;
                        const kmLat = 111.32;
                        const kmLon = 111.32 * Math.cos(lat * Math.PI / 180);
                        const vxKm = dxDeg * kmLat;
                        const vyKm = dyDeg * kmLon;
                        const magKm = Math.sqrt(vxKm * vxKm + vyKm * vyKm);
                        if (magKm > 0) {
                            const scale = 40 / magKm;
                            const dLat = dxDeg * scale;
                            const dLng = dyDeg * scale;
                            lat = lat + dLat;
                            lng = lng + dLng;
                        }
                    }
                } else if (typeof map !== 'undefined') {
                    const c = map.getCenter();
                    lat = c.lat; lng = c.lng;
                } else {
                    lat = 23.7; lng = 121.0;
                }
                if (targetInput) targetInput.value = `${lat.toFixed(4)}°N, ${lng.toFixed(4)}°E`;
                currentTargetLat = lat;
                currentTargetLng = lng;
            }
            setTimeout(() => {
                if (typeof selectionLayerGroup !== 'undefined') {
                    selectionLayerGroup.clearLayers();
                    flightPathLayerGroup.clearLayers();
                    if (typeof currentTargetLat !== 'undefined' && typeof currentTargetLng !== 'undefined') {
                        L.marker([currentTargetLat, currentTargetLng], { icon: blueMarkerIcon }).addTo(selectionLayerGroup);
                        L.circle([currentTargetLat, currentTargetLng], {
                            radius: 20000,
                            color: '#3b82f6',
                            dashArray: '10, 10',
                            fillColor: '#3b82f6',
                            fillOpacity: 0.1,
                            weight: 2
                        }).addTo(selectionLayerGroup);
                        if (typeof analyzeRecommendations === 'function') {
                            analyzeRecommendations(currentTargetLat, currentTargetLng);
                        }
                    }
                }
                const ch4Opt = document.getElementById('opt-uav-01');
                if (ch4Opt && typeof selectUav === 'function') {
                    selectUav(ch4Opt, 'uav-01');
                } else if (typeof updateFlightPath === 'function') {
                    updateFlightPath('uav-01');
                }
                if (typeof recalcUavRouteStats === 'function') recalcUavRouteStats();
                if (typeof fitMapToUavRoute === 'function') fitMapToUavRoute(document.getElementById('selected-uav-id')?.value || 'uav-01');
                setTimeout(() => {
                    if (typeof dispatchUav === 'function') {
                        dispatchUav();
                    }
                }, 2000);
            }, 3000);
        }
        function fitMapToUavRoute(uavId) {
            if (typeof map === 'undefined') return;
            const base = (typeof uavBases !== 'undefined') ? uavBases[uavId] : null;
            if (!base || typeof currentTargetLat === 'undefined' || typeof currentTargetLng === 'undefined') return;
            let pts = [[base.lat, base.lng], [currentTargetLat, currentTargetLng]];
            if (Array.isArray(window._uavWaypoints) && window._uavWaypoints.length > 0) {
                pts = [[base.lat, base.lng], ...window._uavWaypoints, [currentTargetLat, currentTargetLng]];
            }
            const routed = (typeof routeAroundLand === 'function') ? routeAroundLand(pts) : pts;
            const bounds = L.latLngBounds(routed.map(p => L.latLng(p[0], p[1])));
            map.fitBounds(bounds, { padding: [30, 30] });
        }
        function initCaseLib() {
            window._caseLibMatches = [
                { id: 'case-2024-06', title: '美国海军舰队过航台湾海峡', date: '2023/03/27', similarity: 0.86, meta: '驱逐舰单舰过航，航速 14 节', desc: '按常态化通行进行，台方伴航监视；我方保持监视与态势播报。', eventId: 'GKXW_0001', eventLink: 'https://www.163.com/dy/article/I0RS1JJE05149512.html', category: '公开新闻', publishTime: '2023/03/27 08:00', structInfo: '“鲍迪奇”号海洋测量船在2022/03/25累计在南海的活动时长达205舰日，进行海底地形地貌探测以及海洋气象水文调查；并且美军先后在南海部署四艘海洋监视船。', threat: '中等紧张' },
                { id: 'case-2023-04', title: '美国驱逐舰例行过航台湾海峡', date: '2024/08/23', similarity: 0.78, meta: '驱逐舰过航并实施战术转向', desc: '我方实施空面联合监视，岸基雷达加强覆盖，未发生冲突事件。', eventId: 'GKXW_0002', eventLink: 'https://news.qq.com/rain/a/20240823A05XB200', category: '公开新闻', publishTime: '2024/08/23 09:30', structInfo: '2024年8月22日，美国海军驱逐舰“拉尔夫·约翰逊”号穿越了台湾海峡并公开炒作。中国人民解放军东部战区组织海空兵力对美舰过航行动全程跟监警戒，依法依规处置。', threat: '一般紧张' },
                { id: 'case-2021-09', title: '美测量船经台海穿越', date: '2021-09-23', similarity: 0.72, meta: '测量船配合保障舰', desc: '以采集海洋水文数据为主，我方实施伴随监视与电磁侦察。', eventId: 'QXBG_0003', category: '前线报告', publishTime: '2021-09-23 11:10', structInfo: '测量船+保障舰 + 台湾海峡 + 2021-09-23 + 水文采集 + 伴随监视', threat: '低度紧张' }
            ];
            const list = document.getElementById('case-list');
            if (!list) return;
            list.innerHTML = window._caseLibMatches.map(c => (
                '<div onclick="openCaseDetail(\''+c.id+'\')" style="display:flex; align-items:center; gap:8px; border:1px solid #475569; border-radius:4px; padding:8px; cursor:pointer; background: rgba(255,255,255,0.04);">' +
                '<div class="recommend-badge" style="background: rgba(16,185,129,0.2); color:#10b981; border:1px solid rgba(16,185,129,0.4);">相似度 '+ Math.round(c.similarity*100) +'%</div>' +
                '<div style="flex:1; color:#e2e8f0; font-size:13px;">'+ c.title +'</div>' +
                '<div style="color:#94a3b8; font-size:12px;">'+ c.date +'</div>' +
                '</div>'
            )).join('');
        }

        function openCaseDetail(id) {
            const c = (window._caseLibMatches || []).find(x => x.id === id);
            if (!c) return;
            const modal = document.getElementById('caseDetailModal');
            const titleEl = document.getElementById('case-detail-title');
            const metaEl = document.getElementById('case-detail-meta');
            const descEl = document.getElementById('case-detail-desc');
            const idEl = document.getElementById('case-detail-id');
            const catEl = document.getElementById('case-detail-category');
            const timeEl = document.getElementById('case-detail-time');
            const structEl = document.getElementById('case-detail-struct');
            const threatEl = document.getElementById('case-detail-threat');
            if (titleEl) titleEl.textContent = c.title;
            if (metaEl) metaEl.textContent = '日期：' + c.date + '｜特征：' + (c.meta || '—');
            if (descEl) descEl.textContent = c.desc || '—';
            if (idEl) {
                if (c.eventLink && c.eventId) {
                    idEl.innerHTML = '<a href="'+c.eventLink+'" target="_blank" rel="noopener noreferrer" style="color:#3b82f6; text-decoration:underline; cursor:pointer;" onmouseover="this.style.color=\'#60a5fa\'; this.style.background=\'rgba(59,130,246,0.15)\'; this.style.borderRadius=\'4px\'; this.style.padding=\'0 2px\';" onmouseout="this.style.color=\'#3b82f6\'; this.style.background=\'transparent\'; this.style.padding=\'0 0\';">'+c.eventId+'</a>';
                } else {
                    idEl.textContent = c.eventId || '—';
                }
            }
            if (catEl) catEl.textContent = c.category || '—';
            if (timeEl) timeEl.textContent = c.publishTime || c.date || '—';
            if (structEl) structEl.textContent = c.structInfo || (c.title + '｜' + (c.meta || '—'));
            if (threatEl) threatEl.textContent = c.threat || '—';
            modal.style.display = 'flex';
            setCaseStatsMode('year');
            const chart = document.getElementById('case-stats-chart');
            if (chart) {
                const existing = document.getElementById('case-situation-map');
                if (existing) existing.remove();
                const section = chart.parentNode;
                let row = document.getElementById('case-insights-row');
                if (!row) {
                    row = document.createElement('div');
                    row.id = 'case-insights-row';
                    row.style.display = 'grid';
                    row.style.gridTemplateColumns = '1fr 1fr';
                    row.style.gap = '8px';
                    row.style.alignItems = 'start';
                    const left = document.createElement('div');
                    left.id = 'case-insights-left';
                    const right = document.createElement('div');
                    right.id = 'case-insights-right';
                    row.appendChild(left);
                    row.appendChild(right);
                    section.appendChild(row);
                }
                const leftCol = document.getElementById('case-insights-left');
                const rightCol = document.getElementById('case-insights-right');
                if (leftCol && chart.parentNode !== leftCol) {
                    leftCol.appendChild(chart);
                    chart.style.width = '100%';
                    chart.style.height = '260px';
                    chart.style.minHeight = '260px';
                    chart.style.boxSizing = 'border-box';
                    const headerRow = chart.previousElementSibling;
                    if (headerRow && headerRow.style) headerRow.style.display = 'none';
                    let leftHeader = document.getElementById('case-stats-left-header');
                    if (!leftHeader) {
                        leftHeader = document.createElement('div');
                        leftHeader.id = 'case-stats-left-header';
                        leftHeader.style.display = 'flex';
                        leftHeader.style.flexDirection = 'column';
                        leftHeader.style.alignItems = 'center';
                        leftHeader.style.justifyContent = 'center';
                        leftHeader.style.gap = '6px';
                        leftHeader.style.marginBottom = '6px';
                        const h = document.createElement('h4');
                        h.textContent = '相关事件统计';
                        h.style.margin = '0';
                        h.style.color = '#e2e8f0';
                        h.style.fontSize = '14px';
                        h.style.textAlign = 'center';
                        const btns = document.createElement('div');
                        btns.style.display = 'flex';
                        btns.style.gap = '6px';
                        btns.style.alignItems = 'center';
                        btns.style.justifyContent = 'center';
                        const by = document.getElementById('case-stats-btn-year');
                        const bm = document.getElementById('case-stats-btn-month');
                        const br = document.getElementById('case-stats-btn-region');
                        if (by) btns.appendChild(by);
                        if (bm) btns.appendChild(bm);
                        if (br) btns.appendChild(br);
                        leftHeader.appendChild(h);
                        leftHeader.appendChild(btns);
                        leftCol.prepend(leftHeader);
                    }
                }
                const wrap = document.createElement('div');
                wrap.id = 'case-situation-map';
                const title = document.createElement('h4');
                title.textContent = '应对' + (c.title || 'XX') + '事件态势图';
                title.style.margin = '0';
                title.style.color = '#000000';
                title.style.fontSize = '14px';
                const box = document.createElement('div');
                box.style.border = '1px solid #475569';
                box.style.borderRadius = '6px';
                box.style.padding = '0';
                box.style.background = 'rgba(255,255,255,0.05)';
                box.style.position = 'relative';
                title.style.position = 'absolute';
                title.style.top = '10px';
                title.style.left = '0';
                title.style.right = '0';
                title.style.textAlign = 'center';
                title.style.fontWeight = 'bold';
                const img = document.createElement('img');
                img.src = 'images/态势图1.png';
                img.alt = '应对事件态势图';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.maxHeight = '320px';
                img.style.objectFit = 'contain';
                img.style.borderRadius = '4px';
                box.style.height = '320px';
                box.style.overflow = 'hidden';
                box.appendChild(title);
                box.appendChild(img);
                wrap.appendChild(box);
                if (rightCol) {
                    const prev = document.getElementById('case-situation-map');
                    if (prev && prev.parentNode === rightCol) prev.remove();
                    rightCol.appendChild(wrap);
                } else {
                    chart.parentNode.insertBefore(wrap, chart.nextSibling);
                }
            }
        }

        function closeCaseDetail() {
            const modal = document.getElementById('caseDetailModal');
            if (modal) modal.style.display = 'none';
        }

        function setCaseStatsMode(mode) {
            window._caseStatsMode = mode;
            const btnYear = document.getElementById('case-stats-btn-year');
            const btnMonth = document.getElementById('case-stats-btn-month');
            const btnRegion = document.getElementById('case-stats-btn-region');
            const all = [btnYear, btnMonth, btnRegion];
            all.forEach(b => { if (b) { b.style.background = '#475569'; b.style.border = '1px solid #5c6f8a'; } });
            if (mode === 'year' && btnYear) { btnYear.style.background = '#3b82f6'; btnYear.style.border = '1px solid #60a5fa'; }
            if (mode === 'month' && btnMonth) { btnMonth.style.background = '#3b82f6'; btnMonth.style.border = '1px solid #60a5fa'; }
            if (mode === 'region' && btnRegion) { btnRegion.style.background = '#3b82f6'; btnRegion.style.border = '1px solid #60a5fa'; }
            renderCaseStatsChart();
        }

        function renderCaseStatsChart() {
            const cont = document.getElementById('case-stats-chart');
            if (!cont) return;
            const data = Array.isArray(window._caseLibMatches) ? window._caseLibMatches : [];
            let buckets = {};
            const mode = window._caseStatsMode || 'year';
            for (let i = 0; i < data.length; i++) {
                const c = data[i];
                const d = String(c.publishTime || c.date || '').replace(/年|月|日|\/|-/g, '-');
                let key = '';
                if (mode === 'year') {
                    const y = d.split('-')[0] || '未知';
                    key = y;
                } else if (mode === 'month') {
                    const parts = d.split('-');
                    const y = parts[0] || '未知';
                    const m = parts[1] || '未知';
                    key = y + '-' + m;
                } else {
                    const s = String(c.structInfo || c.title || '');
                    if (s.indexOf('台湾海峡') >= 0) key = '台湾海峡';
                    else if (s.indexOf('南海') >= 0) key = '南海';
                    else if (s.indexOf('东海') >= 0) key = '东海';
                    else key = '其他区域';
                }
                buckets[key] = (buckets[key] || 0) + 1;
            }
            const entries = Object.keys(buckets).sort().map(k => ({ k, v: buckets[k] }));
            const maxV = entries.reduce((m, e) => Math.max(m, e.v), 0) || 1;
            cont.style.overflow = 'auto';
            const label = mode === 'year' ? '年份' : (mode === 'month' ? '年月' : '区域');
            let html = ''+
            '<table style="width:100%; border-collapse:collapse; font-size:12px; color:#e2e8f0;">'+
                '<thead>'+
                    '<tr style="background:rgba(15,23,42,0.8);">'+
                        '<th style="text-align:left; padding:8px 10px; font-weight:600; border-bottom:1px solid rgba(148,163,184,0.6);">'+label+'</th>'+
                        '<th style="text-align:right; padding:8px 10px; font-weight:600; border-bottom:1px solid rgba(148,163,184,0.6);">数量</th>'+
                    '</tr>'+
                '</thead>'+
                '<tbody>';
            for (let i = 0; i < entries.length; i++) {
                const e = entries[i];
                const zebra = i % 2 === 0 ? 'rgba(15,23,42,0.6)' : 'rgba(15,23,42,0.4)';
                const w = Math.round((e.v / maxV) * 100);
                html += ''+
                    '<tr style="background:'+zebra+';">'+
                        '<td style="padding:8px 10px; border-bottom:1px solid rgba(148,163,184,0.3);">'+e.k+'</td>'+
                        '<td style="padding:8px 10px; border-bottom:1px solid rgba(148,163,184,0.3); text-align:right;">'+
                            '<div style="display:flex; align-items:center; gap:8px; justify-content:flex-end;">'+
                                '<span>'+e.v+'</span>'+
                                '<div style="width:120px; height:8px; background:rgba(148,163,184,0.18); border:1px solid rgba(148,163,184,0.35); border-radius:4px; overflow:hidden;">'+
                                    '<div style="width:'+w+'%; height:100%; background:linear-gradient(90deg, #3b82f6, #60a5fa);"></div>'+
                                '</div>'+
                            '</div>'+
                        '</td>'+
                    '</tr>';
            }
            html += '</tbody></table>';
            cont.innerHTML = html;
        }

        function openIntentWorkflow(el) {
            const titleEl = document.getElementById('intent-workflow-title');
            const agentEl = document.getElementById('intent-workflow-agent');
            const casesEl = document.getElementById('intent-workflow-cases');
            const formEl = document.getElementById('intent-workflow-formation');
            const docEl = document.getElementById('intent-workflow-doctrine');
            const text = el && el.querySelector('.intent-left span') ? el.querySelector('.intent-left span').textContent : '—';
            if (titleEl) titleEl.textContent = '意图分析 · ' + text;
            if (agentEl) {
                agentEl.style.display = 'flex';
                agentEl.style.alignItems = 'stretch';
                agentEl.style.gap = '8px';
                const steps = [
                    {t:'数据接入',d:'接入雷达/光电/信号与开源数据'},
                    {t:'目标识别',d:'识别舰艇/编队与关键行为特征'},
                    {t:'多源融合',d:'融合航迹、信号与影像提高置信度'},
                    {t:'结论输出',d:'生成意图评估与处置建议'}
                ];
                let html = '';
                for (let i = 0; i < steps.length; i++) {
                    const x = steps[i];
                    html += (
                        '<div style="flex:1; border:1px solid #475569; border-radius:6px; padding:8px; background: rgba(255,255,255,0.05);">'+
                            '<div style="font-weight:bold; color:#e2e8f0; margin-bottom:4px;">'+x.t+'</div>'+
                            '<div style="font-size:12px; color:#94a3b8;">'+x.d+'</div>'+
                        '</div>'
                    );
                    if (i < steps.length - 1) {
                        html += (
                            '<div style="display:flex; align-items:center; justify-content:center; min-width:28px;">'+
                                '<i class="fa-solid fa-arrow-right" style="color:#94a3b8; font-size:16px;"></i>'+
                            '</div>'
                        );
                    }
                }
                agentEl.innerHTML = html;
            }
            if (casesEl) {
                casesEl.innerHTML = [
                    {title:'美军舰过航台湾海峡 · 2024-06-04',sim:0.86},
                    {title:'测量船配合保障舰穿越 · 2021-09-23',sim:0.72}
                ].map(c=>(
                    '<div style="display:flex; align-items:center; gap:8px; border:1px solid #475569; border-radius:6px; padding:8px; background: rgba(255,255,255,0.04);">'+
                        '<div class="recommend-badge" style="background: rgba(16,185,129,0.2); color:#10b981; border:1px solid rgba(16,185,129,0.4);">相似度 '+Math.round(c.sim*100)+'%</div>'+
                        '<div style="flex:1; color:#e2e8f0; font-size:13px;">'+c.title+'</div>'+
                    '</div>'
                )).join('');
            }
            if (formEl) {
                formEl.innerHTML = [
                    {name:'驱逐舰+测量船双舰编队',match:'高度匹配',color:'#10b981'},
                    {name:'单舰穿越',match:'一般匹配',color:'#f59e0b'}
                ].map(f=>(
                    '<div style="display:flex; justify-content:space-between; align-items:center; border:1px solid #475569; border-radius:6px; padding:8px; background: rgba(255,255,255,0.05);">'+
                        '<div style="color:#e2e8f0; font-size:13px;">'+f.name+'</div>'+
                        '<div style="font-size:12px; color:'+f.color+';">'+f.match+'</div>'+
                    '</div>'
                )).join('');
            }
            if (docEl) {
                const link = 'http://www.mod.gov.cn/gfbw/qwfb/16371493.html';
                docEl.innerHTML = [
                    {side:'我方条令',item:'沿海雷达站与空面联合监视'},
                    {side:'美方条令',item:'抵近侦察与水文数据采集'}
                ].map(d=>(
                    '<div style="border:1px solid #475569; border-radius:6px; padding:8px; background: rgba(255,255,255,0.05);">'+
                        '<div style="font-weight:bold; margin-bottom:4px;">'+
                            '<a href="'+link+'" target="_blank" rel="noopener noreferrer" style="color:#3b82f6; text-decoration:underline; cursor:pointer;" onmouseover="this.style.color=\'#60a5fa\'; this.style.background=\'rgba(59,130,246,0.15)\'; this.style.borderRadius=\'4px\'; this.style.padding=\'0 2px\';" onmouseout="this.style.color=\'#3b82f6\'; this.style.background=\'transparent\'; this.style.padding=\'0 0\';">'+d.side+'</a>'+
                        '</div>'+
                        '<div style="font-size:12px; color:#94a3b8;">'+d.item+'</div>'+
                    '</div>'
                )).join('');
            }
            const modal = document.getElementById('intentWorkflowModal');
            if (modal) modal.style.display = 'flex';
        }
        function closeIntentWorkflow() {
            const modal = document.getElementById('intentWorkflowModal');
            if (modal) modal.style.display = 'none';
        }
        function renderPlanOverview() {
            const data = intelData[currentIntelIndex] || {};
            const el = document.getElementById('plan-overview');
            if (!el) return;
            el.innerHTML = '符合 <span id="plan-article-23-link" onclick="openPlanArticle23()" style="color:#60a5fa; text-decoration:underline; cursor:pointer;">案例库第二十三</span> 条';
        }
        function openPlanArticle23() {
            const modal = document.getElementById('planArticleModal23');
            if (modal) modal.style.display = 'flex';
        }
        function closePlanArticle23() {
            const modal = document.getElementById('planArticleModal23');
            if (modal) modal.style.display = 'none';
        }
        function readRecommendTableData() {
            const sec = document.getElementById('plan-section-recommend');
            if (!sec) return [];
            const rows = sec.querySelectorAll('tbody tr');
            const data = [];
            rows.forEach(r => {
                const tds = r.querySelectorAll('td');
                if (tds.length >= 4) {
                    data.push({
                        time: tds[0].textContent.trim(),
                        cmd: tds[1].textContent.trim(),
                        intel: tds[2].textContent.trim(),
                        ops: tds[3].textContent.trim()
                    });
                }
            });
            return data;
        }
        function enableRecommendEdit() {
            const sec = document.getElementById('plan-section-recommend');
            if (!sec) return;
            const tbody = sec.querySelector('tbody');
            if (!tbody) return;
            window._planRecommendData = readRecommendTableData();
            tbody.innerHTML = '';
            (window._planRecommendData || []).forEach((row, i) => {
                const tr = document.createElement('tr');
                tr.style.background = i % 2 === 0 ? 'rgba(15,23,42,0.6)' : 'rgba(15,23,42,0.4)';
                const makeCell = (val, name) => {
                    const td = document.createElement('td');
                    td.style.padding = '8px 10px';
                    td.style.borderBottom = '1px solid rgba(148,163,184,0.4)';
                    const inp = document.createElement('input');
                    inp.type = 'text';
                    inp.value = val;
                    inp.name = name;
                    inp.style.width = '100%';
                    inp.style.background = 'rgba(0,0,0,0.2)';
                    inp.style.color = '#e2e8f0';
                    inp.style.border = '1px solid #5c6f8a';
                    inp.style.borderRadius = '4px';
                    inp.style.fontSize = '12px';
                    inp.style.padding = '6px 8px';
                    td.appendChild(inp);
                    return td;
                };
                tr.appendChild(makeCell(row.time, 'time'));
                tr.appendChild(makeCell(row.cmd, 'cmd'));
                tr.appendChild(makeCell(row.intel, 'intel'));
                tr.appendChild(makeCell(row.ops, 'ops'));
                tbody.appendChild(tr);
            });
            const ctrls = document.getElementById('recommend-edit-controls');
            if (ctrls) ctrls.style.display = 'flex';
        }
        function addRecommendRow() {
            const sec = document.getElementById('plan-section-recommend');
            if (!sec) return;
            const tbody = sec.querySelector('tbody');
            if (!tbody) return;
            const tr = document.createElement('tr');
            const idx = tbody.children.length;
            tr.style.background = idx % 2 === 0 ? 'rgba(15,23,42,0.6)' : 'rgba(15,23,42,0.4)';
            const mk = (ph, name) => {
                const td = document.createElement('td');
                td.style.padding = '8px 10px';
                td.style.borderBottom = '1px solid rgba(148,163,184,0.4)';
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.value = ph || '';
                inp.placeholder = ph || '';
                inp.name = name;
                inp.style.width = '100%';
                inp.style.background = 'rgba(0,0,0,0.2)';
                inp.style.color = '#e2e8f0';
                inp.style.border = '1px solid #5c6f8a';
                inp.style.borderRadius = '4px';
                inp.style.fontSize = '12px';
                inp.style.padding = '6px 8px';
                td.appendChild(inp);
                return td;
            };
            tr.appendChild(mk('T+?h', 'time'));
            tr.appendChild(mk('', 'cmd'));
            tr.appendChild(mk('', 'intel'));
            tr.appendChild(mk('', 'ops'));
            tbody.appendChild(tr);
        }
        function saveRecommendEdit() {
            const sec = document.getElementById('plan-section-recommend');
            if (!sec) return;
            const tbody = sec.querySelector('tbody');
            if (!tbody) return;
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const data = rows.map((r, i) => {
                const vals = {};
                r.querySelectorAll('input').forEach(inp => { vals[inp.name] = inp.value.trim(); });
                return { time: vals.time || '', cmd: vals.cmd || '', intel: vals.intel || '', ops: vals.ops || '' };
            });
            window._planRecommendData = data;
            tbody.innerHTML = '';
            data.forEach((row, i) => {
                const tr = document.createElement('tr');
                tr.style.background = i % 2 === 0 ? 'rgba(15,23,42,0.6)' : 'rgba(15,23,42,0.4)';
                const addCell = (val, nowrap) => {
                    const td = document.createElement('td');
                    td.style.padding = '8px 10px';
                    td.style.borderBottom = '1px solid rgba(148,163,184,0.4)';
                    if (nowrap) td.style.whiteSpace = 'nowrap';
                    td.textContent = val;
                    return td;
                };
                tbody.appendChild(tr);
                tr.appendChild(addCell(row.time, true));
                tr.appendChild(addCell(row.cmd));
                tr.appendChild(addCell(row.intel));
                tr.appendChild(addCell(row.ops));
            });
            const ctrls = document.getElementById('recommend-edit-controls');
            if (ctrls) ctrls.style.display = 'none';
        }
        function cancelRecommendEdit() {
            const sec = document.getElementById('plan-section-recommend');
            if (!sec) return;
            const tbody = sec.querySelector('tbody');
            if (!tbody) return;
            const data = window._planRecommendData || readRecommendTableData();
            tbody.innerHTML = '';
            data.forEach((row, i) => {
                const tr = document.createElement('tr');
                tr.style.background = i % 2 === 0 ? 'rgba(15,23,42,0.6)' : 'rgba(15,23,42,0.4)';
                const addCell = (val, nowrap) => {
                    const td = document.createElement('td');
                    td.style.padding = '8px 10px';
                    td.style.borderBottom = '1px solid rgba(148,163,184,0.4)';
                    if (nowrap) td.style.whiteSpace = 'nowrap';
                    td.textContent = val;
                    return td;
                };
                tbody.appendChild(tr);
                tr.appendChild(addCell(row.time, true));
                tr.appendChild(addCell(row.cmd));
                tr.appendChild(addCell(row.intel));
                tr.appendChild(addCell(row.ops));
            });
            const ctrls = document.getElementById('recommend-edit-controls');
            if (ctrls) ctrls.style.display = 'none';
        }

        function renderFishbone(targetId) {
            const cont = document.getElementById(targetId || 'fishbone-container');
            if (!cont) return;
            cont._rendered = true;
            cont.innerHTML = '';
            const cellW = 100;
            const labelW = 140;
            const rowsH = 44;
            const barColor = '#60a5fa';
            const rows = [
                { label: '指控席', items: [
                    { name: '形成并上报处置方案', start: 0.0, end: 0.5 },
                    { name: '监控态势与续报上报', start: 1.0, end: 12.0 },
                    { name: '情况总结，事件定调', start: 12.0, end: 12.5 }
                ]},
                { label: '战区火力席', items: [
                    { name: '派遣2架CH-4无人机前往', start: 0.5, end: 2.0 },
                    { name: 'CH-4无人持续监视', start: 2.0, end: 12.0 },
                    { name: '情况总结，事件定调', start: 12.0, end: 12.5 }
                ]},    
                { label: '情报席', items: [
                    { name: '研判态势/机要传真', start: 0.0, end: 1.5 },
                    { name: '跟踪进展/更新态势图', start: 1.5, end: 13 }
                ]},
                { label: '态势席', items: [
                    { name: '动态态势图更新', start: 1.0, end: 12.5 }
                ]},
                { label: '国动分中心', items: [
                    { name: '侦察力量与武装力量动员，拟文发表声明', start: 1.0, end: 13 }
                ]}
            ];
            const maxEnd = Math.ceil(Math.max(...(
                [].concat(...rows.map(r => r.items.map(it => it.end)))
            )));
            const hours = Array.from({length: maxEnd + 1}, (_, i) => i); // T+0h ... T+N
            const wrap = document.createElement('div');
            wrap.style.width = (labelW + cellW * hours.length) + 'px';
            wrap.style.minHeight = (rowsH * (rows.length + 1) + 16) + 'px';
            // Header
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.alignItems = 'center';
            header.style.color = '#e2e8f0';
            const headLabel = document.createElement('div');
            headLabel.style.width = labelW + 'px';
            headLabel.style.color = '#94a3b8';
            headLabel.style.fontSize = '12px';
            headLabel.textContent = '席位/时间';
            header.appendChild(headLabel);
            hours.forEach(h => {
                const cell = document.createElement('div');
                cell.style.width = cellW + 'px';
                cell.style.textAlign = 'center';
                cell.style.color = '#e2e8f0';
                cell.style.fontSize = '13px';
                cell.style.borderLeft = '1px solid #475569';
                cell.textContent = 'T+' + h + 'h';
                header.appendChild(cell);
            });
            wrap.appendChild(header);
            // Rows
            rows.forEach(r => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.height = rowsH + 'px';
                const label = document.createElement('div');
                label.style.width = labelW + 'px';
                label.style.color = '#e2e8f0';
                label.style.fontSize = '14px';
                label.style.padding = '4px 6px';
                label.style.borderRight = '1px solid #475569';
                label.textContent = r.label;
                row.appendChild(label);
                const track = document.createElement('div');
                track.style.position = 'relative';
                track.style.height = (rowsH - 6) + 'px';
                track.style.flex = '1';
                track.style.width = (cellW * hours.length) + 'px';
                track.style.borderBottom = '1px solid rgba(148,163,184,0.2)';
                track.style.boxSizing = 'content-box';
                // vertical grid lines
                hours.forEach((_, i) => {
                    const v = document.createElement('div');
                    v.style.position = 'absolute';
                    v.style.left = (i * cellW) + 'px';
                    v.style.top = '0';
                    v.style.bottom = '0';
                    v.style.width = '1px';
                    v.style.background = 'rgba(71,85,105,0.9)';
                    track.appendChild(v);
                });
                // items
                r.items.forEach(it => {
                    const bar = document.createElement('div');
                    const left = it.start * cellW;
                    const width = Math.max(8, (it.end - it.start) * cellW);
                    bar.style.position = 'absolute';
                    bar.style.left = left + 'px';
                    bar.style.top = '4px';
                    bar.style.height = (rowsH - 14) + 'px';
                    bar.style.width = width + 'px';
                    bar.style.background = barColor;
                    bar.style.opacity = '1';
                    bar.style.border = '1px solid ' + barColor;
                    bar.style.borderRadius = '4px';
                    bar.style.color = '#0f172a';
                    bar.style.fontSize = '13px';
                    bar.style.fontWeight = '600';
                    bar.style.padding = '4px 8px';
                    bar.style.overflow = 'hidden';
                    bar.style.whiteSpace = 'nowrap';
                    bar.style.textOverflow = 'ellipsis';
                    bar.textContent = it.name;
                    track.appendChild(bar);
                });
                row.appendChild(track);
                wrap.appendChild(row);
            });
            cont.appendChild(wrap);
        }
        function openFishboneModal() {
            const modal = document.getElementById('fishboneModal');
            if (!modal) return;
            modal.style.display = 'flex';
            renderFishbone('fishbone-modal-container');
        }
        function closeFishboneModal() {
            const modal = document.getElementById('fishboneModal');
            if (modal) modal.style.display = 'none';
        }
        function togglePlanSection(which) {
            const body = document.getElementById('plan-section-' + which);
            const arrow = document.getElementById('arrow-' + which);
            if (!body) return;
            const show = body.style.display !== 'none';
            body.style.display = show ? 'none' : 'block';
            if (arrow) arrow.textContent = show ? '▶' : '▼';
            if (typeof updateSolutionBodyLayout === 'function') updateSolutionBodyLayout();
        }
        function openPlanManualEdit() {
            const body = document.querySelector('#planDetailModal .plan-detail-body');
            if (!body || !window._currentPlanObj) return;
            let panel = document.getElementById('plan-edit-panel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'plan-edit-panel';
                panel.style.borderTop = '1px solid #475569';
                panel.style.marginTop = '8px';
                panel.style.paddingTop = '8px';
                panel.style.display = 'block';
                const uavRow = document.createElement('div');
                uavRow.style.display = 'flex';
                uavRow.style.alignItems = 'center';
                uavRow.style.gap = '8px';
                const uavLab = document.createElement('span');
                uavLab.textContent = '派遣无人机';
                uavLab.style.color = '#cbd5e1';
                uavLab.style.fontSize = '12px';
                const uavSel = document.createElement('select');
                uavSel.id = 'plan-edit-uav';
                uavSel.style.background = 'rgba(0,0,0,0.2)';
                uavSel.style.color = '#e2e8f0';
                uavSel.style.border = '1px solid #5c6f8a';
                uavSel.style.borderRadius = '4px';
                uavSel.style.fontSize = '12px';
                uavSel.style.padding = '4px 6px';
                uavSel.innerHTML = [
                    {id:'uav-01',name:'CH-4 彩虹'},
                    {id:'uav-02',name:'TB-001 双尾蝎'},
                    {id:'uav-03',name:'WZ-7 翔龙'}
                ].map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
                uavRow.appendChild(uavLab);
                uavRow.appendChild(uavSel);
                panel.appendChild(uavRow);
                const editWrap = document.createElement('div');
                editWrap.id = 'plan-edit-steps';
                editWrap.style.marginTop = '8px';
                editWrap.style.display = 'grid';
                editWrap.style.gridTemplateColumns = '1fr 1fr';
                editWrap.style.gap = '8px';
                panel.appendChild(editWrap);
                const btns = document.createElement('div');
                btns.style.display = 'flex';
                btns.style.justifyContent = 'flex-end';
                btns.style.gap = '8px';
                btns.style.marginTop = '8px';
                const applyBtn = document.createElement('button');
                applyBtn.textContent = '应用修改';
                applyBtn.style.background = '#3b82f6';
                applyBtn.style.color = 'white';
                applyBtn.style.border = 'none';
                applyBtn.style.borderRadius = '4px';
                applyBtn.style.padding = '6px 10px';
                applyBtn.style.fontSize = '12px';
                applyBtn.style.cursor = 'pointer';
                applyBtn.onclick = applyPlanManualEdit;
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '取消';
                cancelBtn.style.background = '#475569';
                cancelBtn.style.color = 'white';
                cancelBtn.style.border = '1px solid #5c6f8a';
                cancelBtn.style.borderRadius = '4px';
                cancelBtn.style.padding = '6px 10px';
                cancelBtn.style.fontSize = '12px';
                cancelBtn.style.cursor = 'pointer';
                cancelBtn.onclick = () => { panel.style.display = 'none'; };
                btns.appendChild(cancelBtn);
                btns.appendChild(applyBtn);
                panel.appendChild(btns);
                body.appendChild(panel);
            }
            populatePlanEditPanel();
            panel.style.display = 'block';
        }

        function populatePlanEditPanel() {
            const plan = window._currentPlanObj;
            const wrap = document.getElementById('plan-edit-steps');
            if (!plan || !wrap) return;
            wrap.innerHTML = '';
            plan.timelineStages.forEach((stage, si) => {
                const header = document.createElement('div');
                header.style.display = 'flex';
                header.style.alignItems = 'center';
                header.style.justifyContent = 'space-between';
                header.style.background = 'rgba(255,255,255,0.06)';
                header.style.border = '1px solid #475569';
                header.style.borderRadius = '4px';
                header.style.padding = '6px 8px';
                const hleft = document.createElement('div');
                hleft.textContent = stage.label;
                hleft.style.color = '#e2e8f0';
                hleft.style.fontWeight = 'bold';
                hleft.style.fontSize = '12px';
                const hright = document.createElement('div');
                hright.style.display = 'flex';
                hright.style.gap = '6px';
                function mkBtn(text) {
                    const b = document.createElement('button');
                    b.textContent = text;
                    b.style.background = '#475569';
                    b.style.color = 'white';
                    b.style.border = '1px solid #5c6f8a';
                    b.style.borderRadius = '4px';
                    b.style.padding = '2px 6px';
                    b.style.fontSize = '12px';
                    b.style.cursor = 'pointer';
                    return b;
                }
                const btnUp = mkBtn('上移');
                btnUp.onclick = () => moveStage(si, -1);
                const btnDown = mkBtn('下移');
                btnDown.onclick = () => moveStage(si, 1);
                const btnDel = mkBtn('删除阶段');
                btnDel.onclick = () => deleteStage(si);
                hright.appendChild(btnUp);
                hright.appendChild(btnDown);
                hright.appendChild(btnDel);
                header.appendChild(hleft);
                header.appendChild(hright);
                wrap.appendChild(header);
                stage.steps.forEach((st, ti) => {
                    const row = document.createElement('div');
                    row.style.display = 'flex';
                    row.style.alignItems = 'center';
                    row.style.gap = '6px';
                    const lab = document.createElement('span');
                    lab.textContent = stage.label + ' · ' + st.label;
                    lab.style.color = '#cbd5e1';
                    lab.style.fontSize = '12px';
                    lab.style.flex = '1';
                    const inp = document.createElement('input');
                    inp.type = 'number';
                    inp.min = '0';
                    inp.step = '0.1';
                    inp.value = st.hours;
                    inp.id = `edit-step-${si}-${ti}`;
                    inp.style.width = '80px';
                    inp.style.background = 'rgba(0,0,0,0.2)';
                    inp.style.color = '#e2e8f0';
                    inp.style.border = '1px solid #5c6f8a';
                    inp.style.borderRadius = '4px';
                    inp.style.fontSize = '12px';
                    inp.style.padding = '4px 6px';
                    row.appendChild(lab);
                    row.appendChild(inp);
                    wrap.appendChild(row);
                });
            });
        }

        function applyPlanManualEdit() {
            const plan = window._currentPlanObj;
            const els = window._planEls || {};
            if (!plan || !els.gantt) return;
            plan.timelineStages.forEach((stage, si) => {
                stage.steps.forEach((st, ti) => {
                    const v = parseFloat(document.getElementById(`edit-step-${si}-${ti}`).value);
                    if (!isNaN(v) && v >= 0) st.hours = v;
                });
            });
            const uavSel = document.getElementById('plan-edit-uav');
            if (uavSel && uavSel.value) {
                const opt = document.getElementById('opt-' + uavSel.value);
                if (opt) selectUav(opt, uavSel.value);
            }
            rerenderCurrentPlan();
            const panel = document.getElementById('plan-edit-panel');
            if (panel) panel.style.display = 'none';
        }

        function rerenderCurrentPlan() {
            const plan = window._currentPlanObj;
            const { titleEl, descEl, simEl, gantt } = window._planEls || {};
            if (!plan || !titleEl || !descEl || !simEl || !gantt) return;
            titleEl.textContent = plan.title;
            descEl.textContent = plan.desc;
            gantt.innerHTML = '';
            const stages = plan.timelineStages || [];
            let cursor = 0;
            const stagesAbs = stages.map(stage => {
                const steps = stage.steps.map(st => {
                    const s = cursor;
                    const e = cursor + st.hours;
                    cursor = e;
                    return { label: st.label, start: s, end: e, color: st.color || 'blue' };
                });
                return { label: stage.label, start: steps[0].start, end: steps[steps.length - 1].end, steps };
            });
            const totalH = cursor;
            const axis = document.createElement('div');
            axis.className = 'gantt-axis';
            const tickStep = totalH <= 8 ? 1 : (totalH <= 16 ? 2 : 4);
            const base = new Date();
            for (let h = 0; h <= totalH; h += tickStep) {
                const tick = document.createElement('div');
                tick.className = 'gantt-axis-tick';
                tick.style.left = Math.round((h / totalH) * 100) + '%';
                const t = new Date(base.getTime() + h * 3600 * 1000);
                const hh = String(t.getHours()).padStart(2, '0');
                const mm = String(t.getMinutes()).padStart(2, '0');
                tick.textContent = hh + ':' + mm;
                axis.appendChild(tick);
            }
            gantt.appendChild(axis);
            stagesAbs.forEach(stage => {
                const row = document.createElement('div');
                row.className = 'gantt-row';
                const label = document.createElement('div');
                label.className = 'gantt-label';
                label.textContent = stage.label;
                const wrap = document.createElement('div');
                wrap.className = 'gantt-stage-wrap';
                const bar = document.createElement('div');
                bar.className = 'gantt-stage-bar';
                bar.style.left = Math.round((stage.start / totalH) * 100) + '%';
                bar.style.width = Math.round(((stage.end - stage.start) / totalH) * 100) + '%';
                wrap.appendChild(bar);
                row.appendChild(label);
                row.appendChild(wrap);
                gantt.appendChild(row);
            });
            if (simEl._timer) { clearTimeout(simEl._timer); simEl._timer = null; }
            simEl.innerHTML = '';
            const simDesc = document.createElement('div');
            simDesc.textContent = plan.simulation;
            simDesc.style.marginBottom = '8px';
            simDesc.style.color = '#cbd5e1';
            simDesc.style.fontSize = '12px';
            const mapWrap = document.createElement('div');
            mapWrap.className = 'sim-map-wrap';
            const iframe = document.createElement('iframe');
            iframe.src = 'https://www.google.com/maps?hl=zh-CN&q=25.260555,125.003055&z=6&output=embed';
            mapWrap.appendChild(iframe);
            const dot = document.createElement('div');
            dot.className = 'sim-route-dot';
            dot.style.animationDuration = (stagesAbs.length ? (stagesAbs[stagesAbs.length-1].end) : 1) + 's';
            dot.style.animationName = 'routeMove';
            mapWrap.appendChild(dot);
            const startLab = document.createElement('div');
            startLab.className = 'sim-label';
            startLab.style.left = '10%';
            startLab.textContent = '起飞点';
            mapWrap.appendChild(startLab);
            const targetLab = document.createElement('div');
            targetLab.className = 'sim-label';
            targetLab.style.left = '80%';
            targetLab.textContent = '目标点';
            mapWrap.appendChild(targetLab);
            const status = document.createElement('div');
            status.style.marginTop = '8px';
            status.style.fontSize = '12px';
            status.style.color = '#94a3b8';
            simEl.appendChild(simDesc);
            simEl.appendChild(mapWrap);
            simEl.appendChild(status);
            const flat = stagesAbs.flatMap(st => st.steps.map(s => ({ label: s.label, hours: (s.end - s.start) })));
            function advance(i) {
                status.textContent = '当前阶段：' + flat[i].label;
                if (i + 1 < flat.length) {
                    simEl._timer = setTimeout(() => advance(i + 1), flat[i].hours * 1000);
                }
            }
            if (flat.length > 0) advance(0);
        }
        function moveStage(index, dir) {
            const plan = window._currentPlanObj;
            if (!plan) return;
            const ni = index + dir;
            if (ni < 0 || ni >= plan.timelineStages.length) return;
            const arr = plan.timelineStages;
            const tmp = arr[index];
            arr[index] = arr[ni];
            arr[ni] = tmp;
            populatePlanEditPanel();
            rerenderCurrentPlan();
        }
        function deleteStage(index) {
            const plan = window._currentPlanObj;
            if (!plan) return;
            plan.timelineStages.splice(index, 1);
            populatePlanEditPanel();
            rerenderCurrentPlan();
        }
        function openModal() {
            const data = typeof intelData !== 'undefined' ? intelData[currentIntelIndex] : null;
            if (!data) return;
            const title = data.title || '';
            let cfg;
            if (title === '台湾西部彰化县进入警备状态') {
                cfg = {
                    tagText: '军事行动',
                    tagClass: 'green-tag',
                    title: '台湾西部彰化县进入警备状态',
                    time: '2025-11-23 06:23:38 ~ 2025-11-24 22:52:38',
                    level: '<span class="badge-red">高等威胁</span>',
                    stats: '数据总量 <span class="highlight">5612</span> 条 | 媒体总量 <span class="highlight">62</span> 个',
                    summary: '据多源情报综合分析，台湾西部彰化县地区出现异常军事调动，进入二级战备状态。监测到大量军用车辆集结，无线电通信频率激增。初步研判为针对近期海上演习的防御性部署，但不排除升级可能。建议加强该区域的持续监控，重点关注沿海雷达站及防空导弹阵地的动态。',
                    tags: ['军事调动','战备升级','彰化县'],
                    images: ['6.png','2.png','3.png','4.png'],
                    mapSrc: 'https://maps.google.com/maps?hl=zh-CN&q=24.051,120.542&t=h&z=12&ie=UTF8&iwloc=&output=embed',
                    coords: 'E 120.542, N 24.051',
                    sourceRaw:
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-satellite blue-icon"></i> GF-7_20251123_001</span><span class="raw-tag">影像</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-satellite blue-icon"></i> GF-7_20251123_004</span><span class="raw-tag">影像</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-wifi green-icon"></i> A12_无线电截获_0625</span><span class="raw-tag">信号</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-walkie-talkie green-icon"></i> 通话记录_加密频道_09</span><span class="raw-tag">信号</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-newspaper orange-icon"></i> 地方新闻_彰化县政府通告_01</span><span class="raw-tag">开源</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-brands fa-twitter orange-icon"></i> #彰化战备_趋势_01</span><span class="raw-tag">开源</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-user-secret purple-icon"></i> HUMINT_基地哨所_提升警戒</span><span class="raw-tag">人工</span></div>',
                    sourceEvidence:
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-sat"><i class="fa-solid fa-satellite"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">高分卫星 GF-7</div>'+
                                '<div class="t-desc">彰滨工业区与沿海道路出现非例行车队调动，营区车辆密集进出</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-sig"><i class="fa-solid fa-wifi"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">信号监测站 A12</div>'+
                                '<div class="t-desc">短波与超短波通信同时活跃，加密话音流量显著上升</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-web"><i class="fa-brands fa-twitter"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">开源网络爬虫</div>'+
                                '<div class="t-desc">本地社区视频与社交讨论出现战备布防相关内容</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-hum"><i class="fa-solid fa-user-secret"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">人工情报员 007</div>'+
                                '<div class="t-desc">哨所通报：营区门岗放行规则收紧，夜间警戒提升</div>'+
                            '</div>'+
                        '</div>',
                    sourceFusion:
                        '<div class="fusion-dot-right"></div>'+
                        '<div class="t-icon icon-fusion"><i class="fa-solid fa-brain"></i></div>'+
                        '<div class="t-title" style="font-size: 18px;">多模态情报融合引擎</div>'+
                        '<div class="t-desc">对影像、信号与开源数据进行时空对齐与交叉验证，输出二级战备状态判定。</div>'+
                        '<div class="fusion-stats">'+
                            '<div class="stat-item"><span class="stat-val">92%</span>置信度</div>'+
                            '<div class="stat-item"><span class="stat-val">6</span>数据源</div>'+
                            '<div class="stat-item"><span class="stat-val">20ms</span>延迟</div>'+
                        '</div>',
                    sourceResult:
                        '<div class="result-header">'+
                            '<span class="result-tag">二级战备</span>'+
                            '<span style="font-size: 12px; color: #991b1b;"><i class="fa-solid fa-triangle-exclamation"></i> 高威胁</span>'+
                        '</div>'+
                        '<div class="result-body">'+
                            '<h4 class="result-title">彰化县军事异常调动态势评估</h4>'+
                            '<div class="result-meta">'+
                                '<span><i class="fa-regular fa-clock"></i> 2025-11-23</span>'+
                                '<span><i class="fa-solid fa-location-dot"></i> 彰滨沿海与营区</span>'+
                            '</div>'+
                            '<div class="result-desc">融合分析确认区域进入二级战备状态，存在向一级战备升级与实弹射击演练的可能，应扩大监控半径与保持持续预警。</div>'+
                            '<div class="result-actions">'+
                                '<button class="btn-report"><i class="fa-solid fa-file-pdf"></i> 生成研判报告</button>'+
                            '</div>'+
                        '</div>',
                    reasonStep1Card:
                        '<div class="card-icon"><i class="fa-solid fa-map-location-dot"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>彰化县军事异常调动</h4>'+
                            '<p>车辆集结与电磁活跃度显著提升，异常明确。</p>'+
                        '</div>',
                    reasonStep1Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>数据接入</strong><p>接入 GF-7 高分影像与 A12 站点信号 (2025-11-23 06:23)</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>目标识别</strong><p>AI 识别营区外车队集结，车辆数量 > 50 辆</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>多源验证</strong><p>与加密话音与舆情视频交叉验证，确认活跃度</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>初步定性</strong><p>判定为非例行性战备提升行为</p></div></div>',
                    reasonStep2Card:
                        '<div class="card-icon"><i class="fa-solid fa-brain"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>战备升级行为模式匹配</h4>'+
                            '<div class="progress-bar"><div class="fill" style="width: 85%">85% 匹配度</div></div>'+
                            '<p class="sub-text">匹配历史库：2023 年“汉光演习”前奏模式</p>'+
                        '</div>',
                    reasonStep2Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>特征提取</strong><p>沿海、机械化部队集结、通信静默打破三要素</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>历史比对</strong><p>检索近 5 年 124 起相似事件样本</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>模式匹配</strong><p>节奏与既有模板高度一致</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>置信度计算</strong><p>加权输出匹配分数 85%</p></div></div>',
                    reasonStep3Card:
                        '<div class="card-icon"><i class="fa-solid fa-crosshairs"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>未来 24 小时预测</h4>'+
                            '<ul class="prediction-list">'+
                                '<li><i class="fa-solid fa-circle-exclamation text-red"></i> 80% 概率：展开实弹射击演练</li>'+
                                '<li><i class="fa-solid fa-triangle-exclamation text-orange"></i> 15% 概率：提升至一级战备</li>'+
                                '<li><i class="fa-solid fa-info-circle text-blue"></i> 5% 概率：解除警报恢复常态</li>'+
                            '</ul>'+
                        '</div>',
                    reasonStep3Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>条令分析</strong><p>按照既往惯例，集结后 12-24 小时内常伴随实弹演练</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>环境因子</strong><p>未来 24 小时气象良好，适合海空联合行动</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>政治背景</strong><p>区域紧张度上升，提高威慑展示的权重</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>概率输出</strong><p>综合输出：80/15/5 概率分布</p></div></div>'
                    ,
                    reasonStep2Intents:
                        '<p style="margin: 0 0 6px 0; font-size: 13px; color: #cbd5e1; line-height: 1.5; text-align: justify;">台湾西部彰化县进入警备状态，综合车辆集结与电磁活动分析，可能意图如下：</p>'+
                        '<div class="intent-list">'+
                            '<div class="intent-item" style="cursor:pointer;" onclick="openIntentWorkflow(this)">'+
                                '<div class="intent-left"><i class="fa-solid fa-magnifying-glass"></i><span>意图1：战备升级与区域防御部署</span></div>'+
                                '<div class="intent-badge green">概率 70%</div>'+
                            '</div>'+
                            '<div class="intent-progress"><div class="intent-progress-fill fill-70"></div></div>'+
                            '<div class="intent-item" style="cursor:pointer;" onclick="openIntentWorkflow(this)">'+
                                '<div class="intent-left"><i class="fa-solid fa-cloud-sun"></i><span>意图2：演习准备与兵力集结</span></div>'+
                                '<div class="intent-badge yellow">概率 60%</div>'+
                            '</div>'+
                            '<div class="intent-progress"><div class="intent-progress-fill fill-60"></div></div>'+
                            '<div class="intent-item" style="cursor:pointer;" onclick="openIntentWorkflow(this)">'+
                                '<div class="intent-left"><i class="fa-solid fa-bullhorn"></i><span>意图3：对外威慑展示</span></div>'+
                                '<div class="intent-badge slate">概率 50%</div>'+
                            '</div>'+
                            '<div class="intent-progress"><div class="intent-progress-fill fill-50"></div></div>'+
                        '</div>'
                };
            } else if (title === '日本西南岛屿军事演练，介入台海威胁加剧') {
                cfg = {
                    tagText: '政治事件',
                    tagClass: 'purple-tag',
                    title: '日本西南岛屿军事演练，介入台海威胁加剧',
                    time: '2025-11-22 06:00:00 ~ 2025-11-24 22:52:38',
                    level: '<span class="badge-orange">中等威胁</span>',
                    stats: '数据总量 <span class="highlight">3712</span> 条 &nbsp;|&nbsp; 媒体总量 <span class="highlight">121</span> 个',
                    summary: '日本自卫队在西南诸岛海域举行大规模两栖登陆演习，美军部分舰艇参与协同。此举严重加剧台海周边紧张局势，意在展示介入能力。多源情报显示演习区域存在异常电磁信号活动。',
                    tags: ['军事演习','西南诸岛','联合行动'],
                    images: ['1.png','5.png','7.png','8.png'],
                    mapSrc: 'https://maps.google.com/maps?hl=zh-CN&q=26.212,127.680&t=h&z=9&ie=UTF8&iwloc=&output=embed',
                    coords: 'E 127.680, N 26.212',
                    sourceRaw:
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-satellite blue-icon"></i> WorldView-3_20251122_009</span><span class="raw-tag">影像</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-wifi green-icon"></i> Radar_Okinawa_Sig_04</span><span class="raw-tag">信号</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-newspaper orange-icon"></i> NHK_News_Flash_01</span><span class="raw-tag">开源</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-brands fa-twitter orange-icon"></i> Twitter_Trending_#Drill</span><span class="raw-tag">开源</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-user-secret purple-icon"></i> HUMINT_Report_JP_02</span><span class="raw-tag">人工</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-wifi green-icon"></i> Sig_Intercept_Naval_09</span><span class="raw-tag">信号</span></div>',
                    sourceEvidence:
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-sat"><i class="fa-solid fa-satellite"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">WorldView-3 高分影像</div>'+
                                '<div class="t-desc">琉球近海两栖登陆演练海滩区域清晰成像</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-sig"><i class="fa-solid fa-wifi"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">冲绳雷达站</div>'+
                                '<div class="t-desc">X波段雷达与战术电台同步活跃 (加密)</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-web"><i class="fa-brands fa-twitter"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">社交媒体趋势</div>'+
                                '<div class="t-desc">#Drill 话题在当地快速攀升</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-hum"><i class="fa-solid fa-user-secret"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">HUMINT 报告</div>'+
                                '<div class="t-desc">两栖车辆装卸频繁，海军陆战队参与</div>'+
                            '</div>'+
                        '</div>',
                    sourceFusion:
                        '<div class="fusion-dot-right"></div>'+
                        '<div class="t-icon icon-fusion"><i class="fa-solid fa-brain"></i></div>'+
                        '<div class="t-title" style="font-size: 18px;">多模态情报融合引擎</div>'+
                        '<div class="t-desc">对影像、信号与开源舆情进行时空对齐与交叉验证，识别联合登陆演练模板。</div>'+
                        '<div class="fusion-stats">'+
                            '<div class="stat-item"><span class="stat-val">94%</span>置信度</div>'+
                            '<div class="stat-item"><span class="stat-val">5</span>数据源</div>'+
                            '<div class="stat-item"><span class="stat-val">18ms</span>延迟</div>'+
                        '</div>',
                    sourceResult:
                        '<div class="result-header">'+
                            '<span class="result-tag">演练介入能力</span>'+
                            '<span style="font-size: 12px; color: #991b1b;"><i class="fa-solid fa-triangle-exclamation"></i> 中等威胁</span>'+
                        '</div>'+
                        '<div class="result-body">'+
                            '<h4 class="result-title">日本西南诸岛两栖登陆演练态势评估</h4>'+
                            '<div class="result-meta">'+
                                '<span><i class="fa-regular fa-clock"></i> 2025-11-22</span>'+
                                '<span><i class="fa-solid fa-location-dot"></i> 冲绳周边海域</span>'+
                            '</div>'+
                            '<div class="result-desc">多源融合分析表明，演练具有靠近台海方向的意图展示，存在后续持续演练与联合行动的可能，需加强预警。</div>'+
                            '<div class="result-actions">'+
                                '<button class="btn-report"><i class="fa-solid fa-file-pdf"></i> 生成研判报告</button>'+
                            '</div>'+
                        '</div>',
                    reasonStep1Card:
                        '<div class="card-icon"><i class="fa-solid fa-map-location-dot"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>西南诸岛两栖登陆演练</h4>'+
                            '<p>确认多兵种联合，含海军陆战队与航空支援。</p>'+
                        '</div>',
                    reasonStep1Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>演练规模</strong><p>登陆车辆与两栖装备部署完善，岸滩区域多点演练。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>信号活动</strong><p>战术电台与雷达同时在线，电磁频谱占用显著。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>协同要素</strong><p>美军舰艇参与协同，指挥链路稳定。</p></div></div>',
                    reasonStep2Card:
                        '<div class="card-icon"><i class="fa-solid fa-brain"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>联合登陆演练模板匹配</h4>'+
                            '<div class="progress-bar"><div class="fill" style="width: 78%">78% 匹配度</div></div>'+
                            '<p class="sub-text">匹配历史库：2022-2024 多次西南诸岛联合演练</p>'+
                        '</div>',
                    reasonStep2Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>特征提取</strong><p>岸滩集结、两栖装卸、空海协同三要素同时出现。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>历史比对</strong><p>检索近三年 86 起相似演练样本。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>模式匹配</strong><p>阶段演练节奏与既有模板高度一致。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>置信度计算</strong><p>加权后输出匹配分数 78%。</p></div></div>',
                    reasonStep3Card:
                        '<div class="card-icon"><i class="fa-solid fa-crosshairs"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>未来 24 小时预测</h4>'+
                            '<ul class="prediction-list">'+
                                '<li><i class="fa-solid fa-circle-exclamation text-red"></i> 60% 概率：靠近台海方向的军事存在增强</li>'+
                                '<li><i class="fa-solid fa-triangle-exclamation text-orange"></i> 30% 概率：连续多日演练并扩大范围</li>'+
                                '<li><i class="fa-solid fa-info-circle text-blue"></i> 10% 概率：演练降级或结束</li>'+
                            '</ul>'+
                        '</div>',
                    reasonStep3Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>条令分析</strong><p>联合演练通常在 24-72 小时内进入强化阶段。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>环境因子</strong><p>海况与气象良好，适合持续海空行动。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>政治背景</strong><p>涉台言论升温，提高威慑展示概率。</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>概率输出</strong><p>综合输出：60/30/10 概率分布。</p></div></div>'
                    ,
                    reasonStep2Intents:
                        '<p style="margin: 0 0 6px 0; font-size: 13px; color: #cbd5e1; line-height: 1.5; text-align: justify;">日本西南岛屿军事演练，综合影像与电磁信号分析，可能意图如下：</p>'+
                        '<div class="intent-list">'+
                            '<div class="intent-item" style="cursor:pointer;" onclick="openIntentWorkflow(this)">'+
                                '<div class="intent-left"><i class="fa-solid fa-bullhorn"></i><span>意图1：展示介入台海能力与存在</span></div>'+
                                '<div class="intent-badge yellow">概率 60%</div>'+
                            '</div>'+
                            '<div class="intent-progress"><div class="intent-progress-fill fill-60"></div></div>'+
                            '<div class="intent-item" style="cursor:pointer;" onclick="openIntentWorkflow(this)">'+
                                '<div class="intent-left"><i class="fa-solid fa-magnifying-glass"></i><span>意图2：联合登陆演练持续强化</span></div>'+
                                '<div class="intent-badge slate">概率 50%</div>'+
                            '</div>'+
                            '<div class="intent-progress"><div class="intent-progress-fill fill-50"></div></div>'+
                            '<div class="intent-item" style="cursor:pointer;" onclick="openIntentWorkflow(this)">'+
                                '<div class="intent-left"><i class="fa-solid fa-cloud-sun"></i><span>意图3：水文气象与海况数据采集</span></div>'+
                                '<div class="intent-badge slate">概率 50%</div>'+
                            '</div>'+
                            '<div class="intent-progress"><div class="intent-progress-fill fill-50"></div></div>'+
                        '</div>'
                };
            } else if (title === '东部战区美国两艘舰艇过航台湾海峡') {
                cfg = {
                    tagText: '军事行动',
                    tagClass: 'green-tag',
                    title: '东部战区美国两艘舰艇过航台湾海峡',
                    time: '2025-11-23 08:10:00 ~ 2025-11-23 16:30:00',
                    level: '<span class="badge-red">高等威胁</span>',
                    stats: '数据总量 <span class="highlight">4286</span> 条 &nbsp;|&nbsp; 媒体总量 <span class="highlight">76</span> 个',
                    summary: '东部战区监测到两艘美国军舰在冲绳岛附近海域（25°15\'38\"N 125°00\'11\"E）后，沿既定航路过航台湾海峡。综合无人机与卫星影像识别，目标为“鲍迪奇”号海洋测量船与拉尔夫·约翰逊号驱逐舰。当前评估为高等威胁，建议加强海空联合监视与战备部署。',
                    tags: ['美国军舰','台海过航','战备提升'],
                    images: ['实时监控3.png','船.png'],
                    mapSrc: 'https://maps.google.com/maps?hl=zh-CN&q=24.8242,125.0264&t=h&z=9&ie=UTF8&iwloc=&output=embed',
                    coords: 'E 125.0264, N 24.8242',
                    sourceRaw:
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-satellite blue-icon"></i> 055型驱逐舰雷达影像_20250210_021</span><span class="raw-tag">影像</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-wifi green-icon"></i> Naval_Radar_TW_Chan_12</span><span class="raw-tag">信号</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-newspaper orange-icon"></i> Intl_News_Flash_US_Navy</span><span class="raw-tag">开源</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-brands fa-twitter orange-icon"></i> #TaiwanStrait_Transits</span><span class="raw-tag">开源</span></div>'+
                        '<div class="trace-raw-item"><span><i class="fa-solid fa-user-secret purple-icon"></i> HUMINT_Port_Report_03</span><span class="raw-tag">人工</span></div>',
                    sourceEvidence:
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-sat"><i class="fa-solid fa-satellite"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">055型驱逐舰雷达影像</div>'+
                                '<div class="t-desc">在 25°15\'38\"N 125°00\'11\"E 区域清晰识别两艘舰艇航迹</div>'+
                            '</div>'+
                        '</div>'+
                        '<div class="trace-card small-card">'+
                            '<div class="t-icon icon-sig"><i class="fa-solid fa-wifi"></i></div>'+
                            '<div class="t-content">'+
                                '<div class="t-title">海上雷达链路</div>'+
                                '<div class="t-desc">多站点同步跟踪，回传航速与航向数据</div>'+
                            '</div>'+
                        '</div>',
                    sourceFusion:
                        '<div class="fusion-dot-right"></div>'+
                        '<div class="t-icon icon-fusion"><i class="fa-solid fa-brain"></i></div>'+
                        '<div class="t-title" style="font-size: 18px;">多模态情报融合引擎</div>'+
                        '<div class="t-desc">融合无人机回传与055型驱逐舰雷达影像，确认两舰型号并评估过航意图。</div>'+
                        '<div class="fusion-stats">'+
                            '<div class="stat-item"><span class="stat-val">95%</span>识别置信度</div>'+
                            '<div class="stat-item"><span class="stat-val">7</span>数据源</div>'+
                            '<div class="stat-item"><span class="stat-val">12ms</span>延迟</div>'+
                        '</div>',
                    sourceResult:
                        '<div class="result-header">'+
                            '<span class="result-tag">两舰过航态势评估</span>'+
                            '<span style="font-size: 12px; color: #991b1b;"><i class="fa-solid fa-triangle-exclamation"></i> 高等威胁</span>'+
                        '</div>'+
                        '<div class="result-body">'+
                            '<h4 class="result-title">美国海军两舰过航台湾海峡</h4>'+
                            '<div class="result-meta">'+
                                '<span><i class="fa-regular fa-clock"></i> 2025-11-23</span>'+
                                '<span><i class="fa-solid fa-location-dot"></i> 台湾海峡北段</span>'+
                            '</div>'+
                            '<div class="result-desc">结合动态航迹与多源识别结果，研判为针对台海的抵近侦察与存在展示行为，需提升海空监视强度与预警等级。</div>'+
                            '<div class="result-actions">'+
                                '<button class="btn-report"><i class="fa-solid fa-file-pdf"></i> 生成研判报告</button>'+
                            '</div>'+
                        '</div>',
                    reasonStep1Card:
                        '<div class="card-icon"><i class="fa-solid fa-map-location-dot"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>两舰航迹确认</h4>'+
                            '<p>结合055型驱逐舰雷达影像与无人机数据，确认过航轨迹与时间窗。</p>'+
                        '</div>',
                    reasonStep1Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>数据接入</strong><p>接收055型驱逐舰雷达影像数据 (2025-11-23 08:15)</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>目标识别</strong><p>雷达影像识别：拉尔夫·约翰逊号驱逐舰与鲍迪奇号测量船</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>多源融合</strong><p>融合无人机光电数据与雷达航迹，提升识别置信度</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>初步定性</strong><p>判定为过航与抵近侦察行为</p></div></div>',
                    reasonStep2Details:
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>特征提取</strong><p>提取雷达关键特征：航速、航向、编队距离</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>历史比对</strong><p>比对近年台海过航事件的雷达影像特征</p></div></div>'+
                        '<div class="detail-item"><div class="d-dot"></div><div class="d-content"><strong>行为推演</strong><p>结合航迹与队形变化进行意图评估</p></div></div>',
                    reasonStep2Card:
                        '<div class="card-icon"><i class="fa-solid fa-brain"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>意图评估与模板匹配</h4>'+
                            '<div class="progress-bar"><div class="fill" style="width: 82%">82% 匹配度</div></div>'+
                            '<p class="sub-text">与历史过航与抵近侦察模式相符</p>'+
                        '</div>',
                    reasonStep3Card:
                        '<div class="card-icon"><i class="fa-solid fa-crosshairs"></i></div>'+
                        '<div class="card-content">'+
                            '<h4>未来 24 小时预测</h4>'+
                            '<ul class="prediction-list">'+
                                '<li><i class="fa-solid fa-circle-exclamation text-red"></i> 55% 概率：持续抵近侦察并保持航迹</li>'+
                                '<li><i class="fa-solid fa-triangle-exclamation text-orange"></i> 35% 概率：伴随多域演训与联合行动</li>'+
                                '<li><i class="fa-solid fa-info-circle text-blue"></i> 10% 概率：短时过航后远离</li>'+
                            '</ul>'+
                        '</div>'
                };
                const lat = 24.8242, lng = 125.0264;
                shipFocusLat = lat; shipFocusLng = lng;
                const icon = L.divIcon({ className: 'ship-marker', html: '<div style="font-size: 24px; color: #ef4444; filter: drop-shadow(0 0 5px rgba(239, 68, 68, 0.8));"><i class="fa-solid fa-ship"></i></div>', iconSize: [30,30], iconAnchor: [15,15] });
                if (window.ship1Marker) { window.ship1Marker.setLatLng([lat, lng]); } else { window.ship1Marker = L.marker([lat, lng], {icon}).addTo(map); }
                if (window.ship2Marker) { window.ship2Marker.setLatLng([lat, lng]); } else { window.ship2Marker = L.marker([lat, lng], {icon}).addTo(map); }
                if (window.ship1Marker) window.ship1Marker.on('click', () => openShipPage('A'));
                if (window.ship2Marker) window.ship2Marker.on('click', () => openShipPage('B'));
                map.flyTo([lat, lng], 9, { animate: true, duration: 1.2 });
            } else {
                return;
            }

            const overlay = document.getElementById('detailModal');
            overlay.style.display = 'flex';

            const tagEl = document.getElementById('modal-title-tag');
            if (tagEl) { tagEl.textContent = cfg.tagText; tagEl.className = 'tag-cat ' + cfg.tagClass; }
            const titleEl = document.getElementById('modal-title-text');
            if (titleEl) titleEl.textContent = cfg.title;
            const timeEl = document.getElementById('modal-info-time');
            if (timeEl) timeEl.textContent = cfg.time;
            const levelEl = document.getElementById('modal-info-level');
            if (levelEl) levelEl.innerHTML = cfg.level;
            const statsEl = document.getElementById('modal-info-stats');
            if (statsEl) statsEl.innerHTML = cfg.stats;
            const sumEl = document.getElementById('modal-info-summary');
            if (sumEl) sumEl.textContent = cfg.summary;
            const tagsEl = document.getElementById('modal-info-tags');
            if (tagsEl) tagsEl.innerHTML = (cfg.tags || []).map(t => '<span class="badge-new-text">'+t+'</span>').join('');
            const galleryEl = document.getElementById('modal-media-gallery');
            if (galleryEl) galleryEl.innerHTML = (cfg.images || []).map((n,i) => '<div class="media-item"><img src="images/'+n+'" alt="现场图'+(i+1)+'"></div>').join('');

            const frame = document.getElementById('map-frame');
            if (frame) frame.src = cfg.mapSrc;
            const infoBox = document.getElementById('map-info-overlay');
            if (infoBox) infoBox.innerHTML = '<strong>目标坐标:</strong> '+cfg.coords+'<br><strong>覆盖范围:</strong> 50km²<br><strong>更新时间:</strong> '+cfg.time.split('~')[0].trim();

            const rawList = document.getElementById('trace-raw-list');
            if (rawList && cfg.sourceRaw) rawList.innerHTML = cfg.sourceRaw;
            const evidenceGrid = document.getElementById('trace-evidence-grid');
            if (evidenceGrid && cfg.sourceEvidence) evidenceGrid.innerHTML = cfg.sourceEvidence;
            const fusionCard = document.getElementById('trace-fusion-card');
            if (fusionCard && cfg.sourceFusion) fusionCard.innerHTML = cfg.sourceFusion;
            const resultCard = document.getElementById('trace-result-card');
            if (resultCard && cfg.sourceResult) resultCard.innerHTML = cfg.sourceResult;

            const step1Card = document.getElementById('reasoning-step1-card');
            if (step1Card && cfg.reasonStep1Card) step1Card.innerHTML = cfg.reasonStep1Card;
            const step1Details = document.getElementById('reasoning-step1-details');
            if (step1Details && cfg.reasonStep1Details) step1Details.innerHTML = cfg.reasonStep1Details;
            const step2Card = document.getElementById('reasoning-step2-card');
            if (step2Card && cfg.reasonStep2Card) step2Card.innerHTML = cfg.reasonStep2Card;
            const step2Details = document.getElementById('reasoning-step2-details');
            if (step2Details && cfg.reasonStep2Details) step2Details.innerHTML = cfg.reasonStep2Details;
            const intentsEl = document.getElementById('reasoning-step2-intents');
            if (intentsEl && cfg.reasonStep2Intents) intentsEl.innerHTML = cfg.reasonStep2Intents;
            const step3Card = document.getElementById('reasoning-step3-card');
            if (step3Card && cfg.reasonStep3Card) step3Card.innerHTML = cfg.reasonStep3Card;
            const step3Details = document.getElementById('reasoning-step3-details');
            if (step3Details && cfg.reasonStep3Details) step3Details.innerHTML = cfg.reasonStep3Details;
        }

        function closeModal() {
            const overlay = document.getElementById('detailModal');
            overlay.style.display = 'none';
        }

        function switchTab(tab) {
            const tabs = ['details','source','reasoning'];
            tabs.forEach(t => {
                const btn = document.getElementById('tab-btn-' + t);
                const content = document.getElementById('tab-' + t);
                if (btn) btn.classList.toggle('active', t === tab);
                if (content) content.classList.toggle('active', t === tab);
            });
        }

        function toggleLayer(layer) {
            const frame = document.getElementById('map-frame');
            const satBtn = document.getElementById('btn-sat');
            const roadBtn = document.getElementById('btn-road');
            if (frame) {
                const src = frame.src || '';
                const next = layer === 'sat' ? src.replace(/t=(h|m)/,'t=h') : src.replace(/t=(h|m)/,'t=m');
                frame.src = next;
            }
            if (layer === 'sat') {
                if (satBtn) satBtn.classList.add('active');
                if (roadBtn) roadBtn.classList.remove('active');
            } else {
                if (roadBtn) roadBtn.classList.add('active');
                if (satBtn) satBtn.classList.remove('active');
            }
        }

        function confirmPlan() {
            const targetInput = document.getElementById('target-coords');
            if (shipFocusLat && shipFocusLng) {
                let lat = shipFocusLat, lng = shipFocusLng;
                if (window._shipVectorDeg) {
                    const dxDeg = window._shipVectorDeg.dx;
                    const dyDeg = window._shipVectorDeg.dy;
                    const kmLat = 111.32;
                    const kmLon = 111.32 * Math.cos(lat * Math.PI / 180);
                    const vxKm = dxDeg * kmLat;
                    const vyKm = dyDeg * kmLon;
                    const magKm = Math.sqrt(vxKm * vxKm + vyKm * vyKm);
                    if (magKm > 0) {
                        const scale = 40 / magKm;
                        const dLat = dxDeg * scale;
                        const dLng = dyDeg * scale;
                        lat = lat + dLat;
                        lng = lng + dLng;
                    }
                }
                targetInput.value = `${lat.toFixed(4)}°N, ${lng.toFixed(4)}°E`;
                if (typeof currentTargetLat !== 'undefined') {
                    currentTargetLat = lat;
                    currentTargetLng = lng;
                }
            }

            if (typeof selectionLayerGroup !== 'undefined') {
                selectionLayerGroup.clearLayers();
                flightPathLayerGroup.clearLayers();
                L.marker([currentTargetLat, currentTargetLng], { icon: blueMarkerIcon }).addTo(selectionLayerGroup);
                L.circle([currentTargetLat, currentTargetLng], {
                    radius: 20000,
                    color: '#3b82f6',
                    dashArray: '10, 10',
                    fillColor: '#3b82f6',
                    fillOpacity: 0.1,
                    weight: 2
                }).addTo(selectionLayerGroup);
                if (typeof analyzeRecommendations === 'function') {
                    analyzeRecommendations(currentTargetLat, currentTargetLng);
                }
            }

            const card = document.getElementById('solutionCard');
            if (card && card.getAttribute('data-fullscreen') === 'true') {
                openIntelSendInline();
            } else {
                openIntelSendModal();
            }
            setTimeout(() => {
                const ch4Opt = document.getElementById('opt-uav-01');
                if (ch4Opt) {
                    selectUav(ch4Opt, 'uav-01');
                }
                if (typeof recalcUavRouteStats === 'function') recalcUavRouteStats();
            }, 3000);
            setTimeout(() => {
                dispatchUav();
            }, 5000);

            if (window._currentPlanId) {
                document.querySelectorAll('#solutionCard .uav-option').forEach(opt => opt.classList.remove('selected'));
                const chosen = document.getElementById('opt-' + window._currentPlanId);
                if (chosen) chosen.classList.add('selected');
            }

            closePlanDetail();
        }

        function recalcUavRouteStats() {
            if (typeof uavBases === 'undefined' || typeof currentTargetLat === 'undefined') return;
            function kmPerDeg(lat) { return { lat: 111.32, lon: 111.32 * Math.cos(lat * Math.PI / 180) }; }
            function pathKm(points) {
                let km = 0;
                for (let i = 0; i < points.length - 1; i++) {
                    const a = points[i], b = points[i + 1];
                    const k = kmPerDeg((a[0] + b[0]) / 2);
                    const dx = (b[0] - a[0]) * k.lat;
                    const dy = (b[1] - a[1]) * k.lon;
                    km += Math.sqrt(dx*dx + dy*dy);
                }
                return km;
            }
            const ids = ['uav-01','uav-02','uav-03'];
            const dists = [];
            ids.forEach(id => {
                const base = uavBases[id];
                if (!base) return;
                const outbound = [[base.lat, base.lng]];
                if (Array.isArray(window._uavWaypoints) && window._uavWaypoints.length > 0) {
                    outbound.push(...window._uavWaypoints);
                }
                outbound.push([currentTargetLat, currentTargetLng]);
                const inbound = [...outbound].reverse();
                const totalKm = pathKm(outbound) + pathKm(inbound);
                dists.push({ id, km: totalKm });
                const el = document.getElementById('dist-uav-' + id.split('-')[1]);
                if (el) el.textContent = Math.round(totalKm) + 'km';
            });
            dists.sort((a,b) => a.km - b.km);
            const best = dists[0];
            ['01','02','03'].forEach(suf => {
                const badge = document.getElementById('badge-uav-' + suf);
                if (badge) {
                    badge.className = 'recommend-badge';
                    badge.textContent = '';
                    badge.style.display = 'none';
                }
            });
            if (best) {
                const suf = best.id.split('-')[1];
                const timeBadge = document.getElementById('badge-uav-' + suf);
                if (timeBadge) {
                    timeBadge.textContent = '时间最优';
                    timeBadge.className = 'recommend-badge rec-time';
                    timeBadge.style.display = 'inline-block';
                }
            }
            const safetyBadge = document.getElementById('badge-uav-02');
            if (safetyBadge) {
                if (best && best.id === 'uav-02') {
                    safetyBadge.textContent = '时间/安全最优';
                } else {
                    safetyBadge.textContent = '安全性最优';
                }
                safetyBadge.className = 'recommend-badge rec-safety';
                safetyBadge.style.display = 'inline-block';
            }
            const costBadge = document.getElementById('badge-uav-03');
            if (costBadge) {
                if (best && best.id === 'uav-03') {
                    costBadge.textContent = '时间/效费比最优';
                } else {
                    costBadge.textContent = '效费比最优';
                }
                costBadge.className = 'recommend-badge rec-cost';
                costBadge.style.display = 'inline-block';
            }
        }
        function setShipDestination(lat, lng) {
            window._shipDestLat = lat;
            window._shipDestLng = lng;
            startShipMovement();
        }
        function startShipMovement() {
            if (window._shipMoveTimer) { clearInterval(window._shipMoveTimer); window._shipMoveTimer = null; }
            const stepKm = window._shipStepKm || 5;
            const moveInterval = window._shipMoveInterval || 1000;
            window._shipMoveTimer = setInterval(() => {
                if (!window.ship1Marker || !window.ship2Marker || typeof window._shipDestLat === 'undefined') return;
                const p1 = window.ship1Marker.getLatLng();
                const p2 = window.ship2Marker.getLatLng();
                const destLat = window._shipDestLat, destLng = window._shipDestLng;
                const dLat = destLat - p1.lat;
                const dLng = destLng - p1.lng;
                const kmLat = 111.32;
                const kmLon = 111.32 * Math.cos(p1.lat * Math.PI / 180);
                const dxKm = dLat * kmLat;
                const dyKm = dLng * kmLon;
                const distKm = Math.sqrt(dxKm * dxKm + dyKm * dyKm);
                if (distKm <= stepKm) {
                    window.ship1Marker.setLatLng([destLat, destLng]);
                    window.ship2Marker.setLatLng([destLat, destLng]);
                    window.shipFocusLat = destLat;
                    window.shipFocusLng = destLng;
                    clearInterval(window._shipMoveTimer);
                    window._shipMoveTimer = null;
                    return;
                }
                const scale = stepKm / distKm;
                const stepLat = dLat * scale;
                const stepLng = dLng * scale;
                window.ship1Marker.setLatLng([p1.lat + stepLat, p1.lng + stepLng]);
                window.ship2Marker.setLatLng([p2.lat + stepLat, p2.lng + stepLng]);
                window.shipFocusLat = (window.ship1Marker.getLatLng().lat);
                window.shipFocusLng = (window.ship1Marker.getLatLng().lng);
            }, moveInterval);
        }
        // Show Intel Popup on Load
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('intelPopup').classList.add('show');
                
                const locSel = document.getElementById('monitor-location-select');
                if (locSel) {
                    locSel.value = 'loc-okinawa-sawada';
                    const change = locSel.onchange;
                    if (typeof change === 'function') change();
                }
                
                // Simulate receiving new intel
                const newIntel = {
                    title: "东部战区美国两艘舰艇过航台湾海峡",
                    time: "刚刚",
                    threat: "高等威胁",
                    image: "images/船.png",
                    desc: "东部战区055型驱逐舰传回影像中拍摄到两艘舰艇出现在冲绳岛附近海域驶向台湾海峡24°49'27\"N 125°01'35\"E，两艘美国军舰初步识别为驱逐舰和海洋测量船。"
                };

                // Add Map Markers for the Ships (25°15'38"N 125°00'11"E)
                // Lat: 25 + 15/60 + 38/3600 = 25.2606
                // Lng: 125 + 00/60 + 11/3600 = 125.0031
                const shipLat = 24.8242;
                const shipLng = 125.0264;
                
                // Store for focus function
                shipFocusLat = shipLat;
                shipFocusLng = shipLng;

                const SCALE = 0.8;
                const H = Math.round(24 * SCALE);
                const Lw = Math.round(48 * SCALE);
                const Tw = Math.round(2 * H / Math.sqrt(3));
                const W = Lw + Tw + Math.round(6 * SCALE);
                const VH = H + Math.round(6 * SCALE);
                const svgBlue = '<svg width="'+W+'" height="'+VH+'" viewBox="0 0 '+W+' '+VH+'" xmlns="http://www.w3.org/2000/svg"><polygon points="2,'+(H/2+3)+' '+(Tw+3)+',3 '+(Tw+3)+','+(H+3)+'" fill="none" stroke="#3b82f6" stroke-width="2"/><rect x="'+(Tw+3)+'" y="3" width="'+Lw+'" height="'+H+'" fill="none" stroke="#3b82f6" stroke-width="2"/><line x1="'+(Tw+3)+'" y1="3" x2="'+(Tw+3)+'" y2="'+(H+3)+'" stroke="#3b82f6" stroke-width="2"/></svg>';
                const enemyDestroyerIcon = L.divIcon({
                    className: 'destroyer-icon',
                    html: '<div style="filter: drop-shadow(0 0 4px rgba(59,130,246,0.5));">'+svgBlue+'</div>',
                    iconSize: [W, VH],
                    iconAnchor: [Math.round((W)/2), Math.round(VH/2)]
                });

                // Ship 1
                window.ship1Marker = L.marker([shipLat, shipLng], {icon: enemyDestroyerIcon}).addTo(map);
                
                const labelStyle = `
                    background: rgba(15, 23, 42, 0.9);
                    border: 1px solid #3b82f6;
                    color: white;
                    padding: 8px;
                    border-radius: 4px;
                    font-size: 12px;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                    min-width: 180px;
                `;

                ship1Marker.bindTooltip(`
                    <div style="${labelStyle}">
                        <div style="font-weight: bold; color: #3b82f6; margin-bottom: 4px; border-bottom: 1px solid rgba(59,130,246,0.3); padding-bottom: 2px;">
                            目标 A (DDG-114)
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                            <span style="color: #94a3b8;">型号:</span>
                            <span>拉尔夫·约翰逊号</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">置信度:</span>
                            <span style="color: #f59e0b; font-weight: bold;">45%</span>
                        </div>
                    </div>
                `, {permanent: true, direction: 'left', opacity: 1, className: 'custom-ship-tooltip', offset: [-40, 0], interactive: true}).openTooltip();
                ship1Marker.on('click', () => openShipPage('A'));
                const t1 = ship1Marker.getTooltip();
                if (t1) t1.on('click', () => openShipPage('A'));
                
                // Ship 2 (Offset slightly)
                window.ship2Marker = L.marker([shipLat + 0.005, shipLng + 0.008], {icon: enemyDestroyerIcon}).addTo(map);
                
                ship2Marker.bindTooltip(`
                    <div style="${labelStyle}">
                         <div style="font-weight: bold; color: #3b82f6; margin-bottom: 4px; border-bottom: 1px solid rgba(59,130,246,0.3); padding-bottom: 2px;">
                            目标 B (T-AGS 62)
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                            <span style="color: #94a3b8;">型号:</span>
                            <span>鲍迪奇号勘测船</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">置信度:</span>
                            <span style="color: #f59e0b; font-weight: bold;">30%</span>
                        </div>
                    </div>
                `, {permanent: true, direction: 'right', opacity: 1, className: 'custom-ship-tooltip', offset: [40, 0], interactive: true}).openTooltip();
                ship2Marker.on('click', () => openShipPage('B'));
                const t2click = ship2Marker.getTooltip();
                if (t2click) t2click.on('click', () => openShipPage('B'));

                const friendlyHeadingDeg = 203.8;
                const radarCenterDeg = friendlyHeadingDeg;
                const friendlyLat = 27 + 1/60 + 55/3600;
                const friendlyLng = 124 + 2/60 + 5/3600;
                const svgRed = '<svg width="'+W+'" height="'+VH+'" viewBox="0 0 '+W+' '+VH+'" xmlns="http://www.w3.org/2000/svg"><polygon points="2,'+(H/2+3)+' '+(Tw+3)+',3 '+(Tw+3)+','+(H+3)+'" fill="none" stroke="#ef4444" stroke-width="2"/><rect x="'+(Tw+3)+'" y="3" width="'+Lw+'" height="'+H+'" fill="none" stroke="#ef4444" stroke-width="2"/><line x1="'+(Tw+3)+'" y1="3" x2="'+(Tw+3)+'" y2="'+(H+3)+'" stroke="#ef4444" stroke-width="2"/></svg>';
                const friendlyDestroyerIcon = L.divIcon({
                    className: 'destroyer-icon friendly',
                    html: '<div style="transform: rotate('+(radarCenterDeg+90)+'deg); transform-origin: 50% 50%; filter: drop-shadow(0 0 4px rgba(239,68,68,0.5));">'+svgRed+'</div>',
                    iconSize: [W, VH],
                    iconAnchor: [Math.round((W)/2), Math.round(VH/2)]
                });
                if (!window.friendly055Marker) {
                    window.friendly055Marker = L.marker([friendlyLat, friendlyLng], {icon: friendlyDestroyerIcon}).addTo(map);
                    window.friendly055Marker.bindTooltip(`
                    <div style="${labelStyle}">
                        <div style="font-weight: bold; color: #ef4444; margin-bottom: 4px; border-bottom: 1px solid rgba(239,68,68,0.3); padding-bottom: 2px;">
                            我方 055型驱逐舰
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                            <span style="color: #94a3b8;">航速:</span>
                            <span>12 节</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">航向:</span>
                            <span>203.8°</span>
                        </div>
                    </div>
                    `, {permanent: true, direction: 'bottom', opacity: 1, className: 'custom-ship-tooltip', offset: [0, 10], interactive: true}).openTooltip();
                    window.friendly055Marker.on('click', () => openShipPage('055'));
                    const t055 = window.friendly055Marker.getTooltip();
                    if (t055) t055.on('click', () => openShipPage('055'));
                }

                // Radar Detection Range Sector
                const sectorRadius = 450000; // 450km
                const sectorCenterAngle = 330;
                const sectorStartAngle = radarCenterDeg - (sectorCenterAngle / 2);
                const sectorEndAngle = radarCenterDeg + (sectorCenterAngle / 2);
                
                const getDestinationPoint = (lat, lng, brng, dist) => {
                    const R = 6378137; // Earth's radius in m
                    const rad = Math.PI / 180;
                    const lat1 = lat * rad;
                    const lon1 = lng * rad;
                    const brngRad = brng * rad;
                    
                    const lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist / R) +
                                Math.cos(lat1) * Math.sin(dist / R) * Math.cos(brngRad));
                    const lon2 = lon1 + Math.atan2(Math.sin(brngRad) * Math.sin(dist / R) * Math.cos(lat1),
                                Math.cos(dist / R) - Math.sin(lat1) * Math.sin(lat2));
                    
                    return [lat2 / rad, lon2 / rad];
                };

                const sectorPoints = [[friendlyLat, friendlyLng]];
                for (let i = sectorStartAngle; i <= sectorEndAngle; i += 2) {
                    sectorPoints.push(getDestinationPoint(friendlyLat, friendlyLng, i, sectorRadius));
                }
                sectorPoints.push(getDestinationPoint(friendlyLat, friendlyLng, sectorEndAngle, sectorRadius));
                
                if (!window._friendlyRadarLayer) {
                    window._friendlyRadarLayer = L.polygon(sectorPoints, {
                        color: '#ef4444',
                        weight: 1,
                        fillColor: '#ef4444',
                        fillOpacity: 0.1,
                        dashArray: '5, 5'
                    }).addTo(map);
                }

                // Add CSS for custom tooltip to remove default styles
                const style = document.createElement('style');
                style.innerHTML = `
                    .custom-ship-tooltip {
                        background: transparent !important;
                        border: none !important;
                        box-shadow: none !important;
                    }
                    .custom-ship-tooltip::before {
                        display: none !important;
                    }
                `;
                document.head.appendChild(style);

                // Fly to location to show markers
                map.flyTo([shipLat, shipLng], 9, {
                    animate: true,
                    duration: 2
                });

                // Projected Path Visualization
                // Current: 25.2606, 125.0031
                // Target: Taitung Offshore (East of Taiwan) ~22.8, 121.5
                // Path must stay east of Taiwan island to avoid land
                
                const startPt = [24.8242, 125.0264]; // 24°49'27"N 125°01'35"E
                const pathPoints = [
                    startPt, // Start (发现目标)
                    [25.3872, 121.5733], // WP1: 25°23'14"N 121°34'24"E
                    [25.1303, 120.9686], // WP2: 25°07'49"N 120°58'07"E
                    [24.2811, 120.2258]  // End: 24°16'52"N 120°13'33"E (彰化县附近海域)
                ];
                const a = window.ship1Marker ? window.ship1Marker.getLatLng() : null;
                const b = window.ship2Marker ? window.ship2Marker.getLatLng() : null;
                const vizPoints = (a && b)
                    ? [startPt, [a.lat, a.lng], [b.lat, b.lng], pathPoints[1], pathPoints[2], pathPoints[3]]
                    : pathPoints;

                // Draw Path Line
                const pathLine = L.polyline(vizPoints, {
                    color: '#3b82f6',
                    weight: 2,
                    dashArray: '10, 10',
                    opacity: 0.8
                }).addTo(map);

                // Add Arrow Heads to Path
                const arrowIcon = L.divIcon({
                    className: 'path-arrow',
                    html: '<i class="fa-solid fa-caret-down" style="color: #3b82f6; font-size: 16px; transform: rotate(135deg);"></i>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                
                L.marker([25.3872, 121.5733], {icon: arrowIcon}).addTo(map);
                L.marker([25.1303, 120.9686], {icon: arrowIcon}).addTo(map);

                window._shipVectorDeg = { dx: 25.3872 - shipLat, dy: 121.5733 - shipLng };

                // Add Destination Marker
                const destIcon = L.divIcon({
                    className: 'dest-marker',
                    html: '<div style="background: rgba(59, 130, 246, 0.2); border: 2px solid #3b82f6; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><div style="background: #3b82f6; width: 8px; height: 8px; border-radius: 50%;"></div></div>',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const destMarker = L.marker([24.2811, 120.2258], {icon: destIcon}).addTo(map);
                
                // Destination Label
                destMarker.bindTooltip(`
                    <div style="background: rgba(15, 23, 42, 0.9); border: 1px solid #3b82f6; color: white; padding: 6px 10px; border-radius: 4px; font-size: 12px; text-align: center;">
                        <div style="font-weight: bold; color: #3b82f6; margin-bottom: 2px;">彰化县附近海域</div>
                        <div>目标航段：经 WP1、WP2 抵达彰化</div>
                        <div style="font-size: 10px; color: #94a3b8; margin-top: 2px;">ETA: 12小时后</div>
                    </div>
                `, {permanent: true, direction: 'bottom', offset: [0, 10], className: 'custom-ship-tooltip'}).openTooltip();

                // Add to data source
                intelData.unshift(newIntel);
                currentIntelIndex = 0; // Switch to newest
                
                // Update UI
                updateIntelDisplay();
                
                // Update Badge Count
                const badge = document.querySelector('#intelCard .monitor-header span:last-child');
                if(badge) badge.textContent = intelData.length + "条";

                // Optional: Auto hide after 8 seconds
                setTimeout(() => {
                    closeIntelPopup();
                }, 8000);
            }, 10000);
        });

        function closeIntelPopup() {
            document.getElementById('intelPopup').classList.remove('show');
        }

        function showSolutionCard() {
            const data = intelData[currentIntelIndex];
            const allowed = '东部战区美国两艘舰艇过航台湾海峡';
            if (!data || data.title !== allowed) return;
            const solutionCard = document.getElementById('solutionCard');
            if (solutionCard) { solutionCard.style.display = 'flex'; solutionCard.classList.add('slide-in-right'); }
            renderPlanOverview();
            initCaseLib();
            renderFishbone();
            alignSolutionToIntel();
            if (typeof updateSolutionBodyLayout === 'function') updateSolutionBodyLayout();
        }

        function toggleMonitor() {
            const monitorCard = document.getElementById('monitorCard');

            if (monitorCard.style.display === 'none') {
                monitorCard.style.display = 'flex';
            } else {
                monitorCard.style.display = 'none';
            }
        }

        function toggleIntelPush() {
            const intelCard = document.getElementById('intelCard');
            const solutionCard = document.getElementById('solutionCard');

            if (intelCard.style.display === 'none') {
                intelCard.style.display = 'block';
            } else {
                intelCard.style.display = 'none';
                if (solutionCard) solutionCard.style.display = 'none';
            }
        }

        function toggleUavDispatch() { return; }

        function toggleSolutionFullscreen() {
            const card = document.getElementById('solutionCard');
            const btn = document.getElementById('solution-fullscreen-btn');
            if (!card) return;
            const isFs = card.getAttribute('data-fullscreen') === 'true';
            if (!isFs) {
                card.dataset.prevTop = card.style.top || '';
                card.dataset.prevRight = card.style.right || '';
                card.dataset.prevLeft = card.style.left || '';
                card.dataset.prevWidth = card.style.width || '';
                card.dataset.prevHeight = card.style.height || 'auto';
                card.setAttribute('data-fullscreen', 'true');
                const main = document.querySelector('.main-header');
                const sub = document.querySelector('.sub-header');
                const headerH = (main ? main.offsetHeight : 0) + (sub ? sub.offsetHeight : 0);
                const topPad = headerH + 10;
                const bottomPad = 10;
                card.style.position = 'fixed';
                card.style.left = '10px';
                card.style.top = topPad + 'px';
                card.style.right = '10px';
                card.style.width = 'calc(100vw - 20px)';
                card.style.height = `calc(100vh - ${topPad + bottomPad}px)`;
                card.style.zIndex = '3300';
                card.style.background = '#0b1220';
                card.style.border = '1px solid #0b1220';
                const body = card.querySelector('.monitor-body');
                if (body) {
                    body.style.display = 'grid';
                    body.style.gridTemplateColumns = '1fr 1fr';
                    body.style.gap = '12px';
                    body.style.overflowY = 'auto';
                    body.style.maxHeight = `calc(100% - 48px)`;
                    body.style.padding = '16px';
                    const snapshot = Array.from(body.children);
                    let left = document.getElementById('solution-left-col');
                    let right = document.getElementById('solution-right-col');
                    if (!left) { left = document.createElement('div'); left.id = 'solution-left-col'; left.style.display = 'block'; }
                    if (!right) { right = document.createElement('div'); right.id = 'solution-right-col'; right.style.display = 'block'; }
                    body.appendChild(left);
                    body.appendChild(right);
                    const intentH4 = Array.from(snapshot.map(n => Array.from(n.querySelectorAll ? n.querySelectorAll('h4') : [])).flat()).find(h => h.textContent.includes('意图分析'));
                    const planH4 = Array.from(snapshot.map(n => Array.from(n.querySelectorAll ? n.querySelectorAll('h4') : [])).flat()).find(h => h.textContent.includes('处置预案'));
                    const intentBlock = intentH4 ? intentH4.parentElement : null;
                    const planBlock = planH4 ? planH4.parentElement : null;
                    snapshot.forEach(node => {
                        if (node === intentBlock || node === planBlock) {
                            left.appendChild(node);
                        } else {
                            right.appendChild(node);
                        }
                    });
                }
                const header = card.querySelector('.monitor-header');
                if (header) {
                    header.style.background = '#0f172a';
                    header.style.borderBottom = '1px solid #1f2937';
                }
                const overview = document.getElementById('plan-section-overview');
                const caseSec = document.getElementById('plan-section-case');
                const recSec = document.getElementById('plan-section-recommend');
                if (overview) overview.style.display = 'block';
                if (caseSec) caseSec.style.display = 'block';
                if (recSec) recSec.style.display = 'block';
                const arrowO = document.getElementById('arrow-overview');
                const arrowC = document.getElementById('arrow-case');
                const arrowR = document.getElementById('arrow-recommend');
                if (arrowO) arrowO.textContent = '▼';
                if (arrowC) arrowC.textContent = '▼';
                if (arrowR) arrowR.textContent = '▼';
                const intentTitle = Array.from(card.querySelectorAll('h4')).find(h => h.textContent.includes('意图分析'));
                if (intentTitle) { intentTitle.style.fontSize = '16px'; intentTitle.style.color = '#ffffff'; }
                const planTitle = Array.from(card.querySelectorAll('h4')).find(h => h.textContent.includes('处置预案'));
                if (planTitle) { planTitle.style.fontSize = '16px'; planTitle.style.color = '#ffffff'; }
                Array.from(card.querySelectorAll('.intent-item .intent-left span')).forEach(s => { s.style.fontSize = '14px'; s.style.color = '#e5e7eb'; });
                Array.from(card.querySelectorAll('.intent-badge')).forEach(b => { b.style.color = '#ffffff'; });
                const recSecInline = document.getElementById('plan-section-recommend');
                const inlineBtn = document.getElementById('fishbone-detail-btn');
                if (inlineBtn) inlineBtn.style.display = 'none';
                let inlineCont = document.getElementById('fishbone-inline-container');
                if (!inlineCont && recSecInline) {
                    inlineCont = document.createElement('div');
                    inlineCont.id = 'fishbone-inline-container';
                    inlineCont.style.position = 'relative';
                    inlineCont.style.height = '320px';
                    inlineCont.style.border = '1px solid #475569';
                    inlineCont.style.borderRadius = '6px';
                    inlineCont.style.background = 'rgba(255,255,255,0.05)';
                    inlineCont.style.padding = '8px';
                    inlineCont.style.marginTop = '8px';
                    recSecInline.appendChild(inlineCont);
                }
                if (typeof renderFishbone === 'function' && inlineCont) renderFishbone('fishbone-inline-container');
                if (btn) btn.innerHTML = '<i class="fa-solid fa-compress"></i>';
            } else {
                card.setAttribute('data-fullscreen', 'false');
                card.style.position = 'absolute';
                card.style.right = card.dataset.prevRight || '20px';
                card.style.top = card.dataset.prevTop || '10px';
                card.style.left = card.dataset.prevLeft || '';
                card.style.width = card.dataset.prevWidth || '400px';
                card.style.height = card.dataset.prevHeight || 'auto';
                card.style.zIndex = '1001';
                card.style.background = 'rgba(30, 41, 59, 0.95)';
                card.style.border = '1px solid rgba(255, 255, 255, 0.1)';
                const body = card.querySelector('.monitor-body');
                if (body) {
                    body.style.display = 'block';
                    body.style.gridTemplateColumns = '';
                    body.style.gap = '';
                    body.style.overflowY = 'visible';
                    body.style.maxHeight = '';
                    if (typeof updateSolutionBodyLayout === 'function') updateSolutionBodyLayout();
                    body.style.padding = '15px';
                    const left = document.getElementById('solution-left-col');
                    const right = document.getElementById('solution-right-col');
                    if (left || right) {
                        const restore = [];
                        if (left) restore.push(...Array.from(left.children));
                        if (right) restore.push(...Array.from(right.children));
                        restore.forEach(node => body.insertBefore(node, left || right));
                        if (left) left.remove();
                        if (right) right.remove();
                    }
                }
                const header = card.querySelector('.monitor-header');
                if (header) {
                    header.style.background = '';
                    header.style.borderBottom = '';
                }
                if (typeof closeFishboneModal === 'function') closeFishboneModal();
                const inlineBtn = document.getElementById('fishbone-detail-btn');
                if (inlineBtn) inlineBtn.style.display = 'inline-block';
                const inlineCont = document.getElementById('fishbone-inline-container');
                if (inlineCont && inlineCont.parentElement) inlineCont.parentElement.removeChild(inlineCont);
                closeIntelSendInline();
                if (btn) btn.innerHTML = '<i class="fa-solid fa-expand"></i>';
            }
        }
        function updateSolutionBodyLayout() {
            const card = document.getElementById('solutionCard');
            if (!card) return;
            const body = card.querySelector('.monitor-body');
            const header = card.querySelector('.monitor-header');
            if (!body || !header) return;
            if (card.getAttribute('data-fullscreen') === 'true') {
                body.style.maxHeight = 'calc(100% - 48px)';
                body.style.overflowY = 'auto';
            } else {
                body.style.maxHeight = '';
                body.style.overflowY = 'visible';
                card.style.height = 'auto';
            }
        }
        function alignSolutionToIntel() {
            const intel = document.getElementById('intelCard');
            const solution = document.getElementById('solutionCard');
            if (!intel || !solution) return;
            if (solution.getAttribute('data-fullscreen') === 'true') return;
            const rect = intel.getBoundingClientRect();
            const top = rect.top + (window.scrollY || document.documentElement.scrollTop || 0);
            solution.style.top = Math.max(10, Math.round(top)) + 'px';
        }
        window.addEventListener('resize', () => { alignSolutionToIntel(); updateSolutionBodyLayout(); });
        window.addEventListener('load', () => { alignSolutionToIntel(); updateSolutionBodyLayout(); });
        const detailPanel = document.getElementById('monitorDetailPanel');
        const toggleBtn = document.getElementById('toggleDetailBtn');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                toggleDetails();
            });
        }
        function toggleDetails() {
            if (!detailPanel) return;
            if (detailPanel.style.display === 'flex') {
                detailPanel.style.display = 'none';
            } else {
                detailPanel.style.display = 'flex';
            }
        }

        const taiwanBBox = { minLat: 21.7, maxLat: 25.4, minLng: 120.0, maxLng: 122.1 };
        function approximatelyEqual(p, q) { return Math.abs(p[0] - q[0]) < 1e-9 && Math.abs(p[1] - q[1]) < 1e-9; }
        function insideBBox(lat, lng, b) { return lat >= b.minLat && lat <= b.maxLat && lng >= b.minLng && lng <= b.maxLng; }
        function intersectVertical(p1, p2, x) {
            const x1 = p1[1], x2 = p2[1];
            if ((x < Math.min(x1, x2)) || (x > Math.max(x1, x2))) return null;
            const t = (x - x1) / (x2 - x1);
            if (t < 0 || t > 1 || !isFinite(t)) return null;
            const y = p1[0] + (p2[0] - p1[0]) * t;
            return [y, x];
        }
        function intersectHorizontal(p1, p2, y) {
            const y1 = p1[0], y2 = p2[0];
            if ((y < Math.min(y1, y2)) || (y > Math.max(y1, y2))) return null;
            const t = (y - y1) / (y2 - y1);
            if (t < 0 || t > 1 || !isFinite(t)) return null;
            const x = p1[1] + (p2[1] - p1[1]) * t;
            return [y, x];
        }
        function bboxIntersections(p1, p2, b) {
            const pts = [];
            let p;
            p = intersectVertical(p1, p2, b.minLng); if (p && p[0] >= b.minLat && p[0] <= b.maxLat) pts.push(p);
            p = intersectVertical(p1, p2, b.maxLng); if (p && p[0] >= b.minLat && p[0] <= b.maxLat) pts.push(p);
            p = intersectHorizontal(p1, p2, b.minLat); if (p && p[1] >= b.minLng && p[1] <= b.maxLng) pts.push(p);
            p = intersectHorizontal(p1, p2, b.maxLat); if (p && p[1] >= b.minLng && p[1] <= b.maxLng) pts.push(p);
            return pts;
        }
        function mergeConsecutiveDuplicates(arr) {
            const res = [];
            for (let i = 0; i < arr.length; i++) {
                const p = arr[i];
                const last = res[res.length - 1];
                if (!last || !approximatelyEqual(p, last)) res.push(p);
            }
            return res;
        }
        function routeAroundLand(points) {
            const b = taiwanBBox;
            const off = 0.08;
            const out = [points[0]];
            for (let i = 0; i < points.length - 1; i++) {
                const a = points[i], c = points[i + 1];
                const ints = bboxIntersections(a, c, b);
                const aInside = insideBBox(a[0], a[1], b);
                const cInside = insideBBox(c[0], c[1], b);
                if (ints.length >= 2 || (aInside || cInside)) {
                    let entry = ints[0], exit = ints[1];
                    if (ints.length < 2) {
                        if (aInside && !cInside) { entry = a; exit = ints[0] || c; }
                        else if (!aInside && cInside) { entry = ints[0] || a; exit = c; }
                        else { entry = ints[0] || a; exit = ints[1] || c; }
                    }
                    const mid = (a[0] + c[0]) / 2;
                    const north = (b.minLat + b.maxLat) / 2;
                    const useTop = mid >= north;
                    const y = useTop ? b.maxLat + off : b.minLat - off;
                    const eLng = entry[1];
                    const xLng = exit[1];
                    if (!approximatelyEqual(out[out.length - 1], a)) out.push(a);
                    out.push([y, eLng]);
                    out.push([y, xLng]);
                    out.push(c);
                } else {
                    if (!approximatelyEqual(out[out.length - 1], a)) out.push(a);
                    out.push(c);
                }
            }
            return mergeConsecutiveDuplicates(out);
        }

        // UAV Selection Logic
        function selectUav(element, id) {
            // Remove selected class from all options
            const options = document.querySelectorAll('.uav-option');
            options.forEach(opt => opt.classList.remove('selected'));
            
            // Add to clicked
            element.classList.add('selected');
            document.getElementById('selected-uav-id').value = id;

            // Update Start/Return Coords and Draw Path
            updateFlightPath(id);
            window._lastSelectedUav = id;
            if (window._fpEditingEnabled) startFlightPathEditing(id);
        }

        function updateFlightPath(uavId) {
            flightPathLayerGroup.clearLayers();
            
            const base = uavBases[uavId];
            if (!base) return;

            // Fill Inputs
            const baseCoords = `${base.lat.toFixed(4)}°N, ${base.lng.toFixed(4)}°E`;
            if (startCoordsEl) startCoordsEl.textContent = baseCoords;
            if (returnCoordsEl) returnCoordsEl.textContent = baseCoords;

            // Draw Outbound Path (Base -> Target)
            const outboundPath = [
                [base.lat, base.lng],
                [currentTargetLat, currentTargetLng]
            ];

            let points = outboundPath;
            if (Array.isArray(window._uavWaypoints) && window._uavWaypoints.length > 0) {
                points = [[base.lat, base.lng], ...window._uavWaypoints, [currentTargetLat, currentTargetLng]];
            }
            points = routeAroundLand(points);
            L.polyline(points, {
                color: '#10b981',
                weight: 2,
                opacity: 0.9,
                dashArray: '5, 10'
            }).addTo(flightPathLayerGroup);

            // Draw Inbound Path (Target -> Base) - Slightly offset to show distinct path if needed, 
            // but physically it's usually same. To make it visible as "Return", we can curve it or just overlay.
            // Let's use a different color or style for return to distinguish.
            const inboundPoints = routeAroundLand([...points].reverse());
            L.polyline(inboundPoints, {
                color: '#3b82f6', // Blue for return
                weight: 2,
                opacity: 0.6,
                dashArray: '2, 8', // Different dash pattern
                offset: 5 // Polyline offset plugin needed for true offset, but standard L doesn't support.
                // Since we can't easily offset without plugin, we'll just render it. 
                // A better visual for "Round Trip" on same line is arrows.
                // However, user asked to "Show Both". 
            }).addTo(flightPathLayerGroup);

            // Add Return Marker (Same as Base for now, but explicit label)
            const returnIconHtml = `<div style="display:flex;flex-direction:column;align-items:center;">
                <div style="background:#3b82f6;width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>
                <span style="background:rgba(0,0,0,0.7);color:white;padding:2px 4px;border-radius:2px;font-size:10px;margin-top:2px;white-space:nowrap;">返航点</span>
            </div>`;

            L.marker([base.lat, base.lng], {
                icon: L.divIcon({
                    className: 'return-marker',
                    html: returnIconHtml,
                    iconSize: [40, 40],
                    iconAnchor: [20, 6] // Adjust anchor to center dot
                })
            }).addTo(flightPathLayerGroup);

             // Add Start Marker Label
            const startIconHtml = `<div style="display:flex;flex-direction:column;align-items:center;">
                <span style="background:rgba(0,0,0,0.7);color:white;padding:2px 4px;border-radius:2px;font-size:10px;margin-bottom:2px;white-space:nowrap;">起飞点</span>
                <div style="background:#10b981;width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>
            </div>`;

            L.marker([base.lat, base.lng], {
                icon: L.divIcon({
                    className: 'start-marker',
                    html: startIconHtml,
                    iconSize: [40, 40],
                    iconAnchor: [20, 34] // Adjust anchor so dot is at location
                })
            }).addTo(flightPathLayerGroup);
        }

        let _dispatchTimer = null;
        let _dispatchMarker = null;
        let _dispatchRangeCircle = null;
        function dispatchUav() {
            const uavId = document.getElementById('selected-uav-id').value || window._lastSelectedUav || 'uav-01';
            const base = uavBases[uavId];
            if (!base) return;
            updateFlightPath(uavId);
            if (_dispatchTimer) { clearInterval(_dispatchTimer); _dispatchTimer = null; }
            if (_dispatchMarker) { map.removeLayer(_dispatchMarker); _dispatchMarker = null; }
            if (_dispatchRangeCircle) { map.removeLayer(_dispatchRangeCircle); _dispatchRangeCircle = null; }
            const uavIconHtml = `<div style="display:flex;flex-direction:column;align-items:center;">
                <div style="background:#10b981;width:10px;height:10px;border-radius:50%;border:2px solid white;"></div>
                <span style="background:rgba(0,0,0,0.6);color:white;padding:2px 4px;border-radius:2px;font-size:10px;margin-top:2px;white-space:nowrap;">UAV</span>
            </div>`;
            _dispatchMarker = L.marker([base.lat, base.lng], { icon: L.divIcon({ className: 'uav-dispatch', html: uavIconHtml, iconSize: [28, 28], iconAnchor: [14, 6] }) });
            _dispatchMarker.addTo(map);
            _dispatchRangeCircle = L.circle([base.lat, base.lng], { radius: 20000, color: '#10b981', fillColor: '#10b981', fillOpacity: 0.08, weight: 1 });
            _dispatchRangeCircle.addTo(flightPathLayerGroup);

            // Update UAV status to "On Mission"
            const badgeEl = document.getElementById('badge-' + uavId);
            if (badgeEl) { badgeEl.textContent = '任务执行中'; badgeEl.style.background = 'rgba(245,158,11,0.2)'; badgeEl.style.color = '#f59e0b'; badgeEl.style.border = '1px solid rgba(245,158,11,0.4)'; }
            const optEl = document.getElementById('opt-' + uavId);
            if (optEl) { optEl.classList.add('in-mission'); }
            const totalMs = 30000;
            const steps = 60;
            const interval = Math.floor(totalMs / steps);
            let i = 0;
            const pathPointsRaw = (Array.isArray(window._uavWaypoints) && window._uavWaypoints.length > 0)
                ? [[base.lat, base.lng], ...window._uavWaypoints, [currentTargetLat, currentTargetLng]]
                : [[base.lat, base.lng], [currentTargetLat, currentTargetLng]];
            const pathPoints = routeAroundLand(pathPointsRaw);
            function kmPerDeg(lat) { return { lat: 111.32, lon: 111.32 * Math.cos(lat * Math.PI / 180) }; }
            const segLens = [];
            let totalKm = 0;
            for (let s = 0; s < pathPoints.length - 1; s++) {
                const a = pathPoints[s], b = pathPoints[s + 1];
                const k = kmPerDeg((a[0] + b[0]) / 2);
                const dx = (b[0] - a[0]) * k.lat;
                const dy = (b[1] - a[1]) * k.lon;
                const d = Math.sqrt(dx*dx + dy*dy);
                segLens.push(d); totalKm += d;
            }
            const cum = []; let acc = 0; for (let s = 0; s < segLens.length; s++) { acc += segLens[s]; cum.push(acc); }
            function posAtRatio(r) {
                const kmPos = r * totalKm;
                let idx = cum.findIndex(v => v >= kmPos);
                if (idx === -1) idx = segLens.length - 1;
                const prevKm = idx === 0 ? 0 : cum[idx - 1];
                const localR = segLens[idx] === 0 ? 0 : (kmPos - prevKm) / segLens[idx];
                const a = pathPoints[idx], b = pathPoints[idx + 1];
                const lat = a[0] + (b[0] - a[0]) * localR;
                const lng = a[1] + (b[1] - a[1]) * localR;
                return [lat, lng];
            }
            _dispatchTimer = setInterval(() => {
                i++;
                const t = Math.min(i / steps, 1);
                const pos = posAtRatio(t);
                _dispatchMarker.setLatLng(pos);
                if (_dispatchRangeCircle) _dispatchRangeCircle.setLatLng(pos);
                if (t >= 1) {
                    clearInterval(_dispatchTimer);
                    _dispatchTimer = null;
                    if (_dispatchRangeCircle) { map.removeLayer(_dispatchRangeCircle); _dispatchRangeCircle = null; }
                    L.circle([currentTargetLat, currentTargetLng], { radius: 800, color: '#10b981', fillColor: '#10b981', fillOpacity: 0.1, weight: 2, dashArray: '4,6' }).addTo(selectionLayerGroup);
                    if (window._shipMoveTimer) { clearInterval(window._shipMoveTimer); window._shipMoveTimer = null; }
                    window._shipFreezeAfterUavArrival = true;
                    window._shipDestLat = undefined;
                    window._shipDestLng = undefined;
                    setTimeout(() => { showUavReturnIntel(); }, 500);
                }
            }, interval);
            window._shipStepKm = 0.9;
            window._shipMoveInterval = 1000;
            if (typeof setShipDestination === 'function') setShipDestination(currentTargetLat, currentTargetLng);
        }

        function showUavReturnIntel() {
            const popup = document.getElementById('intelPopup');
            const content = popup ? popup.querySelector('.popup-content') : null;
            if (content) {
                content.innerHTML = '<h4 style="margin:0 0 4px 0;font-size:14px;color:#ffffff;">无人机回传确认</h4>'+
                    '<p style="margin:0;font-size:12px;color:#cbd5e1;">确认目标为“鲍迪奇”号海洋测量船与拉尔夫·约翰逊号驱逐舰，预测概率提高至 95%，威胁评估降至中等。</p>';
                popup.classList.add('show');
                setTimeout(() => { popup.classList.remove('show'); }, 8000);
            }

            if (window.ship1Marker) {
                const t = window.ship1Marker.getTooltip();
                const html = `
                    <div style="background: rgba(15, 23, 42, 0.9); border: 1px solid #3b82f6; color: white; padding: 8px; border-radius: 4px; font-size: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 180px;">
                        <div style="font-weight: bold; color: #3b82f6; margin-bottom: 4px; border-bottom: 1px solid rgba(59,130,246,0.3); padding-bottom: 2px;">
                            目标 A (DDG-114)
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                            <span style="color: #94a3b8;">型号:</span>
                            <span>拉尔夫·约翰逊号</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">置信度:</span>
                            <span style="color: #10b981; font-weight: bold;">95%</span>
                        </div>
                    </div>
                `;
                if (t) t.setContent(html); else window.ship1Marker.bindTooltip(html, {permanent: true, direction: 'left', opacity: 1, className: 'custom-ship-tooltip', offset: [-15, 0]}).openTooltip();
            }
            if (window.ship2Marker) {
                const t2 = window.ship2Marker.getTooltip();
                const html2 = `
                    <div style="background: rgba(15, 23, 42, 0.9); border: 1px solid #3b82f6; color: white; padding: 8px; border-radius: 4px; font-size: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 180px;">
                        <div style="font-weight: bold; color: #3b82f6; margin-bottom: 4px; border-bottom: 1px solid rgba(59,130,246,0.3); padding-bottom: 2px;">
                            目标 B (T-AGS 62)
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                            <span style="color: #94a3b8;">型号:</span>
                            <span>鲍迪奇号勘测船</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #94a3b8;">置信度:</span>
                            <span style="color: #10b981; font-weight: bold;">95%</span>
                        </div>
                    </div>
                `;
                if (t2) t2.setContent(html2); else window.ship2Marker.bindTooltip(html2, {permanent: true, direction: 'right', opacity: 1, className: 'custom-ship-tooltip', offset: [15, 0]}).openTooltip();
            }

            const newIntel = {
                title: '无人机回传：两舰型号识别与威胁评估更新',
                time: '刚刚',
                threat: '中等威胁',
                image: 'images/无人机拍摄船.png',
                images: ['无人机拍摄船.png','船.png'],
                desc: '通过融合无人机与卫星影像，确认目标为“鲍迪奇”号海洋测量船与拉尔夫·约翰逊号驱逐舰，预测概率提高至 95%，威胁评估从高降低至中等。'
            };
            intelData.unshift(newIntel);
            const idx = intelData.findIndex(d => d.title === '东部战区美国两艘舰艇过航台湾海峡');
            if (idx !== -1) intelData.splice(idx, 1);
            currentIntelIndex = 0;
            updateIntelDisplay();
            const badge = document.querySelector('#intelCard .monitor-header span:last-child');
            if (badge) badge.textContent = intelData.length + '条';
            const solutionCard = document.getElementById('solutionCard');
            if (solutionCard) solutionCard.style.display = 'flex';
            if (!window._shipFreezeAfterUavArrival && window.ship1Marker && window.ship2Marker && window._shipVectorDeg) {
                const moveKm = 15;
                const lat = window.ship1Marker.getLatLng().lat;
                const dxDeg = window._shipVectorDeg.dx;
                const dyDeg = window._shipVectorDeg.dy;
                const kmPerDegLat = 111.32;
                const kmPerDegLon = 111.32 * Math.cos(lat * Math.PI / 180);
                const totalKm = Math.sqrt(Math.pow(dxDeg * kmPerDegLat, 2) + Math.pow(dyDeg * kmPerDegLon, 2));
                const scale = moveKm / totalKm;
                const dLat = dxDeg * scale;
                const dLng = dyDeg * scale;
                const p1 = window.ship1Marker.getLatLng();
                const p2 = window.ship2Marker.getLatLng();
                window.ship1Marker.setLatLng([p1.lat + dLat, p1.lng + dLng]);
                window.ship2Marker.setLatLng([p2.lat + dLat, p2.lng + dLng]);
            }
        }

        // UAV Detail Logic
        function showUavDetails(e, title, type, range, endurance, payload) {
            e.stopPropagation(); // Prevent selection
            
            document.getElementById('uav-detail-title').textContent = title;
            document.getElementById('uav-detail-type').textContent = type;
            document.getElementById('uav-detail-range').textContent = range;
            document.getElementById('uav-detail-endurance').textContent = endurance;
            document.getElementById('uav-detail-payload').textContent = payload;

            document.getElementById('uav-detail-modal').style.display = 'flex';
            document.getElementById('overlay-backdrop').style.display = 'block';
        }

        function closeUavDetails() {
            document.getElementById('uav-detail-modal').style.display = 'none';
            document.getElementById('overlay-backdrop').style.display = 'none';
        }
        function openShipDetails(which) {
            const modal = document.getElementById('shipDetailModal');
            const overlay = document.getElementById('overlay-ship');
            const nameEl = document.getElementById('ship-detail-name');
            const commanderEl = document.getElementById('ship-detail-commander');
            const typeEl = document.getElementById('ship-detail-type');
            const displEl = document.getElementById('ship-detail-displ');
            const dimEl = document.getElementById('ship-detail-dim');
            const speedEl = document.getElementById('ship-detail-speed');
            const equipEl = document.getElementById('ship-detail-equip');
            const extraEl = document.getElementById('ship-detail-extra');
            const photoImg = document.getElementById('ship-detail-photo');
            const titleEl = document.getElementById('ship-detail-title');
            if (!modal || !overlay) return;
            if (which === 'A') {
                titleEl.textContent = '目标 A · DDG-114';
                if (nameEl) nameEl.innerHTML = '<a href="https://en.wikipedia.org/wiki/USS_Ralph_Johnson" target="_blank" style="color:#60a5fa; text-decoration:none;">USS Ralph Johnson (DDG-114)</a>';
                if (commanderEl) commanderEl.innerHTML = '<a href="https://zh.wikipedia.org/wiki/%E7%AC%AC%E4%B8%83%E8%89%A6%E9%9A%8A_(%E7%BE%8E%E5%9B%BD%E6%B5%B7%E8%BB%8D)" target="_blank" rel="noopener noreferrer" style="color:#3b82f6; text-decoration:underline; cursor:pointer;" onmouseover="this.style.color=\'#60a5fa\'; this.style.background=\'rgba(59,130,246,0.15)\'; this.style.borderRadius=\'4px\'; this.style.padding=\'0 2px\';" onmouseout="this.style.color=\'#3b82f6\'; this.style.background=\'transparent\'; this.style.padding=\'0 0\';">美国第七舰队（United States Seventh Fleet）</a>';
                typeEl.textContent = '阿利·伯克级 导弹驱逐舰 Flight IIA';
                displEl.textContent = '约 9,200 吨';
                dimEl.textContent = '长 155.3 m · 宽 20.1 m';
                speedEl.textContent = '30+ 节';
                equipEl.textContent = 'VLS(96) · SM-2/SM-6 · Tomahawk · ASROC · 127mm主炮 · CIWS · SPY-1D(V)';
                if (photoImg) { photoImg.src = 'images/DDG114.png'; photoImg.style.display = 'block'; }
                if (extraEl) extraEl.innerHTML = '<div style="font-weight:bold;color:#60a5fa;">基本信息</div><div>舷号：DDG-114；母港：日本横须贺（第七舰队）</div><div>命名来源：越战荣誉勋章获得者 Ralph H. Johnson</div><div style="margin-top:8px;font-weight:bold;color:#60a5fa;">技术参数</div><div>吃水：9.3 m；续航力：4200 海里@20节；乘员：军官22，士官兵308</div><div>动力：四台LM-2500-30燃气涡轮机，总功率约10万马力，双轴CRP双舵</div><div style="margin-top:8px;font-weight:bold;color:#60a5fa;">电子/作战系统</div><div>主雷达：AN/SPY-1D(V)；辅雷达：AN/SPS-67(V)3、AN/SPS-64(V)9</div><div>火控：AN/SPG-62×3；声纳：AN/SQS-53C、AN/SQR-19</div><div>电子战：AN/SLQ-32(V)3、MK-36干扰弹、AN/SLQ-25、Prairie Masker</div><div>作战系统：宙斯盾（Aegis）</div><div style="margin-top:8px;font-weight:bold;color:#60a5fa;">武器装备</div><div>127mm MK-45×1；MK-41 VLS（96单元）；鱼叉×8；CIWS×2；MK-38×2；12.7mm机枪×4；MK-32鱼雷×2</div><div style="margin-top:8px;font-weight:bold;color:#60a5fa;">任务履历</div><div>2019：第5舰队防空与海上威慑巡逻</div><div>2022–2024：南海“航行自由行动”、多国联合演练</div>';
            } else {
                titleEl.textContent = '目标 B · T-AGS 62';
                if (nameEl) nameEl.innerHTML = '<a href="https://en.wikipedia.org/wiki/USNS_Bowditch_(T-AGS-62)" target="_blank" style="color:#60a5fa; text-decoration:none;">USNS Bowditch (T-AGS 62)</a>';
                if (commanderEl) commanderEl.innerHTML = '<a href="https://zh.wikipedia.org/wiki/%E7%BE%8E%E5%9C%8B%E8%BB%8D%E4%BA%8B%E6%B5%B7%E9%81%8B%E5%8F%B8%E4%BB%A4%E9%83%A8" target="_blank" rel="noopener noreferrer" style="color:#3b82f6; text-decoration:underline; cursor:pointer;" onmouseover="this.style.color=\'#60a5fa\'; this.style.background=\'rgba(59,130,246,0.15)\'; this.style.borderRadius=\'4px\'; this.style.padding=\'0 2px\';" onmouseout="this.style.color=\'#3b82f6\'; this.style.background=\'transparent\'; this.style.padding=\'0 0\';">美国军事海运司令部（Military Sealift Command，MSC）</a>';
                typeEl.textContent = '海洋测量船 · Survey Ship';
                displEl.textContent = '约 4,762 吨';
                dimEl.textContent = '长 ~100 m · 宽 ~18 m';
                speedEl.textContent = '约 16 节';
                equipEl.textContent = '多波束测深 · 拖曳阵列 · AUV · ADCP · 磁力/重力仪（无武器装备）';
                if (photoImg) { photoImg.src = 'images/AGS62.png'; photoImg.style.display = 'block'; }
                if (extraEl) extraEl.innerHTML = '<div style="font-weight:bold;color:#60a5fa;">基本信息</div><div>舰级：探路者级海洋地理勘测船；舷号：T-AGS 62；交付/服役：1996年</div><div>建造商：Halter Marine；运营：MSC</div><div>编制：约25名平民船员 + 30余名技术/科研人员</div><div style="margin-top:8px;font-weight:bold;color:#60a5fa;">技术参数</div><div>全长：100.1 m；舷宽：17.7 m；满载排水量：4,762 吨</div><div>动力：柴-电推进，6×柴油发电机、2×电机、双轴，首助推器；续航：12,000 海里@12节；自持力：~30天</div><div style="margin-top:8px;font-weight:bold;color:#60a5fa;">任务与设备</div><div>多波束回声测深仪：1米级海底地形；拖曳声呐阵列：潜艇声纹/舰噪；AUV：深海测绘</div><div>ADCP：水流速度/方向/温度/盐度；磁力/重力仪：沉船/电缆/地质构造（明确无武器装备）</div><div style="margin-top:8px;font-weight:bold;color:#60a5fa;">历史任务</div><div>南海高强度常态作业：西沙/中沙周边，长期绘制海底地形与声学环境</div><div>2016-12-15：苏比克湾西北约50海里，无人滑翔器被中方打捞后归还</div><div>2025-02：与DDG-114协同过航台海；2025-05：澎湖西南约70km与“海洋二十九号”对峙后撤离</div>';
            }
            modal.style.display = 'flex';
            overlay.style.display = 'block';
        }
        function closeShipDetails() {
            document.getElementById('shipDetailModal').style.display = 'none';
            document.getElementById('overlay-ship').style.display = 'none';
        }
        function openShipPage(which) {
            const page = document.getElementById('shipDetailPage');
            const titleEl = document.getElementById('ship-page-title');
            const bodyEl = document.getElementById('ship-page-body');
            if (!page || !titleEl || !bodyEl) return;
            if (which === 'A') {
                titleEl.innerHTML = '<a href="https://en.wikipedia.org/wiki/USS_Ralph_Johnson" target="_blank" style="color:#60a5fa; text-decoration:none;">USS Ralph Johnson (DDG-114)</a>';
                bodyEl.innerHTML =
                    '<div style="margin-bottom:12px;color:#60a5fa;font-weight:bold;">基本信息</div>'+
                    '<div>舰级：阿利·伯克级 Flight IIA；舷号：DDG-114；母港：日本横须贺（第七舰队）</div>'+
                    '<div>指挥官：<a href="https://zh.wikipedia.org/wiki/%E7%AC%AC%E4%B8%83%E8%89%A6%E9%9A%8A_(%E7%BE%8E%E5%9B%BD%E6%B5%B7%E8%BB%8D)" target="_blank" rel="noopener noreferrer" style="color:#3b82f6; text-decoration:underline; cursor:pointer;" onmouseover="this.style.color=\'#60a5fa\'; this.style.background=\'rgba(59,130,246,0.15)\'; this.style.borderRadius=\'4px\'; this.style.padding=\'0 2px\';" onmouseout="this.style.color=\'#3b82f6\'; this.style.background=\'transparent\'; this.style.padding=\'0 0\';">美国第七舰队（United States Seventh Fleet）</a></div>'+
                    '<div>命名：越战荣誉勋章获得者 Ralph H. Johnson；建造：Huntington Ingalls</div>'+
                    '<div style="margin-top:8px;"><img src="images/DDG114.png" alt="DDG-114" style="max-width:100%; border:1px solid #475569; border-radius:6px;"></div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">技术参数</div>'+
                    '<div>长155m · 宽20.4m · 吃水9.3m · 满载约9200吨 · 最高航速32节 · 续航4200海里@20节</div>'+
                    '<div>乘员：军官22，士官兵308；动力：LM-2500-30×4，总功率约10万马力，双轴CRP双舵</div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">电子/作战系统</div>'+
                    '<div>主雷达：AN/SPY-1D(V)；辅雷达：AN/SPS-67(V)3、AN/SPS-64(V)9；火控：AN/SPG-62×3</div>'+
                    '<div>声纳：AN/SQS-53C、AN/SQR-19；电子战：AN/SLQ-32(V)3、MK-36、AN/SLQ-25、Prairie Masker</div>'+
                    '<div>作战系统：宙斯盾（Aegis）</div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">武器装备</div>'+
                    '<div>127mm MK-45×1；MK-41 VLS（96单元）；鱼叉×8；CIWS×2；MK-38×2；12.7mm机枪×4；MK-32鱼雷×2</div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">任务履历</div>'+
                    '<div>2019：第5舰队防空与海上威慑巡逻；2022–2024：南海“航行自由行动”、多国联合演练</div>'+
                    '<div>2024–2025：多次穿越台海，与T-AGS 62协同收集水文与声学数据</div>';
            } else if (which === '055') {
                titleEl.innerHTML = '<a href="https://zh.wikipedia.org/wiki/055%E5%9E%8B%E5%AF%BC%E5%BC%B9%E9%A9%B1%E9%80%90%E8%88%B0" target="_blank" style="color:#60a5fa; text-decoration:none;">055型导弹驱逐舰</a>';
                bodyEl.innerHTML =
                    '<div style="margin-bottom:12px;color:#60a5fa;font-weight:bold;">基本信息</div>'+
                    '<div>归类：第四代导弹驱逐舰</div>'+
                    '<div>角色：航母战斗群/远洋机动编队指挥中枢</div>'+
                    '<div style="margin-top:8px;"><img src="images/055船.png" alt="055型导弹驱逐舰" style="max-width:100%; border:1px solid #475569; border-radius:6px;"></div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">技术参数</div>'+
                    '<div>标准排水量：约11,000吨；满载：约13,400吨</div>'+
                    '<div>长度：180米；型宽：20米；吃水：6.6米；乘员：约300人</div>'+
                    '<div>动力：COGAG全燃联合；GT-25000×4（总功率约112MW）；最高航速＞30节；续航约5,000海里</div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">搜索/火控系统</div>'+
                    '<div>346B型有源相控阵雷达×4面；X波段有源相控阵火控雷达×4面</div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">武器装备</div>'+
                    '<div>舰载通用垂直发射系统：112单元（前64/后48），可装海红旗-9B/C、鹰击-18、鹰击-17/20、红旗-26、长剑-10等</div>'+
                    '<div>130mm H/PJ-45主炮×1；1130近防炮×1；红旗-10近程防空导弹×24；324mm三联鱼雷×2</div>'+
                    '<div>舰载机：直-20F反潜直升机×2</div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">作战能力</div>'+
                    '<div>具备区域防空、反导、反舰、反潜、对陆打击能力；构建多层防空火力网并组织协同作战；承担编队信息处理与战场态势管理</div>';
            } else {
                titleEl.innerHTML = '<a href="https://en.wikipedia.org/wiki/USNS_Bowditch_(T-AGS-62)" target="_blank" style="color:#60a5fa; text-decoration:none;">USNS Bowditch (T-AGS 62)</a>';
                bodyEl.innerHTML =
                    '<div style="margin-bottom:12px;color:#60a5fa;font-weight:bold;">基本信息</div>'+
                    '<div>舰级：探路者级海洋地理勘测船；舷号：T-AGS 62；交付/服役：1996年</div>'+
                    '<div>建造：Halter Marine；运营：MSC；编制：约25名平民船员+30余名技术/科研人员</div>'+
                    '<div>指挥官：<a href="https://zh.wikipedia.org/wiki/%E7%BE%8E%E5%9C%8B%E8%BB%8D%E4%BA%8B%E6%B5%B7%E9%81%8B%E5%8F%B8%E4%BB%A4%E9%83%A8" target="_blank" rel="noopener noreferrer" style="color:#3b82f6; text-decoration:underline; cursor:pointer;" onmouseover="this.style.color=\'#60a5fa\'; this.style.background=\'rgba(59,130,246,0.15)\'; this.style.borderRadius=\'4px\'; this.style.padding=\'0 2px\';" onmouseout="this.style.color=\'#3b82f6\'; this.style.background=\'transparent\'; this.style.padding=\'0 0\';">美国军事海运司令部（Military Sealift Command，MSC）</a></div>'+
                    '<div style="margin-top:8px;"><img src="images/AGS62.png" alt="T-AGS 62" style="max-width:100%; border:1px solid #475569; border-radius:6px;"></div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">技术参数</div>'+
                    '<div>长100.1m · 宽17.7m · 满载4762吨 · 柴电推进：6×柴油发电机、2×电机、双轴；首助推器</div>'+
                    '<div>最大航速16节 · 续航12000海里@12节 · 自持力约30天</div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">任务与设备</div>'+
                    '<div>多波束测深仪：1米级海底地形；拖曳阵列：潜艇声纹/舰噪；AUV：深海测绘</div>'+
                    '<div>ADCP：水流速度/方向/温度/盐度；磁力/重力仪：沉船/电缆/地质构造（无武器装备）</div>'+
                    '<div style="margin:12px 0;color:#60a5fa;font-weight:bold;">历史任务</div>'+
                    '<div>南海高强度常态作业：西沙/中沙周边，长期绘制海底地形与声学环境</div>'+
                    '<div>2016-12-15：苏比克湾西北约50海里，无人滑翔器被中方打捞后归还</div>'
            }
            page.style.display = 'flex';
        }
        function closeShipPage() {
            const page = document.getElementById('shipDetailPage');
            if (page) page.style.display = 'none';
        }

        // Map Initialization (Leaflet)
        // Coords: 24.0589, 120.4333
        const map = L.map('map', {
            center: [24.0589, 120.4333],
            zoom: 14,
            zoomControl: false, // Custom look
            attributionControl: false
        });
        map.createPane('boundariesPane');
        const bp = map.getPane('boundariesPane');
        if (bp) { bp.style.zIndex = 420; bp.style.pointerEvents = 'none'; }
        map.createPane('labelPane');
        const lp = map.getPane('labelPane');
        if (lp) { lp.style.zIndex = 410; lp.style.pointerEvents = 'none'; }

        // Chinese Base Layers
        const layerRoadCN = L.tileLayer('https://mt{s}.google.cn/vt/lyrs=m&x={x}&y={y}&z={z}', { subdomains: '0123', maxZoom: 19 });
        const layerSatCN = L.tileLayer('https://mt{s}.google.cn/vt/lyrs=s&x={x}&y={y}&z={z}', { subdomains: '0123', maxZoom: 19 });
        const layerHybridCN = L.tileLayer('https://mt{s}.google.cn/vt/lyrs=y&x={x}&y={y}&z={z}', { subdomains: '0123', maxZoom: 19 });
        const layerTerrainCN = L.tileLayer('https://mt{s}.google.cn/vt/lyrs=p&x={x}&y={y}&z={z}', { subdomains: '0123', maxZoom: 19 });
        // Global fallbacks
        const layerOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { subdomains: 'abc', maxZoom: 19 });
        const layerEsri = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
        const layerBoundaries = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, pane: 'boundariesPane', opacity: 1 });
        const layerLabelsCN = L.tileLayer('https://mt{s}.google.cn/vt/lyrs=h&x={x}&y={y}&z={z}', { subdomains: '0123', maxZoom: 19, pane: 'labelPane' });
        function applyBaseLayers(layers) {
            if (Array.isArray(window._mapBaseLayers)) {
                window._mapBaseLayers.forEach(l => map.removeLayer(l));
            }
            layers.forEach(l => l.addTo(map));
            window._mapBaseLayers = layers;
        }
        function setMapStyle(style) {
            const btns = {
                road: document.getElementById('btn-style-road'),
                sat: document.getElementById('btn-style-sat'),
                hybrid: document.getElementById('btn-style-hybrid'),
                terrain: document.getElementById('btn-style-terrain')
            };
            Object.values(btns).forEach(b => { if (b) { b.style.background = '#334155'; b.style.border = '1px solid #475569'; } });
            if (style === 'road') {
                applyBaseLayers([layerRoadCN]);
                if (btns.road) { btns.road.style.background = '#3b82f6'; btns.road.style.border = '1px solid #60a5fa'; }
                const s = document.getElementById('map-status'); if (s) s.textContent = '已切换至道路图层';
                const active = window._mapBaseLayers && window._mapBaseLayers[0]; 
                if (active) { 
                    if (active.off) active.off('tileerror'); 
                    active.on('tileerror', function() { 
                        applyBaseLayers([layerOSM]); 
                        const s2 = document.getElementById('map-status'); if (s2) s2.textContent = '道路图层加载失败，已切换至OSM'; 
                    }); 
                }
            } else if (style === 'sat') {
                applyBaseLayers([layerSatCN, layerLabelsCN]);
                if (btns.sat) { btns.sat.style.background = '#3b82f6'; btns.sat.style.border = '1px solid #60a5fa'; }
                const s = document.getElementById('map-status'); if (s) s.textContent = '已切换至卫星图层（中文标注）';
                const active = window._mapBaseLayers && window._mapBaseLayers[0]; 
                if (active) { 
                    if (active.off) active.off('tileerror'); 
                    active.on('tileerror', function() { 
                        applyBaseLayers([layerEsri]); 
                        const s2 = document.getElementById('map-status'); if (s2) s2.textContent = '卫星图层加载失败，已切换至ESRI卫星'; 
                    }); 
                }
            } else if (style === 'terrain') {
                applyBaseLayers([layerTerrainCN]);
                if (btns.terrain) { btns.terrain.style.background = '#3b82f6'; btns.terrain.style.border = '1px solid #60a5fa'; }
                const s = document.getElementById('map-status'); if (s) s.textContent = '已切换至地形图层';
                const active = window._mapBaseLayers && window._mapBaseLayers[0]; 
                if (active) { 
                    if (active.off) active.off('tileerror'); 
                    active.on('tileerror', function() { 
                        setMapStyle('road'); 
                        const s2 = document.getElementById('map-status'); if (s2) s2.textContent = '地形图层加载失败，已切换至道路'; 
                    }); 
                }
            } else {
                applyBaseLayers([layerHybridCN]);
        layerBoundaries.addTo(map);
        window._mapBoundaryLayer = layerBoundaries;
        function loadChinaBoundary() {
            const url = 'https://services.arcgis.com/P3ePLMYs2RVChkJx/ArcGIS/rest/services/World_Administrative_Boundaries/FeatureServer/0/query?where=ISO%3D%27CHN%27&outFields=NAME%2CISO&outSR=4326&f=geojson';
            fetch(url).then(r => r.json()).then(data => {
                if (data && (data.features || data.type === 'FeatureCollection')) {
                    if (window._chinaBoundaryLayer) { map.removeLayer(window._chinaBoundaryLayer); }
                    window._chinaBoundaryLayer = L.geoJSON(data, {
                        style: { color: '#fbbf24', weight: 3, opacity: 0.95, dashArray: '6,4' }
                    }).addTo(map);
                    const s = document.getElementById('map-status'); if (s) s.textContent = '已加载中国国界线';
                } else {
                    const s = document.getElementById('map-status'); if (s) s.textContent = '国界线数据为空';
                }
            }).catch(() => {
                const s = document.getElementById('map-status'); if (s) s.textContent = '国界线加载失败';
            });
        }
                if (btns.hybrid) { btns.hybrid.style.background = '#3b82f6'; btns.hybrid.style.border = '1px solid #60a5fa'; }
                const s = document.getElementById('map-status'); if (s) s.textContent = '已切换至混合图层';
                const active = window._mapBaseLayers && window._mapBaseLayers[0]; 
                if (active) { 
                    if (active.off) active.off('tileerror'); 
                    active.on('tileerror', function() { 
                        applyBaseLayers([layerEsri]); 
                        const s2 = document.getElementById('map-status'); if (s2) s2.textContent = '混合图层加载失败，已切换至ESRI卫星'; 
                    }); 
                }
            }
        }
        setMapStyle('road');
        function ensureFriendly055Added() {
            if (window.friendly055Marker) return;
            if (!window._customTooltipStyleAdded) {
                const style = document.createElement('style');
                style.innerHTML = `
                    .custom-ship-tooltip,
                    .leaflet-tooltip.custom-ship-tooltip,
                    .leaflet-tooltip-pane .custom-ship-tooltip {
                        background: transparent !important;
                        border: none !important;
                        box-shadow: none !important;
                    }
                    .custom-ship-tooltip::before,
                    .leaflet-tooltip.custom-ship-tooltip::before {
                        display: none !important;
                    }
                `;
                document.head.appendChild(style);
                window._customTooltipStyleAdded = true;
            }
            const SCALE = 0.8;
            const H = Math.round(24 * SCALE);
            const Lw = Math.round(48 * SCALE);
            const Tw = Math.round(2 * H / Math.sqrt(3));
            const W = Lw + Tw + Math.round(6 * SCALE);
            const VH = H + Math.round(6 * SCALE);
            const friendlyHeadingDeg = 203.8;
            const radarCenterDeg = friendlyHeadingDeg;
            const friendlyLat = 27 + 1/60 + 55/3600;
            const friendlyLng = 124 + 2/60 + 5/3600;
            const svgRed = '<svg width="'+W+'" height="'+VH+'" viewBox="0 0 '+W+' '+VH+'" xmlns="http://www.w3.org/2000/svg"><polygon points="2,'+(H/2+3)+' '+(Tw+3)+',3 '+(Tw+3)+','+(H+3)+'" fill="none" stroke="#ef4444" stroke-width="2"/><rect x="'+(Tw+3)+'" y="3" width="'+Lw+'" height="'+H+'" fill="none" stroke="#ef4444" stroke-width="2"/><line x1="'+(Tw+3)+'" y1="3" x2="'+(Tw+3)+'" y2="'+(H+3)+'" stroke="#ef4444" stroke-width="2"/></svg>';
            const friendlyDestroyerIcon = L.divIcon({
                className: 'destroyer-icon friendly',
                html: '<div style="transform: rotate('+(radarCenterDeg+90)+'deg); transform-origin: 50% 50%; filter: drop-shadow(0 0 4px rgba(239,68,68,0.5));">'+svgRed+'</div>',
                iconSize: [W, VH],
                iconAnchor: [Math.round((W)/2), Math.round(VH/2)]
            });
            window.friendly055Marker = L.marker([friendlyLat, friendlyLng], {icon: friendlyDestroyerIcon}).addTo(map);
            const tipHtml = '<div style="background: rgba(15, 23, 42, 0.9); border: 1px solid #ef4444; color: white; padding: 8px; border-radius: 4px; font-size: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 180px;">'
                + '<div style="font-weight: bold; color: #ef4444; margin-bottom: 4px; border-bottom: 1px solid rgba(239,68,68,0.3); padding-bottom: 2px;">我方 055型驱逐舰</div>'
                + '<div style="display: flex; justify-content: space-between; margin-bottom: 2px;"><span style="color: #94a3b8;">航速:</span><span>12 节</span></div>'
                + '<div style="display: flex; justify-content: space-between;"><span style="color: #94a3b8;">航向:</span><span>203.8°</span></div>'
                + '</div>';
            window.friendly055Marker.bindTooltip(tipHtml, {permanent: true, direction: 'bottom', opacity: 1, className: 'custom-ship-tooltip', offset: [0, 10], interactive: true}).openTooltip();
            window.friendly055Marker.on('click', () => openShipPage('055'));
            const tt055 = window.friendly055Marker.getTooltip();
            if (tt055) tt055.on('click', () => openShipPage('055'));
            if (!window._friendlyRadarLayer) {
                const sectorRadius = 450000;
                const sectorCenterAngle = 330;
                const sectorStartAngle = radarCenterDeg - (sectorCenterAngle / 2);
                const sectorEndAngle = radarCenterDeg + (sectorCenterAngle / 2);
                const getDestinationPoint = (lat, lng, brng, dist) => {
                    const R = 6378137;
                    const rad = Math.PI / 180;
                    const lat1 = lat * rad;
                    const lon1 = lng * rad;
                    const brngRad = brng * rad;
                    const lat2 = Math.asin(Math.sin(lat1) * Math.cos(dist / R) + Math.cos(lat1) * Math.sin(dist / R) * Math.cos(brngRad));
                    const lon2 = lon1 + Math.atan2(Math.sin(brngRad) * Math.sin(dist / R) * Math.cos(lat1), Math.cos(dist / R) - Math.sin(lat1) * Math.sin(lat2));
                    return [lat2 / rad, lon2 / rad];
                };
                const sectorPoints = [[friendlyLat, friendlyLng]];
                for (let i = sectorStartAngle; i <= sectorEndAngle; i += 2) {
                    sectorPoints.push(getDestinationPoint(friendlyLat, friendlyLng, i, sectorRadius));
                }
                sectorPoints.push(getDestinationPoint(friendlyLat, friendlyLng, sectorEndAngle, sectorRadius));
                window._friendlyRadarLayer = L.polygon(sectorPoints, { color: '#ef4444', weight: 1, fillColor: '#ef4444', fillOpacity: 0.1, dashArray: '5, 5' }).addTo(map);
            }
        }
        ensureFriendly055Added();
        function ensureCommandPostAdded() {
            if (window.commandPostMarker) return;
            const W = Math.round(80 * 0.5); // rectangle width (50% size)
            const H = Math.round(W / 2); // rectangle height (2:1)
            const LINE_X = 3; // vertical line x
            const LINE_LEN = W; // vertical line length = width (half of previous)
            const VB_W = W + LINE_X + 6;
            const VB_H = LINE_LEN + 6;
            const svg = '<svg width="'+VB_W+'" height="'+VB_H+'" viewBox="0 0 '+VB_W+' '+VB_H+'" xmlns="http://www.w3.org/2000/svg">'
                + '<rect x="'+LINE_X+'" y="3" width="'+W+'" height="'+H+'" fill="none" stroke="#ef4444" stroke-width="3"/>'
                + '<line x1="'+LINE_X+'" y1="3" x2="'+LINE_X+'" y2="'+(LINE_LEN+3)+'" stroke="#ef4444" stroke-width="3"/>'
                + '</svg>';
            const commandPostIcon = L.divIcon({
                className: 'command-post-icon',
                html: '<div style="filter: drop-shadow(0 0 4px rgba(239,68,68,0.5));">'+svg+'</div>',
                iconSize: [VB_W, VB_H],
                iconAnchor: [Math.round(VB_W/2), Math.round(VB_H/2)]
            });
            const cpLat = 24 + 48/60 + 55/3600;
            const cpLng = 118 + 3/60 + 53/3600;
            window.commandPostMarker = L.marker([cpLat, cpLng], {icon: commandPostIcon}).addTo(map);
            const tipHtml = '<div style="background: rgba(15, 23, 42, 0.9); border: 1px solid #ef4444; color: white; padding: 8px; border-radius: 4px; font-size: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 160px;">'
                + '<div style="font-weight: bold; color: #ef4444; margin-bottom: 4px; border-bottom: 1px solid rgba(239,68,68,0.3); padding-bottom: 2px;">我方指挥所</div>'
                + '<div style="display: flex; justify-content: space-between;"><span style="color: #94a3b8;">位置:</span><span>24°48\'55"N, 118°03\'53"E</span></div>'
                + '</div>';
            window.commandPostMarker.bindTooltip(tipHtml, {permanent: true, direction: 'left', opacity: 1, className: 'custom-ship-tooltip', offset: [-50, 0], interactive: true}).openTooltip();
        }
        ensureCommandPostAdded();

        // Custom Icons
        const redMarkerIcon = L.divIcon({
            className: 'custom-marker-wrapper',
            html: '<div class="map-marker"></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        const blueMarkerIcon = L.divIcon({
             className: 'custom-marker-wrapper',
             html: '<div class="map-marker" style="background: #3b82f6;"></div>',
             iconSize: [20, 20],
             iconAnchor: [10, 10]
         });

         // rangeCircleIcon removed - using L.circle instead

        // Add Initial Center Marker
        L.marker([24.0589, 120.4333], { icon: redMarkerIcon }).addTo(map);

        // Selection Logic
         const targetInput = document.getElementById('target-coords');
         const startCoordsEl = document.getElementById('uav-start-coords');
         const returnCoordsEl = document.getElementById('uav-return-coords');
         let selectionLayerGroup = L.layerGroup().addTo(map);
         let flightPathLayerGroup = L.layerGroup().addTo(map);
         let waypointLayerGroup = L.layerGroup().addTo(map);
         let monitorLayerGroup = L.layerGroup().addTo(map);
         let monitorLocationsLayerGroup = L.layerGroup().addTo(map);
         let nfzLayerGroup = L.layerGroup().addTo(map);
         let boundaryLayerGroup = L.layerGroup().addTo(map);
         let isPickingMode = false;
         let currentTargetLat = 24.0589;
         let currentTargetLng = 120.4333;
 
         const nfzZones = [
             { name: '禁飞区A·南海', reason: '政治敏感区域', color: '#ef4444', coords: [
                 [16.6, 111.0], [16.2, 112.2], [17.4, 113.1], [18.0, 112.4], [17.6, 111.2]
             ]},
             { name: '禁飞区B·东海', reason: '军事演习', color: '#f59e0b', coords: [
                 [28.3, 122.0], [27.9, 123.2], [28.7, 124.4], [30.1, 124.0], [29.5, 122.6]
             ]}
         ];
         nfzZones.forEach(z => {
             const poly = L.polygon(z.coords, { color: z.color, weight: 1.5, fillColor: z.color, fillOpacity: 0.2 }).addTo(nfzLayerGroup);
             const coordLines = z.coords.map(p => `${p[0].toFixed(4)}°N, ${p[1].toFixed(4)}°E`).join('<br/>');
             const centerLat = z.coords.reduce((a, c) => a + c[0], 0) / z.coords.length;
             const centerLng = z.coords.reduce((a, c) => a + c[1], 0) / z.coords.length;
             const centerLine = `${centerLat.toFixed(4)}°N, ${centerLng.toFixed(4)}°E`;
             const reasonColor = (String(z.reason).includes('演习')) ? '#f59e0b' : (String(z.reason).includes('政治')) ? '#ef4444' : '#3b82f6';
             const tipHtml = ''
                 + '<div style="font-size:12px; color:#e2e8f0; line-height:1.6;">'
                 +   '<div style="font-size:13px; color:#ffffff; font-weight:700; margin-bottom:4px;">' + z.name + '</div>'
                 +   '<div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">'
                 +       '<span style="display:inline-block; background:' + reasonColor + '; color:#0b1220; padding:2px 8px; border-radius:999px; font-size:11px; font-weight:700;">' + z.reason + '</span>'
                 +       '<span style="font-size:11px; color:#94a3b8;">中心点：' + centerLine + '</span>'
                 +   '</div>'
                 +   '<div style="font-size:11px; color:#94a3b8; margin-bottom:2px;">顶点坐标</div>'
                 +   '<div style="max-height:120px; overflow:auto; white-space:nowrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \'Liberation Mono\', \'Courier New\', monospace;">' + coordLines + '</div>'
                 + '</div>';
             poly.bindTooltip(tipHtml, { direction: 'top', sticky: true, opacity: 1, className: 'nfz-tooltip' });
         });
 
         loadChinaBoundary();

         // UAV Base Locations (Approximate for demo)
         const uavBases = {
             'uav-01': { lat: 25.05, lng: 119.50, name: 'Base B (Pingtan)' },
             'uav-02': { lat: 24.25, lng: 118.10, name: 'Base A (Xiamen)' },
             'uav-03': { lat: 23.50, lng: 117.00, name: 'Base C (Shantou)' }
         };

         function enableMapPicking() {
            isPickingMode = true;
            document.getElementById('map').style.cursor = 'crosshair';
            console.log("Map picking enabled. Click map to select.");
        }

        function disableMapPicking() {
            isPickingMode = false;
            document.getElementById('map').style.cursor = 'grab';
        }

        // Map Click Event
        map.on('click', function(e) {
            if (!isPickingMode) return;

            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            
            currentTargetLat = parseFloat(lat);
            currentTargetLng = parseFloat(lng);

            // Update Input
            targetInput.value = `${lat}°N, ${lng}°E`;

            // Clear previous selection
            selectionLayerGroup.clearLayers();
            flightPathLayerGroup.clearLayers(); // Clear flight paths on new target

            // Add Blue Marker
            L.marker([lat, lng], { icon: blueMarkerIcon }).addTo(selectionLayerGroup);

            // Add Range Circle (15km radius)
            // L.circle creates a circle with radius in meters that scales with the map
            L.circle([lat, lng], {
                radius: 15000, // 15km in meters
                color: '#3b82f6',
                dashArray: '10, 10',
                fillColor: '#3b82f6',
                fillOpacity: 0.1,
                weight: 2
            }).addTo(selectionLayerGroup);

            // Re-analyze UAV recommendations based on new location
            analyzeRecommendations(lat, lng);
            
            // Clear UAV selection inputs
            if (startCoordsEl) startCoordsEl.textContent = '';
            if (returnCoordsEl) returnCoordsEl.textContent = '';
            document.querySelectorAll('.uav-option').forEach(opt => opt.classList.remove('selected'));
        });

        // Mock Analysis Function
        function analyzeRecommendations(lat, lng) {
            // In a real app, this would calculate distance from base to target (lat, lng)
            // Here we simulate dynamic changes to distance and recommendations
            
            // Randomize distances slightly to simulate different target location
            const d1 = Math.floor(Math.random() * 20) + 10; // 10-30km
            const d2 = Math.floor(Math.random() * 20) + 20; // 20-40km
            const d3 = Math.floor(Math.random() * 20) + 30; // 30-50km

            document.getElementById('dist-uav-01').textContent = d1 + 'km';
            document.getElementById('dist-uav-02').textContent = d2 + 'km';
            document.getElementById('dist-uav-03').textContent = d3 + 'km';

            // Logic: 
            // Time Optimal -> Shortest Distance
            // Cost Optimal -> Usually Long Range / Efficient (Let's say UAV-03 BZK is always most efficient)
            // Safety Optimal -> UAV-02 WL-2 (Assumed better defensive suite)

            // Reset badges
            document.getElementById('badge-uav-01').className = 'recommend-badge';
            document.getElementById('badge-uav-01').textContent = '';
            document.getElementById('badge-uav-01').style.display = 'none';

            document.getElementById('badge-uav-02').className = 'recommend-badge';
            document.getElementById('badge-uav-02').textContent = '';
            document.getElementById('badge-uav-02').style.display = 'none';

            document.getElementById('badge-uav-03').className = 'recommend-badge';
            document.getElementById('badge-uav-03').textContent = '';
            document.getElementById('badge-uav-03').style.display = 'none';

            // Find shortest distance for Time Optimal
            const dists = [{id: '01', d: d1}, {id: '02', d: d2}, {id: '03', d: d3}];
            dists.sort((a, b) => a.d - b.d);
            const shortest = dists[0];

            // Apply Time Optimal
            const timeBadge = document.getElementById('badge-uav-' + shortest.id);
            timeBadge.textContent = '时间最优';
            timeBadge.className = 'recommend-badge rec-time';
            timeBadge.style.display = 'inline-block';

            // Apply Safety Optimal (Static preference for WL-2 for demo, unless it's also time optimal, then maybe stack or just show one)
            // Let's assume WL-2 is always Safety Optimal
            if (shortest.id !== '02') {
                const safetyBadge = document.getElementById('badge-uav-02');
                safetyBadge.textContent = '安全性最优';
                safetyBadge.className = 'recommend-badge rec-safety';
                safetyBadge.style.display = 'inline-block';
            } else {
                 // If WL-2 is also time optimal, maybe append text or just leave as Time Optimal (User asked for re-analysis, simple logic for now)
                 // Or we can say WL-2 is Time & Safety
                 timeBadge.textContent = '时间/安全最优';
            }

            // Apply Cost Optimal (Static preference for BZK-005)
            if (shortest.id !== '03') {
                const costBadge = document.getElementById('badge-uav-03');
                costBadge.textContent = '效费比最优';
                costBadge.className = 'recommend-badge rec-cost';
                costBadge.style.display = 'inline-block';
            } else {
                 const combinedBadge = document.getElementById('badge-uav-03');
                 if (combinedBadge.textContent.includes('时间')) {
                     combinedBadge.textContent = '时间/效费比最优';
                 }
            }
        }

        // Enter key to confirm
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && isPickingMode) {
                disableMapPicking();
            }
        });

        /* 
           Old Overlay Logic removed since Leaflet handles interactions natively.
        */

        // Graticule (Lat/Lon Grid) Implementation
        const graticuleLayer = L.layerGroup().addTo(map);
        
        function updateGraticule() {
            graticuleLayer.clearLayers();
            const zoom = map.getZoom();
            
            // Determine interval based on zoom
            let interval = 10;
            if (zoom >= 5) interval = 5;
            if (zoom >= 7) interval = 1;
            if (zoom >= 10) interval = 0.5;
            if (zoom >= 12) interval = 0.1; // ~11km
            if (zoom >= 15) interval = 0.01; // ~1.1km

            const bounds = map.getBounds();
            const north = bounds.getNorth();
            const south = bounds.getSouth();
            const west = bounds.getWest();
            const east = bounds.getEast();

            // Style
            const lineStyle = {
                color: 'rgba(255, 255, 255, 0.3)',
                weight: 1,
                dashArray: '4, 4',
                interactive: false
            };

            // Draw Longitude Lines (Vertical)
            const startLng = Math.ceil(west / interval) * interval;
            const endLng = Math.floor(east / interval) * interval;
            
            for (let lng = startLng; lng <= endLng; lng += interval) {
                // Round to avoid float errors
                const currentLng = Math.round(lng * 1000) / 1000;
                
                L.polyline([[south, currentLng], [north, currentLng]], lineStyle).addTo(graticuleLayer);
                
                // Label (at top)
                const labelIcon = L.divIcon({
                    className: 'graticule-label',
                    html: `<span style="color: rgba(255,255,255,0.5); font-size: 10px; text-shadow: 1px 1px 2px black;">${currentLng.toFixed(getDecimals(interval))}°E</span>`,
                    iconSize: [40, 20],
                    iconAnchor: [20, -5]
                });
                // Place label slightly inside the top view
                L.marker([north, currentLng], { icon: labelIcon, interactive: false }).addTo(graticuleLayer);
            }

            // Draw Latitude Lines (Horizontal)
            const startLat = Math.ceil(south / interval) * interval;
            const endLat = Math.floor(north / interval) * interval;

            for (let lat = startLat; lat <= endLat; lat += interval) {
                const currentLat = Math.round(lat * 1000) / 1000;
                
                L.polyline([[currentLat, west], [currentLat, east]], lineStyle).addTo(graticuleLayer);
                
                // Label (at left)
                const labelIcon = L.divIcon({
                    className: 'graticule-label',
                    html: `<span style="color: rgba(255,255,255,0.5); font-size: 10px; text-shadow: 1px 1px 2px black;">${currentLat.toFixed(getDecimals(interval))}°N</span>`,
                    iconSize: [40, 20],
                    iconAnchor: [-5, 10]
                });
                // Place label slightly inside the left view
                L.marker([currentLat, west], { icon: labelIcon, interactive: false }).addTo(graticuleLayer);
            }
        }

        function getDecimals(interval) {
            if (interval >= 1) return 0;
            if (interval >= 0.1) return 1;
            if (interval >= 0.01) return 2;
            return 3;
        }

        map.on('moveend', updateGraticule);
        updateGraticule(); // Initial draw

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const oldIcon = document.querySelector('svg.icon[t="1768576382981"]');
            if (oldIcon) {
                const newSvg = '<svg t="1769875941237" class="icon" viewBox="0 0 1028 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2512" width="22" height="22" style="vertical-align: middle; fill: white;">'
                    + '<path d="M0 0v1024h193.763556L659.418074 363.216593l193.915259 237.264592V0H0z m341.333333 379.297185H75.851852V303.407407h265.481481v75.889778zM455.111111 227.555556H75.851852V151.703704h379.259259v75.851852z" fill="currentColor" p-id="2513"></path>'
                    + '<path d="M666.130963 510.255407L304.090074 1024h724.043852l-362.002963-513.744593z m37.925926 437.892741h-75.851852v-75.851852h75.851852v75.851852z m-75.851852-134.485333v-151.703704h75.851852v151.703704h-75.851852z" fill="currentColor" p-id="2514"></path>'
                    + '</svg>';
                oldIcon.outerHTML = newSvg;
            }
        });
    </script>
    <script>
        window._uavWaypoints = [];
        window._waypointMarkers = [];
        window._fpEditingEnabled = false;
        function startFlightPathEditing(uavId) {
            function addMarker(lat, lng) {
                const m = L.marker([lat, lng], {
                    draggable: true,
                    icon: L.divIcon({ className: 'wp-marker', html: '<div style="width:10px;height:10px;border-radius:50%;background:#f59e0b;border:2px solid white;"></div>', iconSize: [14,14], iconAnchor: [7,7] })
                }).addTo(waypointLayerGroup);
                m.on('drag', () => {
                    const pos = m.getLatLng();
                    const idx = window._waypointMarkers.indexOf(m);
                    if (idx >= 0) window._uavWaypoints[idx] = [pos.lat, pos.lng];
                    updateFlightPath(uavId);
                });
                m.on('contextmenu', () => {
                    const idx = window._waypointMarkers.indexOf(m);
                    if (idx >= 0) {
                        waypointLayerGroup.removeLayer(m);
                        window._waypointMarkers.splice(idx,1);
                        window._uavWaypoints.splice(idx,1);
                        updateFlightPath(uavId);
                    }
                });
                window._waypointMarkers.push(m);
            }
            function onAddWaypoint(e) {
                if (!window._fpEditingEnabled || isPickingMode) return;
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                window._uavWaypoints.push([lat, lng]);
                addMarker(lat, lng);
                updateFlightPath(uavId);
            }
            if (window._fpAddHandler) map.off('click', window._fpAddHandler);
            window._fpAddHandler = onAddWaypoint;
            map.on('click', onAddWaypoint);
        }
        function stopFlightPathEditing() {
            if (window._fpAddHandler) { map.off('click', window._fpAddHandler); window._fpAddHandler = null; }
            window._fpEditingEnabled = false;
        }
        function toggleFlightPathEditing() {
            const uavId = document.getElementById('selected-uav-id').value || window._lastSelectedUav || 'uav-01';
            const btn = document.getElementById('edit-path-btn');
            if (!window._fpEditingEnabled) {
                window._fpEditingEnabled = true;
                startFlightPathEditing(uavId);
                if (btn) { btn.textContent = '结束编辑'; btn.style.background = '#f59e0b'; btn.style.color = '#111827'; }
            } else {
                stopFlightPathEditing();
                if (btn) { btn.textContent = '添加编辑点'; btn.style.background = '#3b82f6'; btn.style.color = 'white'; }
            }
        }
    </script>
    <script>
        const MONITOR_DB_KEY = 'monitor_db';
        const MONITOR_DB_VERSION = 4;
        function initMonitorDB() {
            try {
                const raw = localStorage.getItem(MONITOR_DB_KEY);
                if (raw) {
                    let db = JSON.parse(raw);
                    if (!db.version || db.version < MONITOR_DB_VERSION) {
                        db = migrateMonitorDB(db);
                        db.version = MONITOR_DB_VERSION;
                        saveMonitorDB(db);
                    }
                    return db;
                }
            } catch (e) {}
            const seed = {
                version: MONITOR_DB_VERSION,
                locations: [
                    { id: 'loc-changhua', name: '520 复兴路 Lukang 彰化县', lat: 24.0589, lng: 120.4333, altitude: 5.68, cameras: [
                        { id: 'CAM-01', name: '路口北向', image: '实时监控.png' },
                        { id: 'CAM-02', name: '路口南向', image: '实时监控南.png' }
                    ]},
                    { id: 'loc-taichung-port', name: '15 Yucai Xihu 彰化县', lat: 23.965833, lng: 120.482778, altitude: 17.31, cameras: [
                        { id: 'CAM-03', name: '路口北向', image: '实时监控2.png' },
                        { id: 'CAM-04', name: '路口南向', image: '实时监控2南.png' }
                    ]},
                    { id: 'loc-okinawa-sawada', name: 'Sawada Irabu Okinawa 日本冲绳县', lat: 24.839722, lng: 125.139444, altitude: 6.56, cameras: [
                        { id: 'CAM-05', name: '现场监控', image: '实时监控3.png' }
                    ]}
                ]
            };
            localStorage.setItem(MONITOR_DB_KEY, JSON.stringify(seed));
            return seed;
        }
        function saveMonitorDB(db) {
            try {
                localStorage.setItem(MONITOR_DB_KEY, JSON.stringify(db));
            } catch (e) {}
        }
        function migrateMonitorDB(db) {
            if (!db || typeof db !== 'object') db = {};
            if (!Array.isArray(db.locations)) db.locations = [];
            const locTaichung = db.locations.find(l => l.id === 'loc-taichung-port');
            if (locTaichung) {
                locTaichung.name = '15 Yucai Xihu 彰化县';
                locTaichung.lat = 23.965833;
                locTaichung.lng = 120.482778;
                locTaichung.altitude = 17.31;
                locTaichung.cameras = [
                    { id: 'CAM-03', name: '路口北向', image: '实时监控2.png' },
                    { id: 'CAM-04', name: '路口南向', image: '实时监控2南.png' }
                ];
            }
            const locChanghua = db.locations.find(l => l.id === 'loc-changhua');
            if (locChanghua) {
                locChanghua.cameras = [
                    { id: 'CAM-01', name: '路口北向', image: '实时监控.png' },
                    { id: 'CAM-02', name: '路口南向', image: '实时监控南.png' }
                ];
            }
            const locOkinawa = db.locations.find(l => l.id === 'loc-okinawa-sawada');
            if (!locOkinawa) {
                db.locations.push({
                    id: 'loc-okinawa-sawada',
                    name: 'Sawada Irabu Okinawa 日本冲绳县',
                    lat: 24.839722,
                    lng: 125.139444,
                    altitude: 6.56,
                    cameras: [
                        { id: 'CAM-05', name: '现场监控', image: '实时监控3.png' }
                    ]
                });
            }
            return db;
        }
        function renderMonitorSelectors() {
            const db = initMonitorDB();
            const locSel = document.getElementById('monitor-location-select');
            const camSel = document.getElementById('monitor-camera-select');
            if (!locSel || !camSel) return;
            locSel.innerHTML = db.locations.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
            const first = db.locations[0];
            camSel.innerHTML = first.cameras.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            locSel.onchange = () => {
                const sel = db.locations.find(l => l.id === locSel.value);
                if (!sel) return;
                camSel.innerHTML = sel.cameras.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                camSel.value = sel.cameras[0]?.id || '';
                updateMonitorUI();
            };
            camSel.onchange = updateMonitorUI;
            renderMonitorMarkers();
            updateMonitorUI();
        }
        function renderMonitorMarkers() {
            const db = initMonitorDB();
            if (typeof monitorLocationsLayerGroup === 'undefined') return;
            monitorLocationsLayerGroup.clearLayers();
            const locSel = document.getElementById('monitor-location-select');
            db.locations.forEach(loc => {
                const m = L.marker([loc.lat, loc.lng], { icon: blueMarkerIcon }).addTo(monitorLocationsLayerGroup);
                m.bindTooltip(loc.name, {direction: 'top', offset: [0, -10], className: 'custom-ship-tooltip'});
                m.on('click', () => {
                    if (locSel) {
                        locSel.value = loc.id;
                        const change = locSel.onchange;
                        if (typeof change === 'function') change();
                    }
                });
            });
        }
        function formatCoords(lat, lng, alt) {
            const latDeg = Math.abs(lat);
            const lngDeg = Math.abs(lng);
            const latStr = latDeg.toFixed(5) + '°' + (lat >= 0 ? 'N' : 'S');
            const lngStr = lngDeg.toFixed(5) + '°' + (lng >= 0 ? 'E' : 'W');
            return `${latStr}  ${lngStr}  地面海拔 ${alt.toFixed(2)}米`;
        }
        function updateMonitorUI() {
            const db = initMonitorDB();
            const locSel = document.getElementById('monitor-location-select');
            const camSel = document.getElementById('monitor-camera-select');
            const nameEl = document.getElementById('monitor-location-name');
            const coordsEl = document.getElementById('monitor-location-coords');
            const imgEl = document.getElementById('liveFeedImage');
            if (!locSel || !camSel || !nameEl || !coordsEl || !imgEl) return;
            const loc = db.locations.find(l => l.id === locSel.value) || db.locations[0];
            const cam = loc.cameras.find(c => c.id === camSel.value) || loc.cameras[0];
            nameEl.textContent = loc.name;
            coordsEl.textContent = formatCoords(loc.lat, loc.lng, loc.altitude);
            imgEl.src = 'images/' + cam.image;
            imgEl.alt = cam.name;
            imgEl.onerror = () => { imgEl.onerror = null; imgEl.src = 'images/实时监控.png'; };
            if (typeof monitorLayerGroup !== 'undefined') {
                monitorLayerGroup.clearLayers();
                const m = L.marker([loc.lat, loc.lng], { icon: blueMarkerIcon }).addTo(monitorLayerGroup);
                m.bindTooltip(loc.name, {direction: 'top', offset: [0, -10], className: 'custom-ship-tooltip'});
                map.flyTo([loc.lat, loc.lng], 15, { animate: true, duration: 1.2 });
            }
        }
        document.addEventListener('DOMContentLoaded', renderMonitorSelectors);
    </script>
